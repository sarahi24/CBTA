<!DOCTYPE html><html lang="es" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Gestión de Estudiantes | CBTA 71</title><link rel="icon" href="/Logo.png" type="image/png"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/Dashboard.BJo2pYvK.css">
<style>.bg-institucional[data-astro-cid-bw2fljil]{background-color:#2e594d}.text-institucional[data-astro-cid-bw2fljil]{color:#2e594d}.border-institucional[data-astro-cid-bw2fljil]{border-color:#2e594d}.hover-institucional[data-astro-cid-bw2fljil]:hover{background-color:#234238}
body{font-family:Inter,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:var(--BACKGROUND_COLOR);color:var(--TEXT_COLOR_DARK)}.sidebar-closed[data-astro-cid-sckkx6r4]{transform:translate(-100%)}.transition-transform-fast[data-astro-cid-sckkx6r4]{transition:transform .3s cubic-bezier(.25,.46,.45,.94)}#sidebar-menu[data-astro-cid-sckkx6r4]{scrollbar-width:none}#sidebar-menu[data-astro-cid-sckkx6r4]::-webkit-scrollbar{width:0;height:0}.content-fade-in[data-astro-cid-sckkx6r4]{animation:fadeIn .8s cubic-bezier(.19,1,.22,1)}@keyframes fadeIn{0%{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}.nav-active[data-astro-cid-sckkx6r4]{background-color:#fff;color:var(--PRIMARY_COLOR);font-weight:700;box-shadow:0 4px 12px #00000026;border-left:5px solid var(--ACCENT_COLOR);padding-left:1rem}.nav-inactive[data-astro-cid-sckkx6r4]:hover{background-color:#fff3;color:#fff}
</style><script type="module" src="/_astro/page.CZQmTZnr.js"></script></head> <body class="flex min-h-screen antialiased" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <nav id="sidebar-menu" class="bg-[#2e594d] text-white flex-col p-5 shadow-2xl z-50 overflow-y-auto
		fixed inset-0 w-full max-w-[250px] h-full transition-transform-fast sidebar-closed
		md:fixed md:top-0 md:flex md:h-screen md:w-[250px] md:shadow-lg md:rounded-r-xl" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;">  <button id="close-sidebar-button" class="md:hidden absolute top-3 right-3 p-2 rounded-full bg-white/20 hover:bg-white/40 z-50 transition text-white" aria-label="Cerrar menú lateral" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M18 6l-12 12" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M6 6l12 12" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg> </button>  <div class="flex items-center gap-4 mb-10 pt-3 border-b border-white/10 pb-4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <div class="h-10 w-10" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <img src="/Logo.png" alt="Logo CBTA 71" class="w-full h-full object-contain" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> </div> <div data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <h1 class="text-xl font-extrabold tracking-wide" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;">CBTA 71</h1> <p class="text-xs opacity-80" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;">Sistema Administrativo</p> </div> </div>  <div class="flex-grow overflow-y-auto pr-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <ul id="main-navigation" class="space-y-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;">  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/Dashboard" data-path="/Dashboard" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M3 3v18h18" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M18 17v-4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M12 17v-8" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M6 17v-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Dashboard
</a> </li>  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/concepts" data-path="/concepts" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M13.5 6.5l4 4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M19 16v3h-3" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Conceptos
</a> </li>  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/students" data-path="/students" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M16 3.125a4 4 0 1 1 0 7.75" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Estudiantes
</a> </li>  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/payments" data-path="/payments" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M9 14h-2a2 2 0 0 1 -2 -2v-6a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M12 17v-1h-3a1 1 0 0 0 -1 1v2a1 1 0 0 0 1 1h3v1" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Pagos
</a> </li>  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/debts" data-path="/debts" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M14 3v4a1 1 0 0 0 1 1h4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M10 12l4 4m0 -4l-4 4" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Adeudos
</a> </li>  <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/roles" data-path="/roles" class="nav-link nav-inactive flex items-center gap-4 py-3 px-4 rounded-lg transition-all duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M12 10a2 2 0 0 1 2 2a2 2 0 0 1 2 2a2 2 0 0 1 -2 2h-4a2 2 0 0 1 -2 -2a2 2 0 0 1 2 -2a2 2 0 0 1 2 -2z" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Roles y Usuarios
</a> </li> </ul> </div>  <div class="mt-auto pt-4 border-t border-white/10" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <ul class="space-y-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <li data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <a href="/logout" class="flex items-center gap-4 py-3 px-4 rounded-lg text-white hover:bg-white/10 transition-colors duration-200" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M7 12h14l-3 -3m0 6l3 -3" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg>
Salir
</a> </li> </ul> </div> </nav>  <main class="flex-1 p-4 md:p-8 overflow-y-auto md:ml-[250px] relative" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;">  <button id="open-sidebar-button" class="md:hidden fixed top-4 left-4 p-3 rounded-xl bg-[${PRIMARY_COLOR}] text-white shadow-xl z-40 transition hover:bg-[#256d5e]" aria-label="Abrir menú lateral" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"><path stroke="none" d="M0 0h24v24H0z" fill="none" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M4 6l16 0" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M4 12l16 0" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path><path d="M4 18l16 0" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></path></svg> </button> <div class="h-16 md:hidden" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"></div>  <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl content-fade-in min-h-[calc(100vh-4rem)]" data-astro-cid-sckkx6r4 style="--PRIMARY_COLOR: #2e594d;--ACCENT_COLOR: #86efad;--BACKGROUND_COLOR: #d9dde2;--TEXT_COLOR_DARK: #374151;"> <script src="/js/xlsx.min.js" type="text/javascript" defer></script> <div class="max-w-7xl mx-auto px-4 py-8 bg-white min-h-screen font-sans" data-astro-cid-bw2fljil> <!-- Header --> <div class="mb-8" data-astro-cid-bw2fljil> <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <h1 class="text-3xl font-bold text-slate-800 mb-1 flex items-center gap-2" data-astro-cid-bw2fljil> <svg class="w-8 h-8 text-institucional" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" data-astro-cid-bw2fljil></path> </svg>
Lista de Estudiantes
</h1> <p class="text-slate-500" data-astro-cid-bw2fljil>Consulta y gestiona el registro de estudiantes</p> </div> <div class="flex flex-wrap gap-3" data-astro-cid-bw2fljil> <button id="import-excel-btn" class="px-5 py-2.5 bg-white border-2 border-institucional text-institucional font-semibold rounded-lg hover:bg-slate-50 transition-all flex items-center gap-2" data-astro-cid-bw2fljil> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" data-astro-cid-bw2fljil></path> </svg>
Importar Excel
</button> <a href="/Dashboard" class="px-5 py-2.5 bg-slate-100 text-slate-700 font-semibold rounded-lg hover:bg-slate-200 transition-all flex items-center gap-2" data-astro-cid-bw2fljil> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" data-astro-cid-bw2fljil></path> </svg>
Volver
</a> </div> </div> </div> <!-- Stats Cards --> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" data-astro-cid-bw2fljil> <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200" data-astro-cid-bw2fljil> <div class="flex items-center justify-between" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <p class="text-sm text-slate-500 font-medium" data-astro-cid-bw2fljil>Total Estudiantes</p> <p id="stat-total" class="text-2xl font-bold text-slate-800 mt-1" data-astro-cid-bw2fljil>0</p> </div> <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center" data-astro-cid-bw2fljil> <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" data-astro-cid-bw2fljil></path> </svg> </div> </div> </div> <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200" data-astro-cid-bw2fljil> <div class="flex items-center justify-between" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <p class="text-sm text-slate-500 font-medium" data-astro-cid-bw2fljil>Filtrados</p> <p id="stat-filtered" class="text-2xl font-bold text-institucional mt-1" data-astro-cid-bw2fljil>0</p> </div> <div class="w-12 h-12 bg-institucional bg-opacity-10 rounded-lg flex items-center justify-center" data-astro-cid-bw2fljil> <svg class="w-6 h-6 text-institucional" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" data-astro-cid-bw2fljil></path> </svg> </div> </div> </div> <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200" data-astro-cid-bw2fljil> <div class="flex items-center justify-between" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <p class="text-sm text-slate-500 font-medium" data-astro-cid-bw2fljil>Carreras</p> <p id="stat-careers" class="text-2xl font-bold text-purple-600 mt-1" data-astro-cid-bw2fljil>0</p> </div> <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center" data-astro-cid-bw2fljil> <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" data-astro-cid-bw2fljil></path> </svg> </div> </div> </div> <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200" data-astro-cid-bw2fljil> <div class="flex items-center justify-between" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <p class="text-sm text-slate-500 font-medium" data-astro-cid-bw2fljil>Semestres</p> <p id="stat-semesters" class="text-2xl font-bold text-orange-600 mt-1" data-astro-cid-bw2fljil>0</p> </div> <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center" data-astro-cid-bw2fljil> <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" data-astro-cid-bw2fljil></path> </svg> </div> </div> </div> </div> <section class="space-y-6" data-astro-cid-bw2fljil>  <div id="table-container" class="bg-white p-6 rounded-xl shadow-lg col-span-1 lg:col-span-3 flex flex-col border border-gray-100 relative" data-astro-cid-bw2fljil> <div class="flex items-center justify-between mb-4 flex-wrap gap-3" data-astro-cid-bw2fljil> <h2 class="font-bold text-xl text-gray-800" data-astro-cid-bw2fljil>Listado de Matrícula <span id="students-total" class="text-sm font-semibold text-emerald-600" data-astro-cid-bw2fljil>(0)</span></h2> <div class="flex gap-2 relative flex-wrap" data-astro-cid-bw2fljil>  <div class="relative w-52" data-astro-cid-bw2fljil> <input id="search-input" type="text" placeholder="Buscar..." class="w-full p-2 pl-8 border border-gray-300 rounded-lg text-sm focus:ring-emerald-500 focus:border-emerald-500 shadow-sm transition" data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" data-astro-cid-bw2fljil></path> </svg> </div>  <button id="toggle-filters-btn" class="flex items-center px-3 py-2 rounded-lg bg-emerald-50 border border-emerald-300 text-emerald-700 text-sm font-medium hover:bg-emerald-100 transition focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50 shadow-sm" data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v3.414l-4 4v-4.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" data-astro-cid-bw2fljil></path> </svg> <span id="filters-status" data-astro-cid-bw2fljil>Filtros</span> </button> <div id="filters-popover" class="absolute z-20 top-full right-0 mt-2 w-64 bg-white rounded-xl shadow-xl p-4 border border-gray-200 hidden transform origin-top-right transition duration-200 ease-out scale-95 opacity-0" data-astro-cid-bw2fljil> <h3 class="text-sm font-bold text-gray-700 mb-3 border-b pb-2" data-astro-cid-bw2fljil>Opciones de Filtrado</h3> <div class="space-y-3" data-astro-cid-bw2fljil> <div data-astro-cid-bw2fljil> <label for="filter-carrera" class="block text-xs font-medium text-gray-500 mb-1" data-astro-cid-bw2fljil>Programa Educativo:</label> <select id="filter-carrera" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm" data-astro-cid-bw2fljil> <option value="" data-astro-cid-bw2fljil>Todos los Programas</option> <option value="TAG-E" data-astro-cid-bw2fljil>Técnico Agropecuario</option><option value="TOF" data-astro-cid-bw2fljil>Técnico en Ofimática</option><option value="TEM" data-astro-cid-bw2fljil>Técnico en Admón. de Emprendimiento</option><option value="TAG-M" data-astro-cid-bw2fljil>Técnico Agropecuario (modalidad mixta)</option><option value="TRH" data-astro-cid-bw2fljil>Técnico en Admón. de Recursos Humanos (modalidad mixta)</option> </select> </div> <div data-astro-cid-bw2fljil> <label for="filter-semestre" class="block text-xs font-medium text-gray-500 mb-1" data-astro-cid-bw2fljil>Nivel Semestral:</label> <select id="filter-semestre" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-gray-800 shadow-sm focus:ring-1 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm" data-astro-cid-bw2fljil> <option value="" data-astro-cid-bw2fljil>Todos los Semestres</option> <option value="1" data-astro-cid-bw2fljil>1ro</option><option value="2" data-astro-cid-bw2fljil>2ro</option><option value="3" data-astro-cid-bw2fljil>3ro</option><option value="4" data-astro-cid-bw2fljil>4ro</option><option value="5" data-astro-cid-bw2fljil>5ro</option><option value="6" data-astro-cid-bw2fljil>6ro</option><option value="7" data-astro-cid-bw2fljil>7ro</option><option value="8" data-astro-cid-bw2fljil>8ro</option><option value="9" data-astro-cid-bw2fljil>9ro</option><option value="10" data-astro-cid-bw2fljil>10ro</option> <option value="0" data-astro-cid-bw2fljil>N/A</option> </select> </div> </div> <button id="clear-filters-btn" class="w-full mt-4 px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg shadow-sm hover:bg-red-100 transition duration-150 flex items-center justify-center text-sm" data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-astro-cid-bw2fljil></path> </svg>
Limpiar Filtros
</button> </div>  <button id="export-xlsx" class="flex items-center px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-700 text-sm hover:bg-gray-100 transition shadow-sm" data-astro-cid-bw2fljil><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor" data-astro-cid-bw2fljil><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" data-astro-cid-bw2fljil></path></svg>XLSX</button>  <button id="delete-selected" class="hidden flex items-center px-3 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition shadow-sm" data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" data-astro-cid-bw2fljil></path> </svg>
Borrar (<span id="selected-count" data-astro-cid-bw2fljil>0</span>)
</button> <button id="clear-storage" class="px-3 py-2 rounded-lg bg-red-100 text-red-700 text-sm font-medium hover:bg-red-200 transition shadow-sm" data-astro-cid-bw2fljil>Borrar Local</button> </div> </div>  <div class="flex items-center justify-center mt-3 mb-3 pt-3 border-t border-gray-100" data-astro-cid-bw2fljil> <div id="pagination-controls" class="flex items-center space-x-1" data-astro-cid-bw2fljil> <button id="prev-page-btn" class="p-1.5 text-gray-500 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" data-astro-cid-bw2fljil></path> </svg> </button> <div id="page-buttons-container" class="flex space-x-1 items-center" data-astro-cid-bw2fljil></div> <button id="next-page-btn" class="p-1.5 text-gray-500 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled data-astro-cid-bw2fljil> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" data-astro-cid-bw2fljil></path> </svg> </button> </div> </div> <p id="pagination-status" class="text-xs text-gray-500 text-center mb-3" data-astro-cid-bw2fljil>Mostrando: 50 registros por página.</p>  <div class="overflow-x-auto rounded-lg border border-gray-200 max-h-[60vh] shadow-inner" data-astro-cid-bw2fljil> <table class="min-w-full text-sm divide-y divide-gray-200" data-astro-cid-bw2fljil>  <thead class="text-left sticky top-0 z-10" style="background-color:#2E594D; color: #FFFFFF;" data-astro-cid-bw2fljil> <tr data-astro-cid-bw2fljil> <th class="px-3 py-2 text-center w-[4%]" data-astro-cid-bw2fljil> <input type="checkbox" id="select-all" class="rounded text-white focus:ring-emerald-500" style="background-color:#264c41; border-color:white;" data-astro-cid-bw2fljil> </th> <th class="px-3 py-2 font-bold w-[12%]" data-astro-cid-bw2fljil>N. Control</th> <th class="px-3 py-2 font-bold w-[15%]" data-astro-cid-bw2fljil>Nombre</th> <th class="px-3 py-2 font-bold w-[15%]" data-astro-cid-bw2fljil>Apellido P.</th> <th class="px-3 py-2 font-bold w-[15%]" data-astro-cid-bw2fljil>Apellido M.</th> <th class="px-3 py-2 font-bold text-center w-[10%]" data-astro-cid-bw2fljil>Semestre</th> <th class="px-3 py-2 font-bold w-[12%]" data-astro-cid-bw2fljil>Carrera</th> <th class="px-3 py-2 font-bold w-[15%]" data-astro-cid-bw2fljil>Correo</th> <th class="px-3 py-2 font-bold text-center w-[8%] min-w-[100px]" data-astro-cid-bw2fljil>Acciones</th> </tr> </thead> <tbody id="students-tbody" class="bg-white divide-y divide-gray-100" data-astro-cid-bw2fljil></tbody> </table> </div> </div> </section> </div> <script>(function(){const initialJSON = "[]";
const CAREER_MAP = {"0":"Sin Carrera","":"Sin Carrera","TAG-E":"Técnico Agropecuario","TOF":"Técnico en Ofimática","TEM":"Técnico en Admón. de Emprendimiento","TAG-M":"Técnico Agropecuario (modalidad mixta)","TRH":"Técnico en Admón. de Recursos Humanos (modalidad mixta)"};
const ACCENT_COLOR_HEX = "#2E594D";
const ACCENT_HOVER_COLOR_HEX = "#264c41";

    window.__INITIAL_STUDENTS = JSON.parse(initialJSON);
    window.__CAREER_MAP = CAREER_MAP;
    window.__ACCENT_COLOR_HEX = ACCENT_COLOR_HEX;
    window.__ACCENT_HOVER_COLOR_HEX = ACCENT_HOVER_COLOR_HEX;
  })();</script> <script type="module" client:load>
    (function () { 
      const STORAGE_KEY = 'studentsList';
      const initial = Array.isArray(window.__INITIAL_STUDENTS) ? window.__INITIAL_STUDENTS : [];
      const CARRERA_MAP = window.__CAREER_MAP || {};
      const ACCENT_COLOR = window.__ACCENT_COLOR_HEX;
      const ACCENT_HOVER_COLOR = window.__ACCENT_HOVER_COLOR_HEX; 
      
      const SELECTED_ROW_BG = '#ebfcf5'; // Un verde claro que contraste con el oscuro.

      // --- ESTADO DE PAGINACIÓN ---
      const paginationState = {
          currentPage: 1,
          pageSize: 50, 
          totalPages: 1,
          filteredCount: 0,
      };
      // ----------------------------

      let selectedStudentIds = new Set();
      let forceOverwrite = false;

      const currentFilters = {
        semestre: '',
        carrera: ''
      };

      // CAMBIO 1: Crear el Mapa Inverso (Nombre Completo -> Código Corto)
      const REVERSE_CAREER_MAP = Object.entries(CARRERA_MAP).reduce((acc, [code, name]) => {
          // Normalizamos para búsqueda insensible a mayúsculas y acentos
          if (code !== '0' && code !== '') {
              acc[normalizeForSearch(name)] = code;
          }
          return acc;
      }, {});

      const readLocal = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return initial.slice();
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : initial.slice();
        } catch (e) {
          return initial.slice();
        }
      };
      const writeLocal = (arr) => {
        try {
          const cleanedArr = arr.map(s => {
            const { password, ...rest } = s;
            return rest;
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanedArr));
        } catch (e) {}
      };
      // Elementos del DOM
      const tbody = document.getElementById('students-tbody');
      const totalEl = document.getElementById('students-total');
      const exportXlsx = document.getElementById('export-xlsx');
      const clearBtn = document.getElementById('clear-storage');
      const tableContainer = document.getElementById('table-container');
      const searchInput = document.getElementById('search-input');
      const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
      const filtersPopover = document.getElementById('filters-popover');
      const filtersStatusEl = document.getElementById('filters-status');
      const filterSemestreEl = document.getElementById('filter-semestre');
      const filterCarreraEl = document.getElementById('filter-carrera');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');
      const selectAllCheckbox = document.getElementById('select-all');
      const deleteSelectedBtn = document.getElementById('delete-selected');
      const selectedCountEl = document.getElementById('selected-count');
      const prevPageBtn = document.getElementById('prev-page-btn');
      const nextPageBtn = document.getElementById('next-page-btn');
      const paginationStatusEl = document.getElementById('pagination-status');
      const paginationControls = document.getElementById('pagination-controls');
      const pageButtonsContainer = document.getElementById('page-buttons-container');
      
      // Modal de importación
      const importExcelBtn = document.getElementById('import-excel-btn');
      const importModal = document.getElementById('import-modal');
      const closeImportModal = document.getElementById('close-import-modal');
      const cancelImport = document.getElementById('cancel-import');
      const dropzone = document.getElementById('dropzone');
      const importFileInput = document.getElementById('import-file');
      const fileInfo = document.getElementById('file-info');
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');
      const removeFile = document.getElementById('remove-file');
      const importSummary = document.getElementById('import-summary');
      const studentsCount = document.getElementById('students-count');
      const processImport = document.getElementById('process-import');
      const downloadTemplate = document.getElementById('download-template');
      
      let selectedFile = null;
      let importedData = [];
      
      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function (m) {
          return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
        });
      }

      function showMsg(text, isError) {
        msg.textContent = text;
        msg.classList.remove('text-red-600', 'text-green-600');
        msg.classList.toggle('text-red-600', !!isError);
        msg.classList.toggle('text-green-600', !isError);
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 3000);
      }

      // FUNCIÓN: Normaliza para búsqueda insensible a mayúsculas y acentos
      function normalizeForSearch(str) {
          if (!str) return '';
          // toLowerCase: Convierte a minúsculas y normalize("NFD").replace: elimina acentos/diacríticos
          return String(str).toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      // FUNCIÓN CORREGIDA: Capitaliza correctamente respetando acentos
      function capitalizeName(str) {
        if (!str) return '';
        // 1. Elimina espacios extra y convierte todo a minúsculas
        const lowerCaseStr = String(str).toLowerCase().trim().replace(/\s+/g, ' ');
        
        // 2. Capitaliza la primera letra de cada palabra
        return lowerCaseStr.replace(/(^|\s)\S/g, function(l) {
            return l.toUpperCase();
        });
      }


      const applyFilters = (list) => {
        const normalizedSearchTerm = normalizeForSearch(searchInput.value); // Normaliza el término de búsqueda
        
        return list.filter(s => {
          const matchesSemestre = currentFilters.semestre === '' || String(s.semestre) === currentFilters.semestre;
          const matchesCarrera = currentFilters.carrera === '' || s.carrera === currentFilters.carrera;

          if (normalizedSearchTerm === '') return matchesSemestre && matchesCarrera;

          // Aplica la normalización a los campos del estudiante antes de comparar
          const matchesSearch = 
              normalizeForSearch(s.numControl).includes(normalizedSearchTerm) ||
              normalizeForSearch(s.nombre).includes(normalizedSearchTerm) ||
              normalizeForSearch(s.apellidoP).includes(normalizedSearchTerm) ||
              normalizeForSearch(s.apellidoM).includes(normalizedSearchTerm) ||
              normalizeForSearch(CARRERA_MAP[s.carrera] || s.carrera).includes(normalizedSearchTerm) ||
              normalizeForSearch(s.correo).includes(normalizedSearchTerm);

          return matchesSemestre && matchesCarrera && matchesSearch;
        });
      }

      const getExportList = () => {
          const rawList = readLocal();
          return applyFilters(rawList);
      }

      // Se ajusta el botón de filtros para reflejar el color principal
      const updateFiltersStatus = (filteredCount, totalCount) => {
          const isActive = currentFilters.semestre !== '' ||
          currentFilters.carrera !== '';

          if (isActive || searchInput.value.trim() !== '') {
              // Botón activo (USANDO el color principal)
              toggleFiltersBtn.style.backgroundColor = ACCENT_COLOR;
              toggleFiltersBtn.style.borderColor = ACCENT_COLOR;
              toggleFiltersBtn.classList.add('text-white');
              toggleFiltersBtn.classList.remove('bg-emerald-50', 'text-emerald-700', 'border-emerald-300');
              filtersStatusEl.textContent = `Filtros: ${filteredCount}/${totalCount}`;
          } else {
              // Botón inactivo (Volver al verde claro)
              toggleFiltersBtn.style.backgroundColor = '';
              toggleFiltersBtn.style.borderColor = '';
              toggleFiltersBtn.classList.remove('text-white');
              toggleFiltersBtn.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-300');
              filtersStatusEl.textContent = 'Filtros';
          }
      }


      function setFormVisibility(isVisible) {
        if (isVisible) {
          filtersPopover.classList.add('hidden');
          formContainer.classList.remove('hidden');
          tableContainer.classList.remove('lg:col-span-3');
          tableContainer.classList.add('lg:col-span-2');
          showFormBtn.classList.add('hidden');
          if (window.innerWidth >= 1024) {
              formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } else {
          formContainer.classList.add('hidden');
          tableContainer.classList.remove('lg:col-span-2');
          tableContainer.classList.add('lg:col-span-3');
          showFormBtn.classList.remove('hidden');
          resetForm();
        }
      }

      function resetForm() {
        form.reset();
        idInput.value = '';
        formTitle.textContent = 'Registro de Estudiante';
        submitBtn.textContent = 'Registrar';
        msg.classList.add('hidden');
        msg.classList.remove('text-red-600', 'text-green-600');
        forceOverwrite = false;
      }

      function handleEdit(e) {
        e.preventDefault();
        const studentId = e.currentTarget.getAttribute('data-id');
        const list = readLocal();
        const student = list.find(s => s.id === studentId);
        if (!student) {
          showMsg('Estudiante no encontrado para editar.', true);
          return;
        }

        setFormVisibility(true);

        idInput.value = student.id;
        numControlInput.value = student.numControl;
        nombreInput.value = student.nombre;
        apellidoPInput.value = student.apellidoP;
        apellidoMInput.value = student.apellidoM;
        semestreInput.value = String(student.semestre || '0');
        carreraInput.value = student.carrera;
        correoInput.value = student.correo;
        formTitle.textContent = `Editar Estudiante: ${student.nombre}`;
        submitBtn.textContent = 'Actualizar Datos';
      }

      
      function renderPageButtons() {
          pageButtonsContainer.innerHTML = '';
          const { currentPage, totalPages } = paginationState;
          
          if (totalPages <= 1) return;

          const maxVisible = 7;
          let startPage = Math.max(1, currentPage - 2); 
          let endPage = Math.min(totalPages, currentPage + 2);

          if (endPage - startPage + 1 < maxVisible) {
              startPage = Math.max(1, endPage - maxVisible + 1);
          }
          if (endPage - startPage + 1 < maxVisible) {
              endPage = Math.min(totalPages, startPage + maxVisible - 1);
          }

          if (startPage > 1) {
              createPageButton(1);
              if (startPage > 2) {
                  createEllipsis();
              }
          }
          
          for (let i = startPage; i <= endPage; i++) {
              createPageButton(i);
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  createEllipsis();
              }
              createPageButton(totalPages);
          }
      }

      function createPageButton(pageNumber) {
          const btn = document.createElement('button');
          btn.textContent = pageNumber;
          btn.className = `w-7 h-7 rounded-lg text-xs font-semibold transition duration-150`;
          btn.setAttribute('data-page', pageNumber);

          if (pageNumber === paginationState.currentPage) {
              // Aplicar el color principal al botón activo de paginación
              btn.style.backgroundColor = ACCENT_COLOR;
              btn.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)';
              // shadow-md
              btn.classList.add('text-white');
              btn.classList.remove('text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
          } else {
              btn.classList.add('text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
              btn.addEventListener('click', () => {
                  paginationState.currentPage = pageNumber;
                  render();
                  document.getElementById('table-container').querySelector('.overflow-x-auto').scrollTop = 0;
              });
          }
          pageButtonsContainer.appendChild(btn);
      }

      function createEllipsis() {
          const span = document.createElement('span');
          span.textContent = '...';
          span.className = 'px-1 text-gray-400 font-semibold text-sm pt-0.5';
          pageButtonsContainer.appendChild(span);
      }

      const render = () => {
        const rawList = readLocal();
        const filteredList = applyFilters(rawList);

        paginationState.filteredCount = filteredList.length;
        paginationState.totalPages = Math.ceil(filteredList.length / paginationState.pageSize);
        if (paginationState.currentPage > paginationState.totalPages) {
            paginationState.currentPage = Math.max(1, paginationState.totalPages);
        }

        const start = (paginationState.currentPage - 1) * paginationState.pageSize;
        const end = Math.min(start + paginationState.pageSize, filteredList.length);
        const paginatedList = filteredList.slice(start, end);

        tbody.innerHTML = '';
        if (paginatedList.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center py-6 text-gray-500">No se encontraron estudiantes que coincidan con los filtros.</td></tr>`;
        }
        
        paginatedList.forEach(s => {
          const tr = document.createElement('tr');
          // Aplicar el color de fondo personalizado para las filas seleccionadas
          const isSelected = selectedStudentIds.has(s.id);
          tr.className = `hover:bg-emerald-50 ${isSelected ? 'bg-emerald-50' : ''}`;
          if(isSelected) {
              // Sobrescribir con un color más suave si está seleccionado (usando el color verde base de Tailwind para un contraste suave)
              tr.style.backgroundColor = SELECTED_ROW_BG;
          }
          tr.innerHTML = `
              <td class="px-3 py-2 text-center">
                  <input type="checkbox" class="student-checkbox rounded focus:ring-emerald-500" data-id="${s.id}" ${isSelected ? 'checked' : ''} style="color:${ACCENT_COLOR}; border-color:${ACCENT_COLOR};" />
              </td>
              <td class="px-3 py-2 font-medium text-gray-900">${escapeHtml(s.numControl)}</td>
              <td class="px-3 py-2">${escapeHtml(s.nombre)}</td>
              <td class="px-3 py-2">${escapeHtml(s.apellidoP)}</td>
              <td class="px-3 py-2">${escapeHtml(s.apellidoM)}</td>
              <td class="px-3 py-2 text-center font-semibold">${s.semestre === 0 ? '-' : s.semestre}</td>
              <td class="px-3 py-2 text-emerald-700 font-medium">${CARRERA_MAP[s.carrera] || s.carrera}</td>
              <td class="px-3 py-2 text-xs text-gray-600">${escapeHtml(s.correo)}</td>
              <td class="px-3 py-2 flex justify-center space-x-1 min-w-[100px]">
                  <button data-id="${s.id}" class="edit-btn text-emerald-600 hover:text-emerald-800 p-1 rounded-full hover:bg-emerald-50 transition" title="Editar Registro">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l4-4m-4 4l5.5-5.5a1 1 0 000-1.414l-2.5-2.5a1 1 0 00-1.414 0L10 13z" />
                      </svg>
                  </button>
                  </td>
          `;
          tbody.appendChild(tr);
        });

        totalEl.textContent = `(${rawList.length}) / Filtrados: ${filteredList.length}`;
        updateFiltersStatus(filteredList.length, rawList.length);

        // Actualizar el estado de selección global
        const allFilteredSelected = filteredList.length > 0 && filteredList.every(s => selectedStudentIds.has(s.id));
        selectAllCheckbox.checked = allFilteredSelected;
        selectAllCheckbox.indeterminate = !allFilteredSelected && Array.from(selectedStudentIds).some(id => filteredList.some(s => s.id === id));


        if (selectedStudentIds.size > 0) {
            deleteSelectedBtn.classList.remove('hidden');
            selectedCountEl.textContent = selectedStudentIds.size;
        } else {
            deleteSelectedBtn.classList.add('hidden');
        }

        // Paginación
        if (paginationState.totalPages <= 1) {
            paginationControls.classList.add('hidden');
            paginationStatusEl.classList.add('hidden');
        } else {
            paginationControls.classList.remove('hidden');
            paginationStatusEl.classList.remove('hidden');
            renderPageButtons();
            prevPageBtn.disabled = paginationState.currentPage === 1;
            nextPageBtn.disabled = paginationState.currentPage === paginationState.totalPages;
            const displayStart = start + 1;
            const displayEnd = Math.min(end, filteredList.length);
            paginationStatusEl.textContent = `Página ${paginationState.currentPage} de ${paginationState.totalPages} (Registros: ${displayStart}-${displayEnd})`;
        }

        // Manejadores de eventos para la página actual
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        // El evento .delete-btn fue removido aquí, junto con la función handleDelete.

        document.querySelectorAll('.student-checkbox').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const id = e.target.getAttribute('data-id');
                if (e.target.checked) {
                    selectedStudentIds.add(id);
                } else {
                    selectedStudentIds.delete(id);
                }
                render();
            });
        });
      };
      
      // La función handleDelete fue removida.

      function handleMassDelete() {
          if (selectedStudentIds.size === 0) return;

          if (confirm(`⚠️ Advertencia: ¿Está seguro de que desea eliminar los ${selectedStudentIds.size} registros seleccionados? Esta acción es irreversible.`)) {
              let list = readLocal();
              const initialSize = list.length;
              const newList = list.filter(s => !selectedStudentIds.has(s.id));
              const deletedCount = initialSize - newList.length;

              writeLocal(newList);
              selectedStudentIds.clear(); // Limpiar la selección después del borrado
              showMsg(`Se eliminaron ${deletedCount} registros con éxito. 🗑️`, false);
              paginationState.currentPage = 1; // Volver a la primera página después de un borrado masivo
              render();
          }
      }

      function handleSelectAll(e) {
          const list = readLocal();
          const filteredList = applyFilters(list);
          const isChecked = e.target.checked;
          
          if (isChecked) {
              filteredList.forEach(s => selectedStudentIds.add(s.id));
          } else {
              filteredList.forEach(s => selectedStudentIds.delete(s.id));
          }
          render();
      }

      // --- MANEJADORES DE EVENTOS ---

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(form);
        const isEdit = !!data.get('id');

        const newS = {
          id: data.get('id') || Date.now().toString() + Math.random().toString(36).slice(2, 7),
          numControl: data.get('numControl').toUpperCase().trim(),
          nombre: capitalizeName(data.get('nombre')),
          apellidoP: capitalizeName(data.get('apellidoP')),
          apellidoM: capitalizeName(data.get('apellidoM')),
          semestre: parseInt(data.get('semestre') || '0', 10),
          carrera: data.get('carrera').toUpperCase().trim(),
          correo: data.get('correo').toLowerCase().trim(),
        };

        let list = readLocal();
        const duplicateIndex = list.findIndex(s => s.numControl === newS.numControl && s.id !== newS.id);
        
        if (duplicateIndex !== -1) {
            const duplicateStudent = list[duplicateIndex];
            if (!confirm(`⚠️ ALUMNO DUPLICADO DETECTADO: El N. Control ${newS.numControl} ya pertenece a ${duplicateStudent.nombre} ${duplicateStudent.apellidoP}. \n\n¿Desea sobreescribir (actualizar) los datos del registro existente con los datos que acaba de ingresar?`)) {
                showMsg(`Operación cancelada. El registro para ${newS.numControl} no fue creado ni modificado.`, true);
                return;
            }
            newS.id = duplicateStudent.id;
            list[duplicateIndex] = newS;
            showMsg('Duplicado actualizado con éxito. ✔️');
        } else if (isEdit) {
            const index = list.findIndex(s => s.id === newS.id);
            if (index !== -1) {
                list[index] = newS;
                showMsg('Estudiante editado y actualizado. ✔️');
            }
        } else {
            list.unshift(newS);
            window.dispatchEvent(new CustomEvent('students:added', { detail: newS }));
            showMsg('Estudiante registrado con éxito. ✨');
        }

        writeLocal(list);
        paginationState.currentPage = 1;
        render();
        setFormVisibility(false);
      });

      showFormBtn.addEventListener('click', () => setFormVisibility(true));
      closeFormBtn.addEventListener('click', () => setFormVisibility(false));
      resetBtn.addEventListener('click', resetForm);

      toggleFiltersBtn.addEventListener('click', (e) => { 
          e.stopPropagation();
          const isHidden = filtersPopover.classList.contains('hidden');
          if (isHidden) {
              filtersPopover.classList.remove('hidden');
              setTimeout(() => {
                  filtersPopover.classList.add('scale-100', 'opacity-100');
                  filtersPopover.classList.remove('scale-95', 'opacity-0');
              }, 10);
          } else {
              filtersPopover.classList.remove('scale-100', 'opacity-100');
              filtersPopover.classList.add('scale-95', 'opacity-0');
              filtersPopover.addEventListener('transitionend', function handler() {
                  filtersPopover.classList.add('hidden');
                  filtersPopover.removeEventListener('transitionend', handler);
              }, { once: true });
          }
      });

      document.addEventListener('click', (e) => { 
          if (!filtersPopover.contains(e.target) && !toggleFiltersBtn.contains(e.target)) {
              filtersPopover.classList.remove('scale-100', 'opacity-100');
              filtersPopover.classList.add('scale-95', 'opacity-0');
              setTimeout(() => {
                  filtersPopover.classList.add('hidden');
              }, 200);
          }
      });

      const updateFilters = () => {
          currentFilters.semestre = filterSemestreEl.value;
          currentFilters.carrera = filterCarreraEl.value;
          paginationState.currentPage = 1;
          render();
      }

      filterSemestreEl.addEventListener('change', updateFilters);
      filterCarreraEl.addEventListener('change', updateFilters);

      clearFiltersBtn.addEventListener('click', (e) => {
          e.preventDefault();
          filterSemestreEl.value = '';
          filterCarreraEl.value = '';
          updateFilters();
          filtersPopover.classList.remove('scale-100', 'opacity-100');
          filtersPopover.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
              filtersPopover.classList.add('hidden');
          }, 200);
      });

      searchInput.addEventListener('input', () => {
          paginationState.currentPage = 1;
          render();
      });

      prevPageBtn.addEventListener('click', () => {
          if (paginationState.currentPage > 1) {
              paginationState.currentPage--;
              render();
              document.getElementById('table-container').querySelector('.overflow-x-auto').scrollTop = 0;
          }
      });
      nextPageBtn.addEventListener('click', () => {
          if (paginationState.currentPage < paginationState.totalPages) {
              paginationState.currentPage++;
              render();
              document.getElementById('table-container').querySelector('.overflow-x-auto').scrollTop = 0;
          }
      });

      selectAllCheckbox.addEventListener('change', handleSelectAll);
      deleteSelectedBtn.addEventListener('click', handleMassDelete);

      // exportar XLSX
      exportXlsx.addEventListener('click', () => {
        try {
          // El objeto XLSX debería estar globalmente disponible si la librería cargó
          if (typeof XLSX === 'undefined') {
            showMsg('Error: La librería XLSX no se ha cargado. Verifique la consola (F12) y que el archivo xlsx.min.js esté en /public/js.', true);
            return;
          }
          const list = getExportList().map((s, i) => ({
              '#': i + 1,
              'Número de Control': s.numControl,
              Nombre: s.nombre,
              'Apellido Paterno': s.apellidoP, // Cabeceras de exportación con espacio
              'Apellido Materno': s.apellidoM, // Cabeceras de exportación con espacio
              Semestre: s.semestre,
              Carrera: (CARRERA_MAP[s.carrera] || s.carrera),
              Correo: s.correo,
          }));

          const ws = XLSX.utils.json_to_sheet(list);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'students');

          const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

          function s2ab(s) {
              const buf = new ArrayBuffer(s.length);
              const view = new Uint8Array(buf);
              for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
              return buf;
          }
          
          // Corrección de exportación para la descarga
          const blob = new Blob([s2ab(wbout)], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); 
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'matrícula_estudiantil.xlsx';
          a.click();
          
          // Retrasar la revocación para dar tiempo al navegador de iniciar la descarga
          setTimeout(() => URL.revokeObjectURL(url), 100); 

          showMsg('Listado exportado a Excel. 📊', false);

        } catch (err) {
          console.error(err);
          showMsg('Error al exportar a XLSX. Verifique que la librería esté cargada y que no haya errores previos.', true);
        }
      });

      // Lógica de IMPORTACIÓN Masiva (Upsert por numControl)
      importFile.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (typeof XLSX === 'undefined') {
          showMsg('Error: La librería XLSX no se ha cargado correctamente. Verifique que el archivo xlsx.min.js esté en /public/js.', true);
          e.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            
            // Usar raw:false para obtener los valores formateados
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, dateNF: "yyyy-mm-dd" });

            if (json.length < 2) {
              showMsg('El archivo está vacío o solo contiene la cabecera.', true);
              e.target.value = '';
              return;
            }

            const header = json[0].map(h => normalizeForSearch(h));
            
            const numControlCol = header.indexOf(normalizeForSearch('numcontrol'));
            const nombreCol = header.indexOf(normalizeForSearch('nombre'));
            
            // BUSCA APELLIDOPATERNO Y APELLIDOMATERNO SIN ESPACIOS
            const apellidoPCol = header.indexOf(normalizeForSearch('apellidopaterno'));
            const apellidoMCol = header.indexOf(normalizeForSearch('apellidomaterno'));
            
            const semestreCol = header.indexOf(normalizeForSearch('semestre'));
            const carreraCol = header.indexOf(normalizeForSearch('carrera'));
            const correoCol = header.indexOf(normalizeForSearch('correo'));

            // Se relaja la verificación para permitir ApellidoMaterno opcional
            if ([numControlCol, nombreCol, apellidoPCol, semestreCol, carreraCol, correoCol].some(i => i === -1)) {
              showMsg('Error: El formato del Excel no coincide con el esperado. Revise que las cabeceras sean exactamente: NumControl, Nombre, ApellidoPaterno, ApellidoMaterno, Semestre, Carrera, Correo.', true);
              e.target.value = '';
              return;
            }

            let list = readLocal();
            let added = 0;
            let updated = 0;

            json.slice(1).forEach(row => {
              // Si la fila no tiene un número de control, se omite
              if (!row[numControlCol] || String(row[numControlCol]).trim() === '') return;

              // Lógica de mapeo de nombre de carrera a código
              let carreraValue = String(row[carreraCol] || '').trim();
              let carreraCode = carreraValue.toUpperCase(); 

              if (carreraCode.length > 5 || carreraCode.includes(' ')) {
                  const normalizedName = normalizeForSearch(carreraValue);
                  carreraCode = REVERSE_CAREER_MAP[normalizedName] || '';
              } else if (!CARRERA_MAP[carreraCode]) {
                   // Si es un código corto que no existe, lo ponemos vacío
                   carreraCode = '';
              }
              // FIN LÓGICA DE CAMBIO

              const s = {
                  numControl: String(row[numControlCol]).toUpperCase().trim(),
                  nombre: capitalizeName(row[nombreCol] || ''),
                  apellidoP: capitalizeName(row[apellidoPCol] || ''),
                  apellidoM: capitalizeName(row[apellidoMCol] || ''),
                  semestre: parseInt(row[semestreCol] || '0', 10),
                  carrera: carreraCode, // <--- Usamos el código de la carrera
                  correo: String(row[correoCol] || '').toLowerCase().trim(),
              };

              // Buscar si ya existe por numControl
              const existingIndex = list.findIndex(e => e.numControl === s.numControl);

              if (existingIndex !== -1) {
                  s.id = list[existingIndex].id; // Conservar el ID existente
                  list[existingIndex] = s;
                  updated++;
              } else {
                  s.id = Date.now().toString() + Math.random().toString(36).slice(2, 7);
                  list.unshift(s);
                  added++;
              }
            });

            if (added > 0 || updated > 0) {
              writeLocal(list);
              paginationState.currentPage = 1;
              render();
              showMsg(`Carga Masiva: ${added} agregados, ${updated} actualizados. 💾`);
              window.dispatchEvent(new CustomEvent('students:imported', { detail: { added, updated } }));
            } else {
              showMsg('No se importaron nuevas filas válidas.', true);
            }
          } catch (err) {
            console.error(err); showMsg('Error al procesar el archivo.', true);
          } finally { e.target.value = ''; }
        };
        reader.readAsBinaryString(file);
      });


      clearBtn.addEventListener('click', () => {
        if (!confirm('⚠️ Advertencia: ¿Está seguro de que quiere ELIMINAR TODOS los datos locales de estudiantes? Esta acción es irreversible.')) return;
        localStorage.removeItem(STORAGE_KEY);
        selectedStudentIds.clear();
        paginationState.currentPage = 1;
        render();
        setFormVisibility(false);
        showMsg('Datos de la matrícula borrados del almacenamiento local. 🗑️', false);
      });

      // Inicialización
      render();
      
      // --- FUNCIONES DEL MODAL DE IMPORTACIÓN ---
      
      // Actualizar estadísticas
      function updateStats() {
        const total = allStudents.length;
        const filtered = filteredStudents.length;
        const careers = new Set(allStudents.map(s => s.carrera)).size;
        const semesters = new Set(allStudents.map(s => s.semestre)).size;
        
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-filtered').textContent = filtered;
        document.getElementById('stat-careers').textContent = careers;
        document.getElementById('stat-semesters').textContent = semesters;
      }
      
      // Abrir modal
      importExcelBtn.addEventListener('click', () => {
        importModal.classList.remove('hidden');
        selectedFile = null;
        importedData = [];
        fileInfo.classList.add('hidden');
        importSummary.classList.add('hidden');
        processImport.disabled = true;
      });
      
      // Cerrar modal
      closeImportModal.addEventListener('click', () => {
        importModal.classList.add('hidden');
      });
      
      cancelImport.addEventListener('click', () => {
        importModal.classList.add('hidden');
      });
      
      // Dropzone click
      dropzone.addEventListener('click', () => {
        importFileInput.click();
      });
      
      // Drag and drop
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-institucional', 'bg-slate-50');
      });
      
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('border-institucional', 'bg-slate-50');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-institucional', 'bg-slate-50');
        const file = e.dataTransfer.files[0];
        if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
          handleFile(file);
        }
      });
      
      // File input change
      importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });
      
      // Manejar archivo
      function handleFile(file) {
        selectedFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
        fileInfo.classList.remove('hidden');
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);
            
            // Mapear datos
            importedData = rows.map(row => ({
              id: String(Date.now() + Math.random()),
              numControl: (row.NumControl || row.numControl || row.num_control || '').toString().toUpperCase(),
              nombre: row.Nombre || row.nombre || row.name || '',
              apellidoP: row.ApellidoPaterno || row.apellidoPaterno || row.apellido_paterno || '',
              apellidoM: row.ApellidoMaterno || row.apellidoMaterno || row.apellido_materno || '',
              semestre: parseInt(row.Semestre || row.semestre || 0),
              carrera: (row.Carrera || row.carrera || row.career || '').toString().toUpperCase(),
              correo: row.Correo || row.correo || row.email || ''
            })).filter(s => s.numControl && s.nombre); // Solo estudiantes válidos
            
            studentsCount.textContent = importedData.length;
            importSummary.classList.remove('hidden');
            processImport.disabled = importedData.length === 0;
            
          } catch (error) {
            console.error('Error al leer Excel:', error);
            alert('Error al procesar el archivo Excel');
          }
        };
        reader.readAsArrayBuffer(file);
      }
      
      // Remover archivo
      removeFile.addEventListener('click', () => {
        selectedFile = null;
        importedData = [];
        fileInfo.classList.add('hidden');
        importSummary.classList.add('hidden');
        processImport.disabled = true;
        importFileInput.value = '';
      });
      
      // Procesar importación
      processImport.addEventListener('click', () => {
        if (importedData.length === 0) return;
        
        // Agregar estudiantes importados
        importedData.forEach(student => {
          allStudents.push(student);
        });
        
        // Guardar y recargar
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allStudents));
        importModal.classList.add('hidden');
        render();
        updateStats();
        alert(`✓ ${importedData.length} estudiante(s) importado(s) exitosamente`);
      });
      
      // Descargar plantilla
      downloadTemplate.addEventListener('click', () => {
        const template = [
          {
            NumControl: '20240001',
            Nombre: 'Juan',
            ApellidoPaterno: 'Pérez',
            ApellidoMaterno: 'López',
            Semestre: 1,
            Carrera: 'TAG-E',
            Correo: 'juan.perez@cbta71.edu.mx'
          }
        ];
        
        const ws = XLSX.utils.json_to_sheet(template);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Estudiantes');
        XLSX.writeFile(wb, 'plantilla_estudiantes_cbta71.xlsx');
      });
      
      // Inicializar estadísticas
      updateStats();

    })();
  </script>  <div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md" data-astro-cid-bw2fljil> <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl" data-astro-cid-bw2fljil> <button id="close-import-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" data-astro-cid-bw2fljil> <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" data-astro-cid-bw2fljil></path> </svg> </button> <h3 class="text-2xl font-bold text-slate-800 mb-2" data-astro-cid-bw2fljil>Importar Estudiantes desde Excel</h3> <p class="text-slate-500 text-sm mb-6" data-astro-cid-bw2fljil>Carga un archivo Excel con los datos de múltiples estudiantes</p> <!-- Dropzone --> <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-institucional hover:bg-slate-50" data-astro-cid-bw2fljil> <input type="file" id="import-file" accept=".xlsx,.xls" class="hidden" data-astro-cid-bw2fljil> <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" data-astro-cid-bw2fljil></path> </svg> <p class="text-slate-700 font-semibold mb-2" data-astro-cid-bw2fljil>Arrastra tu archivo Excel aquí</p> <p class="text-slate-500 text-sm mb-4" data-astro-cid-bw2fljil>o haz clic para seleccionar</p> <p class="text-xs text-slate-400" data-astro-cid-bw2fljil>Formatos: .xlsx, .xls</p> </div> <!-- Archivo seleccionado --> <div id="file-info" class="hidden mt-4 p-4 bg-slate-50 rounded-lg flex items-center gap-3" data-astro-cid-bw2fljil> <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" data-astro-cid-bw2fljil></path> </svg> <div class="flex-1" data-astro-cid-bw2fljil> <p id="file-name" class="font-semibold text-slate-800" data-astro-cid-bw2fljil></p> <p id="file-size" class="text-xs text-slate-500" data-astro-cid-bw2fljil></p> </div> <button id="remove-file" class="p-2 text-slate-400 hover:text-red-500" data-astro-cid-bw2fljil> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-astro-cid-bw2fljil> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" data-astro-cid-bw2fljil></path> </svg> </button> </div> <!-- Resumen --> <div id="import-summary" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg" data-astro-cid-bw2fljil> <p class="text-sm text-blue-800" data-astro-cid-bw2fljil> <span id="students-count" class="font-bold" data-astro-cid-bw2fljil>0</span> estudiante(s) detectado(s) en el archivo
</p> </div> <!-- Template info --> <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg" data-astro-cid-bw2fljil> <p class="text-sm font-semibold text-amber-900 mb-2" data-astro-cid-bw2fljil>📋 Formato requerido del Excel:</p> <div class="mt-2 text-xs text-amber-700 font-mono bg-white p-2 rounded" data-astro-cid-bw2fljil>
NumControl | Nombre | ApellidoPaterno | ApellidoMaterno | Semestre | Carrera | Correo
</div> <button id="download-template" class="mt-3 text-xs text-institucional hover:underline font-semibold" data-astro-cid-bw2fljil>
⬇️ Descargar plantilla de ejemplo
</button> </div> <!-- Botones --> <div class="flex gap-3 mt-6" data-astro-cid-bw2fljil> <button id="cancel-import" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors" data-astro-cid-bw2fljil>Cancelar</button> <button id="process-import" class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled data-astro-cid-bw2fljil>
Importar Estudiantes
</button> </div> </div> </div>   </div> </main> <script>
		const sidebar = document.getElementById('sidebar-menu');
		const openButton = document.getElementById('open-sidebar-button');
		const closeButton = document.getElementById('close-sidebar-button');
		const navLinks = document.querySelectorAll('.nav-link');
		const activeClass = 'nav-active';
		const inactiveClass = 'nav-inactive';


		function setActiveLink() {
			// Normaliza la ruta actual: / o /Dashboard
			let currentPath = window.location.pathname.replace(/\/$/, "");
			if (currentPath === "") currentPath = "/Dashboard";
			
			navLinks.forEach(link => {
				const linkPath = link.getAttribute('data-path');
				
				link.classList.remove(activeClass, inactiveClass);


				if (linkPath === currentPath) {
					link.classList.add(activeClass);
				} else {
					link.classList.add(inactiveClass);
				}
			});
		}


		function openSidebar() {
			sidebar.classList.remove('sidebar-closed', 'hidden');
			openButton.style.display = 'none';
			document.body.style.overflow = 'hidden';
			if (window.innerWidth < 768) {
				sidebar.classList.remove('hidden');
				sidebar.classList.add('fixed', 'inset-0');
			}
		}

		function closeSidebar() {
			sidebar.classList.add('sidebar-closed');
			// Usamos setTimeout solo para acciones después de la transición
			setTimeout(() => {
				if (window.innerWidth < 768) {
					sidebar.classList.add('hidden');
					sidebar.classList.remove('fixed', 'inset-0');
					openButton.style.display = 'block';
				}
				document.body.style.overflow = '';
			}, 300); // 300ms = duración de la transición CSS
		}


		openButton?.addEventListener('click', openSidebar);
		closeButton?.addEventListener('click', closeSidebar);
		
		// Cerrar sidebar en móvil al hacer click en un enlace
		navLinks.forEach(link => link.addEventListener('click', (e) => {
			if (window.innerWidth < 768) closeSidebar();
			// No llamar setActiveLink aquí, sino dejar que Astro lo maneje o window.load
		}));


		const handleResize = () => {
			if (window.innerWidth >= 768) {
				// Desktop: Sidebar siempre visible y abierto
				sidebar.classList.remove('hidden', 'sidebar-closed', 'inset-0');
				openButton.style.display = 'none';
				document.body.style.overflow = '';
			} else {
				// Mobile: Ocultar si está cerrado
				if (sidebar.classList.contains('sidebar-closed')) {
                    sidebar.classList.add('hidden');
                    openButton.style.display = 'block';
                } else {
                    openButton.style.display = 'none';
                }
			}
		};


		window.addEventListener('resize', handleResize);
		window.addEventListener('load', () => { handleResize(); setActiveLink(); });
		document.addEventListener("astro:after-swap", setActiveLink);
	</script> </body> </html>