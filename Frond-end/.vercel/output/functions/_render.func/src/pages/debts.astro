---
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Estado de Adeudos - CBTA 71";

const CAREER_MAP = {
  'TAG-E': 'Técnico Agropecuario',
  'TOF': 'Técnico en Ofimática',
  'TEM': 'Técnico en Admón. de Emprendimiento',
  'TAG-M': 'Técnico Agropecuario (Mixta)',
  'TRH': 'Técnico en Admón. de Recursos Humanos (Mixta)',
  '': 'Sin Carrera'
};

const careerMapJSON = JSON.stringify(CAREER_MAP);
---
<Layout title={pageTitle}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 bg-gray-50/50 min-h-screen">
    
    <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-10 pb-8 border-b-2 border-[#2D584C]/10">
      <div class="flex items-center gap-4 w-full justify-start">
        <div class="p-3 bg-[#2D584C] rounded-xl shadow-lg shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v2m0 2v2m0 0V4m-7 8a7 7 0 1114 0 7 7 0 01-14 0z" />
          </svg>
        </div>
        <div class="text-left">
          <h1 class="text-3xl font-black text-gray-900 tracking-tight leading-none text-left">Estado de Adeudos</h1>
          <p class="text-sm text-gray-500 mt-1 font-medium text-left">Cargos pendientes por cobrar.</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto justify-start lg:justify-end">
        <div class="relative w-full lg:w-[300px]">
           <input type="text" id="search-input" placeholder="Buscar alumno..." class="w-full pl-4 h-[46px] border-2 border-gray-200 rounded-xl text-sm outline-none focus:border-[#2D584C] bg-white shadow-sm" />
        </div>
        <button id="open-pay-modal-btn" class="h-[46px] px-5 bg-[#2D584C] text-white rounded-xl shadow-md hover:brightness-110 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2 shrink-0">
          Registrar Pago
        </button>
        <button id="export-xlsx" class="h-[46px] px-5 bg-emerald-600 text-white rounded-xl shadow-md hover:bg-emerald-700 transition-all flex items-center justify-center text-[10px] font-black uppercase tracking-widest gap-2">
           EXPORTAR EXCEL
        </button>
      </div>
    </header>

    <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse">
          <thead class="bg-[#2D584C]">
            <tr>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Estudiante</th>
              <th class="px-8 py-5 text-left text-[10px] font-black text-white uppercase tracking-widest">Concepto</th>
              <th class="px-8 py-5 text-right text-[10px] font-black text-white uppercase tracking-widest">Monto</th>
            </tr>
          </thead>
          <tbody id="payments-table-body" class="bg-white divide-y divide-gray-50"></tbody>
        </table>
      </div>

      <div class="px-8 py-4 bg-gray-50 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
        <span id="pagination-info" class="text-[11px] font-bold text-gray-500 uppercase">Mostrando 0 de 0 adeudos</span>
        <div class="flex items-center gap-2" id="pagination-buttons"></div>
      </div>
    </div>
  </div>

  <div id="pay-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 text-left">
    <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4 border-b pb-3">
        <h3 class="text-lg font-black text-gray-900">Registrar Pago</h3>
        <button id="pay-close-x" class="text-gray-400">✕</button>
      </div>
      <form id="pay-form" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-[9px] font-black text-gray-400 uppercase mb-1">Referencia / Folio</label>
            <input id="pay-code" type="text" placeholder="Ej: 4567" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 text-xs font-bold uppercase" required />
          </div>
          <div>
            <label class="block text-[9px] font-black text-gray-400 uppercase mb-1">Método</label>
            <select id="pay-method" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 text-xs font-bold" required>
              <option value="Transferencia">Transferencia</option>
              <option value="Depósito">Depósito</option>
            </select>
          </div>
        </div>
        
        <div class="relative">
          <label class="block text-[9px] font-black text-gray-400 uppercase mb-1">Buscar Alumno</label>
          <input id="pay-student-search" type="text" autocomplete="off" placeholder="Nombre o No. Control..." class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 text-xs" />
          <div id="autocomplete-list" class="absolute z-20 w-full bg-white border rounded-xl mt-1 shadow-2xl max-h-40 overflow-y-auto hidden"></div>
        </div>

        <div id="selected-student-info" class="hidden p-3 bg-emerald-50 border border-emerald-100 rounded-lg">
            <div id="display-student-name" class="text-[11px] font-black text-[#2D584C] uppercase"></div>
            <div id="display-student-control" class="text-[9px] font-mono font-bold text-emerald-600/70"></div>
        </div>

        <div>
          <label class="block text-[9px] font-black text-gray-400 uppercase mb-1">Adeudo Correspondiente</label>
          <select id="pay-charge-id" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 text-xs font-bold disabled:opacity-50" disabled required>
            <option value="">Primero selecciona un alumno</option>
          </select>
        </div>

        <div class="flex justify-end gap-2 pt-3 border-t mt-4">
          <button type="button" id="pay-cancel" class="px-4 py-2 text-gray-400 font-bold text-[9px] uppercase">Cancelar</button>
          <button type="submit" class="px-6 py-2 bg-[#2D584C] text-white rounded-lg font-black text-[9px] uppercase tracking-widest">Confirmar Pago</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>

  <script is:inline define:vars={{ careerMapJSON }}>
    window.__CAREER_MAP = JSON.parse(careerMapJSON);
  </script>

  <script type="module">
    const ITEMS_PER_PAGE = 50;
    let currentPage = 1;

    const getCharges = () => JSON.parse(localStorage.getItem('chargesList') || '[]');
    const getStudents = () => JSON.parse(localStorage.getItem('studentsList') || '[]');
    const getConcepts = () => JSON.parse(localStorage.getItem('conceptsList') || '[]');
    const saveCharges = (data) => localStorage.setItem('chargesList', JSON.stringify(data));
    const fmt = n => '$' + Number(n).toLocaleString('es-MX', { minimumFractionDigits: 2 });

    const tableBody = document.getElementById('payments-table-body');
    const searchInput = document.getElementById('search-input');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationButtons = document.getElementById('pagination-buttons');

    function renderTable() {
        const term = searchInput.value.toLowerCase();
        const students = getStudents();
        const concepts = getConcepts();
        
        const allPending = getCharges().filter(c => !['paid', 'pagado'].includes(String(c.status).toLowerCase()));
        
        const filtered = allPending.filter(ch => {
            const s = students.find(x => String(x.id) === String(ch.studentId) || String(x.numControl) === String(ch.studentId)) || {};
            const sFullName = `${s.nombre} ${s.apellidoP} ${s.apellidoM}`.toLowerCase();
            return !term || sFullName.includes(term) || String(s.numControl).includes(term);
        });

        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        if (currentPage > totalPages) currentPage = totalPages || 1;
        
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);

        tableBody.innerHTML = pageData.map((ch) => {
            const s = students.find(x => String(x.id) === String(ch.studentId) || String(x.numControl) === String(ch.studentId)) || {};
            const c = concepts.find(con => String(con.id) === String(ch.conceptId));
            const conceptName = c ? (c.title || c.concept) : (ch.conceptTitle || ch.concept || 'CARGO');
            const sFullName = [s.nombre, s.apellidoP, s.apellidoM].filter(Boolean).join(' ');

            return `
              <tr class="hover:bg-gray-50 transition-all border-l-4 border-transparent hover:border-[#2D584C]">
                <td class="px-8 py-5">
                    <div class="text-[12px] font-black text-gray-900 uppercase">${sFullName}</div>
                    <div class="text-[9px] text-gray-400 font-mono font-bold">${s.numControl || '-'}</div>
                </td>
                <td class="px-8 py-5 text-[11px] text-gray-500 font-bold uppercase">${conceptName}</td>
                <td class="px-8 py-5 text-right text-sm font-black text-red-600 font-mono">${fmt(ch.amount)}</td>
              </tr>
            `;
        }).join('');

        updatePaginationControls(totalItems, totalPages);
    }

    function updatePaginationControls(totalItems, totalPages) {
        const startItem = totalItems === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;
        const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
        paginationInfo.innerText = `Mostrando ${startItem}-${endItem} de ${totalItems} registros`;
        paginationButtons.innerHTML = '';
        if (totalPages <= 1) return;
        
        const createBtn = (text, targetPage, active = false, disabled = false) => {
            const btn = document.createElement('button');
            btn.innerText = text;
            btn.className = `min-w-[32px] h-8 px-2 rounded-lg text-xs font-black ${active ? 'bg-[#2D584C] text-white' : disabled ? 'text-gray-300' : 'text-gray-500 hover:bg-gray-200'}`;
            if (!disabled) btn.onclick = () => { currentPage = targetPage; renderTable(); window.scrollTo(0,0); };
            return btn;
        };
        paginationButtons.appendChild(createBtn('←', currentPage - 1, false, currentPage === 1));
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                paginationButtons.appendChild(createBtn(i, i, currentPage === i));
            }
        }
        paginationButtons.appendChild(createBtn('→', currentPage + 1, false, currentPage === totalPages));
    }

    // --- LÓGICA DE EXPORTACIÓN EXCEL ---
    document.getElementById('export-xlsx').onclick = () => {
        const charges = getCharges().filter(c => !['paid', 'pagado'].includes(String(c.status).toLowerCase()));
        const students = getStudents();
        const concepts = getConcepts();

        const data = charges.map(ch => {
            const s = students.find(x => String(x.id) === String(ch.studentId) || String(x.numControl) === String(ch.studentId)) || {};
            const c = concepts.find(con => String(con.id) === String(ch.conceptId));
            return {
                'No. Control': s.numControl || 'N/A',
                'Nombre Completo': `${s.nombre || ''} ${s.apellidoP || ''} ${s.apellidoM || ''}`.trim(),
                'Carrera': window.__CAREER_MAP[s.carrera] || s.carrera || 'N/A',
                'Grado/Grupo': `${s.grado || ''}° ${s.grupo || ''}`,
                'Concepto': c ? (c.title || c.concept) : (ch.conceptTitle || ch.concept),
                'Monto': ch.amount,
                'Estatus': 'PENDIENTE'
            };
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Adeudos");
        XLSX.writeFile(workbook, `Adeudos_CBTA71_${new Date().toLocaleDateString()}.xlsx`);
    };

    // --- LÓGICA DEL MODAL Y AUTOCOMPLETADO ---
    const modal = document.getElementById('pay-modal');
    const paySearchInput = document.getElementById('pay-student-search');
    const autocompleteList = document.getElementById('autocomplete-list');
    const selectedInfo = document.getElementById('selected-student-info');
    const chargeSelect = document.getElementById('pay-charge-id');

    document.getElementById('open-pay-modal-btn').onclick = () => {
        document.getElementById('pay-form').reset();
        selectedInfo.classList.add('hidden');
        chargeSelect.disabled = true;
        modal.classList.replace('hidden', 'flex');
    };
    
    const closeModal = () => modal.classList.replace('flex', 'hidden');
    document.getElementById('pay-close-x').onclick = closeModal;
    document.getElementById('pay-cancel').onclick = closeModal;

    paySearchInput.addEventListener('input', () => {
        const val = paySearchInput.value.toLowerCase();
        autocompleteList.innerHTML = '';
        if (!val) return autocompleteList.classList.add('hidden');

        const students = getStudents();
        const filtered = students.filter(s => {
            const full = `${s.nombre} ${s.apellidoP} ${s.apellidoM}`.toLowerCase();
            return full.includes(val) || String(s.numControl).includes(val);
        }).slice(0, 5);

        if (filtered.length > 0) {
            filtered.forEach(s => {
                const item = document.createElement('div');
                item.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b last:border-0';
                item.innerHTML = `<div class="text-[10px] font-bold">${s.nombre} ${s.apellidoP}</div><div class="text-[9px] text-gray-400">${s.numControl}</div>`;
                item.onclick = () => selectStudent(s);
                autocompleteList.appendChild(item);
            });
            autocompleteList.classList.remove('hidden');
        } else {
            autocompleteList.classList.add('hidden');
        }
    });

    function selectStudent(student) {
        paySearchInput.value = '';
        autocompleteList.classList.add('hidden');
        selectedInfo.classList.remove('hidden');
        document.getElementById('display-student-name').innerText = `${student.nombre} ${student.apellidoP} ${student.apellidoM}`;
        document.getElementById('display-student-control').innerText = `No. Control: ${student.numControl}`;
        
        const allCharges = getCharges();
        const concepts = getConcepts();
        const studentCharges = allCharges.filter(c => 
            (String(c.studentId) === String(student.id) || String(c.studentId) === String(student.numControl)) &&
            !['paid', 'pagado'].includes(String(c.status).toLowerCase())
        );

        chargeSelect.innerHTML = '<option value="">Seleccione un adeudo...</option>';
        if (studentCharges.length > 0) {
            studentCharges.forEach(ch => {
                const c = concepts.find(con => String(con.id) === String(ch.conceptId));
                const name = c ? (c.title || c.concept) : (ch.conceptTitle || ch.concept);
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.innerText = `${name} - ${fmt(ch.amount)}`;
                chargeSelect.appendChild(opt);
            });
            chargeSelect.disabled = false;
        } else {
            chargeSelect.innerHTML = '<option>Sin adeudos pendientes</option>';
            chargeSelect.disabled = true;
        }
    }

    document.getElementById('pay-form').onsubmit = (e) => {
        e.preventDefault();
        const chargeId = chargeSelect.value;
        const ref = document.getElementById('pay-code').value;
        const method = document.getElementById('pay-method').value;

        let charges = getCharges();
        const idx = charges.findIndex(c => String(c.id) === String(chargeId));

        if (idx !== -1) {
            charges[idx].status = 'paid';
            charges[idx].paymentDate = new Date().toISOString();
            charges[idx].reference = ref;
            charges[idx].method = method;
            saveCharges(charges);
            closeModal();
            renderTable();
        }
    };

    searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
    renderTable();
  </script>
</Layout>