---
import StudentLayout from '../../layouts/LayoutEstu.astro';
import { API_ENDPOINTS } from '../../config/api.js';

let alumnoBackend = "Estudiante";
let title = "Historial de Pagos";
let historialSemilla = [];
let error = null;

try {
  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('token') : null;
  const userId = typeof localStorage !== 'undefined' ? localStorage.getItem('userId') : null;
  const userName = typeof localStorage !== 'undefined' ? localStorage.getItem('userName') : 'Estudiante';

  if (token && userId) {
    alumnoBackend = userName;

    // Fetch payment history
    try {
      const historyRes = await fetch(API_ENDPOINTS.paymentHistory.get(userId), {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });
      
      if (historyRes.ok) {
        const historyData = await historyRes.json();
        historialSemilla = Array.isArray(historyData) ? historyData.map(payment => ({
          id: payment.id,
          concepto: payment.concept_name || payment.concepto || 'Pago',
          monto: payment.amount?.toString() || payment.monto || '0.00',
          fecha: payment.payment_date || payment.fecha || new Date().toLocaleDateString('es-MX'),
          metodo: payment.payment_method || payment.metodo || 'M√©todo desconocido',
          folio: payment.reference_number || payment.folio || 'PAY-' + payment.id,
          categoria: payment.category || payment.categoria || 'Pago'
        })) : [];
      }
    } catch (err) {
      console.error('Error fetching payment history:', err);
      historialSemilla = [];
    }
  } else {
    error = 'Usuario no autenticado';
  }
} catch (err) {
  console.error('Error initializing Historial:', err);
  error = 'Error al cargar el historial';
}
---

<StudentLayout title={title}>
  <div 
    class="page-wrapper"
    x-data={`{
      search: '',
      pagos: [],
      
      init() {
        const guardados = localStorage.getItem('historial_pagos');
        if (guardados) {
          this.pagos = JSON.parse(guardados);
        } else {
          this.pagos = ${JSON.stringify(historialSemilla)};
          localStorage.setItem('historial_pagos', JSON.stringify(this.pagos));
        }
      },

      eliminarPago(id) {
        if(confirm('¬øEst√°s seguro de que deseas eliminar este registro del historial?')) {
          this.pagos = this.pagos.filter(p => p.id !== id);
          localStorage.setItem('historial_pagos', JSON.stringify(this.pagos));
        }
      },

      get pagosFiltrados() {
        if(!this.search) return this.pagos;
        return this.pagos.filter(p => 
          p.concepto.toLowerCase().includes(this.search.toLowerCase()) || 
          p.folio.toLowerCase().includes(this.search.toLowerCase())
        );
      }
    }`}
  >
    
    <header class="history-header">
      <div class="header-main">
        <div class="title-group">
          <p class="pre-title">Gesti√≥n Financiera</p>
          <h1>Mi Historial</h1>
        </div>
        <div class="user-pill">
          <div class="avatar-mini">PG</div>
          <span>{alumnoBackend}</span>
        </div>
      </div>

      <div class="filter-bar">
        <div class="search-box">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input id="search-payments" name="searchPayments" type="text" x-model="search" placeholder="Buscar por concepto o folio...">
        </div>
      </div>
    </header>

    <nav class="student-nav">
      <a href="/Estudiante/PortalEstudiante" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span>Inicio</span>
      </a>
      <a href="/Estudiante/Adeudos" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><path d="M12 1v6m0 6v4"></path></svg>
        <span>Adeudos</span>
      </a>
      <a href="/Estudiante/Historial" class="nav-link" style="opacity: 0.8;">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
        <span>Historial</span>
      </a>
      <a href="/Estudiante/Tarjetas" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
        <span>Tarjetas</span>
      </a>
      <a href="/Estudiante/Perfil" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Perfil</span>
      </a>
    </nav>

    <main class="history-content">
      <template x-if="pagosFiltrados.length === 0">
        <div class="empty-state" style="text-align: center; padding: 4rem 1rem; color: var(--text-muted);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
          <h3>Historial vac√≠o</h3>
          <p>No se encontraron registros de pagos.</p>
        </div>
      </template>

      <div class="timeline">
        <template x-for="pago in pagosFiltrados" :key="pago.id">
          <div class="timeline-item">
            <div class="timeline-dot-wrapper">
              <div class="timeline-dot"></div>
              <div class="timeline-line"></div>
            </div>

            <div class="payment-card">
              <div class="payment-info">
                <div class="category-tag" x-text="pago.categoria"></div>
                <h3 x-text="pago.concepto" style="margin: 4px 0; color: var(--primary); font-weight: 700;"></h3>
                <div class="payment-meta" style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                  <span x-text="pago.fecha"></span>
                  <span class="separator" style="margin: 0 6px;">‚Ä¢</span>
                  <span class="folio" x-text="'ID: ' + pago.folio"></span>
                </div>
                <div class="method-pill">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                  <span x-text="pago.metodo"></span>
                </div>
              </div>

              <div class="payment-action">
                <div class="amount-group">
                  <span class="currency" style="font-size: 1rem; font-weight: 600; vertical-align: super; color: var(--primary);">$</span>
                  <span class="amount" x-text="pago.monto.split('.')[0]"></span>
                  <span class="decimals" x-text="'.' + (pago.monto.split('.')[1] || '00')" style="font-size: 1rem; font-weight: 600; color: var(--primary);"></span>
                </div>
                <button class="delete-btn" @click="eliminarPago(pago.id)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                  <span>Eliminar</span>
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </main>
  </div>
</StudentLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
  :root { --primary: #112d26; --accent: #c4a47c; --text-muted: #64748b; --bg-page: #f8fafc; --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); --danger: #e53e3e; }
  
  .page-wrapper { max-width: 750px; margin: 0 auto; padding: 2.5rem 1.25rem; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-page); min-height: 100vh; }
  
  .header-main { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; }
  .header-main h1 { margin: 0; font-size: 2rem; font-weight: 800; color: var(--primary); }
  .pre-title { font-size: 0.8rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .user-pill { background: white; padding: 6px 12px; border-radius: 100px; display: flex; align-items: center; gap: 10px; box-shadow: var(--card-shadow); font-size: 0.85rem; font-weight: 700; color: var(--primary); }
  .avatar-mini { width: 28px; height: 28px; background: var(--primary); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 0.7rem; }
  
  .filter-bar { background: white; border-radius: 16px; padding: 6px; box-shadow: var(--card-shadow); border: 1px solid #f1f5f9; margin-bottom: 2rem; }
  .search-box { display: flex; align-items: center; gap: 10px; padding: 8px 12px; color: var(--text-muted); }
  .search-box input { border: none; width: 100%; outline: none; font-family: inherit; font-size: 0.95rem; }

  .timeline { position: relative; padding-left: 20px; }
  .timeline-item { position: relative; display: flex; gap: 20px; margin-bottom: 25px; }
  .timeline-dot { width: 14px; height: 14px; background: var(--accent); border-radius: 50%; z-index: 2; margin-top: 25px; box-shadow: 0 0 0 4px #f1f5f9; }
  .timeline-line { position: absolute; top: 30px; bottom: -30px; width: 2px; background: #e2e8f0; left: 26px; }
  .timeline-item:last-child .timeline-line { display: none; }

  .payment-card { background: white; border-radius: 24px; padding: 20px; flex: 1; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--card-shadow); border: 1px solid transparent; transition: 0.3s; }
  .payment-card:hover { border-color: #feb2b2; background: #fffafb; }
  
  .category-tag { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: 0.5px; }
  .method-pill { display: inline-flex; align-items: center; gap: 6px; background: #f8fafc; padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; color: var(--primary); font-weight: 700; border: 1px solid #f1f5f9; }
  
  .payment-action { text-align: right; display: flex; flex-direction: column; gap: 12px; min-width: 120px; }
  .amount { font-size: 1.6rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
  
  /* ESTILO DEL BOT√ìN ELIMINAR */
  .delete-btn { background: #fee2e2; color: var(--danger); border: 1.5px solid #fecaca; padding: 8px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; transition: 0.2s; }
  .delete-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
  .delete-btn:active { transform: scale(0.95); }

  @media (max-width: 768px) {
    .header-main { flex-direction: column; align-items: flex-start; gap: 1rem; }
    .payment-card { flex-direction: column; align-items: flex-start; gap: 1.2rem; }
    .payment-action { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; padding-top: 1.2rem; text-align: left; }
    .timeline { padding-left: 10px; }
    .timeline-line { left: 16px; }
  }
</style>