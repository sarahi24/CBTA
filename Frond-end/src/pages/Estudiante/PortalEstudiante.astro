---
// Updated version - Jan 26, 2026 - API Integration
import StudentLayout from '../../layouts/LayoutEstu.astro';
import StatCard from './components/StatCard.astro';
import ProgressCircle from './components/ProgressCircle.astro';
import PaymentsTable from './components/PaymentsTable.astro'; 
import { API_ENDPOINTS, handleAPIResponse } from '../../config/api.js';

let dashboardData = {};
let error = null;

try {
  // Get user ID from localStorage (set during login)
  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('token') : null;
  const userId = typeof localStorage !== 'undefined' ? localStorage.getItem('userId') : null;

  if (token && userId) {
    // Fetch dashboard data from backend
    const response = await fetch(`${API_ENDPOINTS.dashboard.refresh}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });

    if (response.ok) {
      dashboardData = await response.json();
    } else if (response.status === 401) {
      // Token expired
      error = 'Sesión expirada. Por favor, inicia sesión nuevamente.';
    } else {
      error = 'No se pudo cargar el panel.';
    }
  } else {
    error = 'Usuario no autenticado';
  }
} catch (err) {
  console.error('Error fetching dashboard:', err);
  error = 'Error al conectar con el servidor.';
}
---

<StudentLayout title="Panel de Estudiante">
  <div class="main-container">
    <header class="welcome-header">
      <div class="header-left">
        <div class="icon-box">
          <svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <div>
          <p class="welcome-label">Dashboard Académico</p>
          <h1 class="student-name">Hola, {dashboardData.alumnoNombre?.split(' ')[0] || "Estudiante"}</h1>
        </div>
      </div>
      <div class="header-right mobile-hide">
        <span class="current-date">{new Date().toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
      </div>
    </header>

    <!-- Navigation Menu -->
    <nav class="student-nav">
      <a href="/Estudiante/PortalEstudiante" class="nav-link active">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Inicio</span>
      </a>
      <a href="/Estudiante/Adeudos" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="1"></circle>
          <path d="M12 1v6m6.16-1.16l-4.24 4.24m6 6l-4.24-4.24m-6 6l4.24-4.24M1 12.84l4.24-4.24"></path>
        </svg>
        <span>Adeudos</span>
      </a>
      <a href="/Estudiante/Historial" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 18 0A9 9 0 0 0 3 12"></path>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span>Historial</span>
      </a>
      <a href="/Estudiante/Tarjetas" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
          <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
        <span>Tarjetas</span>
      </a>
      <a href="/Estudiante/Perfil" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Perfil</span>
      </a>
    </nav>

    <section class="stats-scroll-container">
      <StatCard 
        title="Pendientes" 
        amount={dashboardData?.pagosPendientes?.monto || "$0.00"} 
        subtitle={dashboardData?.pagosPendientes?.info || "Sin adeudos"} 
        type="danger"
      >
        <svg slot="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4l3 3"></path></svg>
      </StatCard>

      <StatCard 
        title="Realizados" 
        amount={dashboardData?.pagosRealizados?.monto || "$0.00"} 
        subtitle={dashboardData?.pagosRealizados?.info || "0 Pagos"} 
        type="default"
      >
        <svg slot="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
      </StatCard>

      <StatCard 
        title="Total Inversión" 
        amount={dashboardData?.totalPagado || "$0.00"} 
        subtitle="Monto acumulado" 
        type="info"
      >
        <svg slot="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
      </StatCard>
    </section>

    <div class="bottom-grid">
      <div class="summary-card glass-effect">
        <div class="card-header">
           <h3 class="summary-title">Balance de Cuenta</h3>
           <span class="status-badge">Actualizado</span>
        </div>
        <div class="summary-row">
          <div class="label-group">
            <div class="dot green"></div>
            <span class="summary-label">Monto Liquidado</span>
          </div>
          <span class="val-ok">{dashboardData?.totalPagado}</span>
        </div>
        <div class="summary-row no-border">
          <div class="label-group">
            <div class="dot red"></div>
            <span class="summary-label">Monto por Pagar</span>
          </div>
          <span class="val-alert">{dashboardData?.totalPendiente}</span>
        </div>
      </div>

      <div class="progress-card glass-effect">
        <div class="progress-inner">
           <ProgressCircle percentage={dashboardData?.porcentajeProgreso} label="Logro" />
        </div>
      </div>
    </div>

    <div class="payments-wrapper glass-effect">
      <div class="table-header">
        <h3 class="summary-title">Historial Reciente</h3>
      </div>
      <PaymentsTable pagos={dashboardData?.pagos} />
    </div>
  </div>
</StudentLayout>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

  :root {
    --primary: #2E594D;
    --primary-light: #e9f0ee;
    --danger: #ef4444;
    --text-main: #111827;
    --text-muted: #6b7280;
    --bg-page: #f8fafc;
    --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  }

  .main-container { 
    padding: 2.5rem; 
    display: flex; 
    flex-direction: column; 
    gap: 2rem; 
    max-width: 1200px;
    margin: 0 auto;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: var(--bg-page);
  }

  /* --- HEADER --- */
  .welcome-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
  }
  .header-left { display: flex; align-items: center; gap: 1.25rem; }
  .icon-box { 
    background: var(--primary); 
    padding: 1rem; 
    border-radius: 1.25rem; 
    box-shadow: 0 10px 20px -5px rgba(46, 89, 77, 0.3);
  }
  .header-icon-svg { width: 1.75rem; height: 1.75rem; color: #fff; }
  .welcome-label { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: var(--primary); letter-spacing: 0.05em; margin-bottom: 0.25rem; }
  .student-name { font-size: 2.25rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em; }
  .current-date { color: var(--text-muted); font-weight: 600; text-transform: capitalize; }

  /* --- STATS --- */
  .stats-scroll-container { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 1.5rem; 
  }

  /* --- CARDS & GRID --- */
  .bottom-grid { 
    display: grid; 
    grid-template-columns: 1.8fr 1.2fr; 
    gap: 1.5rem; 
  }

  .glass-effect {
    background: white; 
    border: 1px solid rgba(241, 245, 249, 1); 
    border-radius: 2rem; 
    padding: 2rem; 
    box-shadow: var(--shadow);
  }

  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
  .status-badge { background: var(--primary-light); color: var(--primary); padding: 0.4rem 0.8rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 700; }
  
  .summary-title { color: var(--text-main); font-weight: 800; font-size: 1.25rem; margin: 0; }
  
  .summary-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 1.25rem 0; 
    border-bottom: 1px solid #f1f5f9; 
  }
  .label-group { display: flex; align-items: center; gap: 0.75rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot.green { background: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
  .dot.red { background: var(--danger); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
  
  .summary-label { font-weight: 600; color: var(--text-muted); font-size: 1rem; }
  .val-ok, .val-alert { color: var(--text-main); font-weight: 800; font-size: 1.35rem; }
  .val-alert { color: var(--danger); }
  .no-border { border: none; }

  .progress-inner { display: flex; justify-content: center; align-items: center; height: 100%; }

  .table-header { margin-bottom: 1.5rem; }

  /* --- STUDENT NAVIGATION --- */
  .student-nav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: linear-gradient(to right, var(--primary), #1f7f5c);
    padding: 1rem 0;
    border-radius: 0.75rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(46, 89, 77, 0.15);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #fff;
    transition: all 0.3s ease;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
  }

  .nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .nav-icon {
    width: 1.5rem;
    height: 1.5rem;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }

  .nav-link span {
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }

  /* --- MOBILE ADAPTATIONS --- */
  @media (max-width: 768px) {
    .main-container { padding: 1rem; gap: 1.5rem; max-width: none; }
    .welcome-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
    .header-left { gap: 0.8rem; }
    .icon-box { padding: 0.8rem; border-radius: 1rem; }
    .header-icon-svg { width: 1.5rem; height: 1.5rem; }
    .welcome-label { font-size: 0.75rem; }
    .student-name { font-size: 1.5rem; }
    .mobile-hide { display: none; }

    .stats-scroll-container { 
      display: flex; 
      overflow-x: auto; 
      margin: 0 -1rem; 
      padding: 0 1rem 0.5rem 1rem;
      scrollbar-width: none;
    }
    .stats-scroll-container::-webkit-scrollbar { display: none; }

    .stats-scroll-container > * {
      min-width: 240px;
      flex: 0 0 auto;
    }

    .bottom-grid { grid-template-columns: 1fr; gap: 1.5rem; }
    .summary-card { order: 1; }
    .progress-card { order: 2; }
    .payments-wrapper { order: 3; }
    .glass-effect { padding: 1.2rem; border-radius: 1.2rem; }
    .card-header { margin-bottom: 1.5rem; }
    .summary-title { font-size: 1.1rem; }
    .summary-row { padding: 1rem 0; }
    .label-group { gap: 0.5rem; }
    .dot { width: 6px; height: 6px; }
    .summary-label { font-size: 0.9rem; }
    .val-ok, .val-alert { font-size: 1.1rem; }
    .progress-inner { padding: 1rem; }
    .table-header { margin-bottom: 1rem; }
    .payments-title { font-size: 1rem; }
  }
</style>