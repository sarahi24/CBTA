---
import StudentLayout from '../../layouts/LayoutEstu.astro';

const title = "Mi Perfil";
---

<StudentLayout title={title}>
  <div class="profile-container" x-data="profileManager()" x-init="init()">
    <header class="profile-header">
      <div class="header-content">
        <h1>Mi Perfil</h1>
        <p class="subtitle">Actualiza tu informaci√≥n personal</p>
      </div>
    </header>

    <nav class="student-nav">
      <a href="/Estudiante/PortalEstudiante" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span>Inicio</span>
      </a>
      <a href="/Estudiante/Adeudos" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><path d="M12 1v6m0 6v4"></path></svg>
        <span>Adeudos</span>
      </a>
      <a href="/Estudiante/Historial" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
        <span>Historial</span>
      </a>
      <a href="/Estudiante/Tarjetas" class="nav-link">
        <svg class="nav-icon" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
        <span>Tarjetas</span>
      </a>
      <a href="/Estudiante/Perfil" class="nav-link" style="opacity: 0.8;">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Perfil</span>
      </a>
    </nav>

    <main class="profile-content">
      <!-- Tabs de navegaci√≥n -->
      <div class="tabs-nav">
        <button 
          @click="activeTab = 'datos'" 
          :class="{ 'active': activeTab === 'datos' }"
          class="tab-btn"
        >
          Datos Personales
        </button>
        <button 
          @click="activeTab = 'password'" 
          :class="{ 'active': activeTab === 'password' }"
          class="tab-btn"
        >
          Cambiar Contrase√±a
        </button>
      </div>

      <!-- TAB 1: Datos Personales -->
      <div x-show="activeTab === 'datos'" class="tab-content">
        <section class="form-section">
          <h2>Datos Personales</h2>
          
          <template x-if="loading">
            <div class="loading-state">Cargando datos...</div>
          </template>

          <template x-if="!loading">
            <form @submit.prevent="updateProfile()" class="user-form">
              <div class="form-grid">
                <div class="form-group">
                  <label for="name">Nombre</label>
                  <input 
                    id="name" 
                    name="name"
                    type="text" 
                    x-model="formData.name" 
                    placeholder="Tu nombre"
                    class="form-input"
                  >
                  <template x-if="errors.name">
                    <span class="error-text" x-text="errors.name[0]"></span>
                  </template>
                </div>

                <div class="form-group">
                  <label for="last_name">Apellido</label>
                  <input 
                    id="last_name" 
                    name="last_name"
                    type="text" 
                    x-model="formData.last_name" 
                    placeholder="Tu apellido"
                    class="form-input"
                  >
                  <template x-if="errors.last_name">
                    <span class="error-text" x-text="errors.last_name[0]"></span>
                  </template>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input 
                    id="email" 
                    name="email"
                    type="email" 
                    x-model="formData.email" 
                    placeholder="tu@email.com"
                    class="form-input"
                  >
                  <template x-if="errors.email">
                    <span class="error-text" x-text="errors.email[0]"></span>
                  </template>
                </div>

                <div class="form-group">
                  <label for="phone_number">Tel√©fono</label>
                  <input 
                    id="phone_number" 
                    name="phone_number"
                    type="tel" 
                    x-model="formData.phone_number" 
                    placeholder="+5215512345678"
                    class="form-input"
                  >
                  <template x-if="errors.phone_number">
                    <span class="error-text" x-text="errors.phone_number[0]"></span>
                  </template>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="birthdate">Fecha de Nacimiento</label>
                  <input 
                    id="birthdate" 
                    name="birthdate"
                    type="date" 
                    x-model="formData.birthdate" 
                    class="form-input"
                  >
                </div>

                <div class="form-group">
                  <label for="gender">G√©nero</label>
                  <select x-model="formData.gender" class="form-input">
                    <option value="">Selecciona...</option>
                    <option value="male">Masculino</option>
                    <option value="female">Femenino</option>
                    <option value="other">Otro</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="blood_type">Tipo de Sangre</label>
                <select x-model="formData.blood_type" class="form-input">
                  <option value="">Selecciona...</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary" :disabled="updating">
                  <span x-show="!updating">Guardar Cambios</span>
                  <span x-show="updating">Guardando...</span>
                </button>
              </div>

              <template x-if="successMessage">
                <div class="alert alert-success" x-text="successMessage"></div>
              </template>

              <template x-if="errorMessage">
                <div class="alert alert-error" x-text="errorMessage"></div>
              </template>
            </form>
          </template>
        </section>
      </div>

      <!-- TAB 2: Cambiar Contrase√±a -->
      <div x-show="activeTab === 'password'" class="tab-content">
        <section class="form-section">
          <h2>Cambiar Contrase√±a</h2>
          
          <form @submit.prevent="updatePassword()" class="user-form">
            <div class="form-group">
              <label for="currentPassword">Contrase√±a Actual</label>
              <input 
                id="currentPassword" 
                name="currentPassword"
                type="password" 
                x-model="passwordForm.currentPassword" 
                placeholder="Tu contrase√±a actual"
                class="form-input"
                required
              >
              <template x-if="passwordErrors.currentPassword">
                <span class="error-text" x-text="passwordErrors.currentPassword[0]"></span>
              </template>
            </div>

            <div class="form-group">
              <label for="newPassword">Nueva Contrase√±a</label>
              <input 
                id="newPassword" 
                name="newPassword"
                type="password" 
                x-model="passwordForm.newPassword" 
                placeholder="Tu nueva contrase√±a (m√≠nimo 8 caracteres)"
                class="form-input"
                required
                minlength="8"
              >
              <template x-if="passwordErrors.newPassword">
                <span class="error-text" x-text="passwordErrors.newPassword[0]"></span>
              </template>
              <template x-if="passwordForm.newPassword && passwordForm.newPassword.length >= 8">
                <span class="success-text" style="display: block; margin-top: 0.5rem; color: #10b981; font-size: 0.875rem;">‚úì Longitud v√°lida</span>
              </template>
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirmar Nueva Contrase√±a</label>
              <input 
                id="confirmPassword" 
                name="confirmPassword"
                type="password" 
                x-model="passwordForm.confirmPassword" 
                placeholder="Confirma tu nueva contrase√±a"
                class="form-input"
                required
              >
              <template x-if="!passwordsMatch && passwordForm.confirmPassword">
                <span class="error-text">‚úó Las contrase√±as no coinciden</span>
              </template>
              <template x-if="passwordsMatch && passwordForm.confirmPassword && passwordForm.newPassword">
                <span class="success-text" style="display: block; margin-top: 0.5rem; color: #10b981; font-size: 0.875rem;">‚úì Las contrase√±as coinciden</span>
              </template>
            </div>

            <div class="form-actions">
              <button 
                type="submit" 
                class="btn-primary" 
                :disabled="updatingPassword || !passwordsMatch || !passwordForm.currentPassword || !passwordForm.newPassword || !passwordForm.confirmPassword || passwordForm.newPassword.length < 8"
              >
                <span x-show="!updatingPassword">Cambiar Contrase√±a</span>
                <span x-show="updatingPassword">Cambiando...</span>
              </button>
            </div>

            <template x-if="passwordForm.newPassword && passwordForm.newPassword.length < 8">
              <div class="alert alert-warning" style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; color: #856404; border-radius: 0.5rem; font-size: 0.875rem;">
                ‚ö†Ô∏è La contrase√±a debe tener al menos 8 caracteres
              </div>
            </template>

            <template x-if="passwordSuccessMessage">
              <div class="alert alert-success" x-text="passwordSuccessMessage"></div>
            </template>

            <template x-if="passwordErrorMessage">
              <div class="alert alert-error" x-text="passwordErrorMessage"></div>
            </template>
          </form>
        </section>
      </div>
    </main>
  </div>
</StudentLayout>

<script>
  function profileManager() {
    return {
      activeTab: 'datos',
      loading: true,
      updating: false,
      updatingPassword: false,
      
      formData: {
        name: '',
        last_name: '',
        email: '',
        phone_number: '',
        birthdate: '',
        gender: '',
        blood_type: ''
      },
      
      passwordForm: {
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
      },
      
      errors: {},
      passwordErrors: {},
      successMessage: '',
      errorMessage: '',
      passwordSuccessMessage: '',
      passwordErrorMessage: '',

      get passwordsMatch() {
        return this.passwordForm.newPassword === this.passwordForm.confirmPassword;
      },

      async init() {
        const token = localStorage.getItem('token');
        if (!token) {
          this.errorMessage = 'No est√°s autenticado. Por favor inicia sesi√≥n.';
          this.loading = false;
          return;
        }

        try {
          const response = await fetch('https://nginx-production-728f.up.railway.app/api/v1/users/user', {
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            const user = data.data.user;
            
            this.formData = {
              name: user.name || '',
              last_name: user.last_name || '',
              email: user.email || '',
              phone_number: user.phone_number || '',
              birthdate: user.birthdate ? user.birthdate.split('T')[0] : '',
              gender: user.gender || '',
              blood_type: user.blood_type || ''
            };

            console.log('‚úÖ Datos del usuario cargados:', this.formData);
          } else {
            this.errorMessage = 'No se pudieron cargar los datos del usuario';
          }
        } catch (err) {
          console.error('Error al cargar perfil:', err);
          this.errorMessage = 'Error al conectar con el servidor';
        } finally {
          this.loading = false;
        }
      },

      async updateProfile() {
        this.updating = true;
        this.successMessage = '';
        this.errorMessage = '';
        this.errors = {};

        const token = localStorage.getItem('token');

        try {
          const response = await fetch('https://nginx-production-728f.up.railway.app/api/v1/users/update', {
            method: 'PATCH',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(this.formData)
          });

          const data = await response.json();

          if (response.ok) {
            this.successMessage = data.message || 'Perfil actualizado correctamente';
            console.log('‚úÖ Perfil actualizado:', data);
            
            // Actualizar localStorage
            const userData = data.data.user;
            localStorage.setItem('userName', userData.name + ' ' + userData.last_name);
            localStorage.setItem('userData', JSON.stringify(userData));
          } else {
            if (data.errors) {
              this.errors = data.errors;
              const firstError = Object.values(data.errors)[0];
              this.errorMessage = Array.isArray(firstError) ? firstError[0] : firstError;
            } else {
              this.errorMessage = data.message || 'Error al actualizar perfil';
            }
          }
        } catch (err) {
          console.error('Error updating profile:', err);
          this.errorMessage = 'Error al conectar con el servidor';
        } finally {
          this.updating = false;
        }
      },

      async updatePassword() {
        console.log('üîê Iniciando cambio de contrase√±a...');
        
        // Validaciones
        if (!this.passwordForm.currentPassword) {
          this.passwordErrorMessage = 'Debes ingresar tu contrase√±a actual';
          return;
        }
        
        if (!this.passwordForm.newPassword) {
          this.passwordErrorMessage = 'Debes ingresar una nueva contrase√±a';
          return;
        }
        
        if (this.passwordForm.newPassword.length < 8) {
          this.passwordErrorMessage = 'La nueva contrase√±a debe tener al menos 8 caracteres';
          return;
        }
        
        if (!this.passwordsMatch) {
          this.passwordErrorMessage = 'Las contrase√±as no coinciden';
          return;
        }

        this.updatingPassword = true;
        this.passwordSuccessMessage = '';
        this.passwordErrorMessage = '';
        this.passwordErrors = {};

        const token = localStorage.getItem('token');
        
        if (!token) {
          this.passwordErrorMessage = 'No est√°s autenticado. Por favor inicia sesi√≥n.';
          this.updatingPassword = false;
          return;
        }
        
        console.log('üì§ Enviando solicitud al servidor...');
        console.log('Current password length:', this.passwordForm.currentPassword.length);
        console.log('New password length:', this.passwordForm.newPassword.length);

        try {
          const response = await fetch('https://nginx-production-728f.up.railway.app/api/v1/users/update/password', {
            method: 'PATCH',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              currentPassword: this.passwordForm.currentPassword,
              newPassword: this.passwordForm.newPassword
            })
          });

          const data = await response.json();
          console.log('üì• Respuesta del servidor:', data);
          console.log('Status code:', response.status);

          if (response.ok) {
            this.passwordSuccessMessage = data.message || 'Contrase√±a actualizada correctamente';
            this.passwordForm = {
              currentPassword: '',
              newPassword: '',
              confirmPassword: ''
            };
            console.log('‚úÖ Contrase√±a actualizada exitosamente');
            
            // Mostrar alerta de √©xito
            setTimeout(() => {
              this.passwordSuccessMessage = '';
            }, 5000);
          } else {
            console.error('‚ùå Error en la respuesta:', data);
            
            if (data.errors) {
              this.passwordErrors = data.errors;
              const firstError = Object.values(data.errors)[0];
              this.passwordErrorMessage = Array.isArray(firstError) ? firstError[0] : firstError;
            } else {
              this.passwordErrorMessage = data.message || 'Error al cambiar contrase√±a';
            }
            
            // Si es error 400, probablemente la contrase√±a actual es incorrecta
            if (response.status === 400) {
              this.passwordErrorMessage = 'La contrase√±a actual es incorrecta';
            }
          }
        } catch (err) {
          console.error('Error updating password:', err);
          this.passwordErrorMessage = 'Error al conectar con el servidor';
        } finally {
          this.updatingPassword = false;
        }
      }
    };
  }
</script>

<style>
  :root {
    --primary: #2E594D;
    --primary-light: #e9f0ee;
    --text-main: #111827;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --danger: #ef4444;
    --success: #10b981;
    --bg-page: #f8fafc;
  }

  .profile-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
    background: var(--bg-page);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* --- STUDENT NAVIGATION --- */
  .student-nav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: linear-gradient(to right, var(--primary), #1f7f5c);
    padding: 1rem 0;
    border-radius: 0.75rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(46, 89, 77, 0.15);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #fff;
    transition: all 0.3s ease;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
  }

  .nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .nav-icon {
    width: 1.5rem;
    height: 1.5rem;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }

  .nav-link span {
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .profile-header {
    margin-bottom: 2rem;
  }

  .profile-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-main);
    margin: 0;
  }

  .subtitle {
    color: var(--text-muted);
    margin: 0.5rem 0 0 0;
    font-size: 1rem;
  }

  .profile-content {
    background: white;
    border-radius: 1.5rem;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  .tabs-nav {
    display: flex;
    border-bottom: 1px solid var(--border-color);
  }

  .tab-btn {
    flex: 1;
    padding: 1.5rem;
    background: transparent;
    border: none;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .tab-btn:hover {
    color: var(--primary);
    background: rgba(46, 89, 77, 0.02);
  }

  .tab-btn.active {
    color: var(--primary);
  }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary);
  }

  .tab-content {
    display: block;
  }

  .form-section {
    padding: 2rem;
  }

  .form-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-main);
    margin: 0 0 2rem 0;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .form-input {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.1);
  }

  .error-text {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-primary {
    padding: 0.875rem 2rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
  }

  .btn-primary:hover:not(:disabled) {
    background: #1f3f38;
    box-shadow: 0 4px 12px rgba(46, 89, 77, 0.3);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .alert {
    padding: 1rem;
    border-radius: 0.75rem;
    margin-top: 1rem;
    font-weight: 500;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border-left: 4px solid var(--success);
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border-left: 4px solid var(--danger);
  }

  .loading-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .profile-container {
      padding: 1rem;
    }

    .profile-header h1 {
      font-size: 1.75rem;
    }

    .form-section {
      padding: 1.5rem;
    }

    .tabs-nav {
      flex-direction: column;
    }

    .tab-btn {
      border-bottom: 1px solid var(--border-color);
    }

    .tab-btn.active::after {
      bottom: auto;
      top: 0;
      height: 3px;
    }
  }
</style>
