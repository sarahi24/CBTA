---
import StudentLayout from '../../layouts/LayoutEstu.astro';
import { API_ENDPOINTS } from '../../config/api.js';

let tarjetasIniciales = [];
const title = "Mis M√©todos de Pago";
// No intentar acceder a localStorage en el servidor - se har√° todo en el cliente
---

<StudentLayout title={title}>
  <div 
    class="page-wrapper"
    x-data={`{ 
      showModal: false,
      alumno: 'Usuario',
      tarjetas: [],
      form: { numero: '', titular: '', mes: '', anio: '', cvv: '' },

      // 1. Cargar tarjetas al iniciar
      async init() {
        // Obtener datos del usuario desde localStorage de forma m√°s robusta
        const userName = localStorage.getItem('userName');
        const userDataStr = localStorage.getItem('userData');
        
        if (userName && userName !== 'Usuario' && userName !== 'Estudiante') {
          this.alumno = userName;
        } else if (userDataStr) {
          try {
            const userData = JSON.parse(userDataStr);
            this.alumno = userData.fullName || userData.name || 'Usuario';
          } catch (e) {
            this.alumno = 'Usuario';
          }
        } else {
          this.alumno = 'Usuario';
        }
        
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
        
        console.log('üîç [Tarjetas] Nombre cargado:', this.alumno);
        console.log('üîç [Tarjetas] Token disponible:', !!token);
        console.log('üîç [Tarjetas] UserId:', userId);
        
        // Cargar tarjetas desde API
        if (token && userId) {
          try {
            const response = await fetch('https://nginx-production-728f.up.railway.app/api/v1/cards/' + userId, {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            if (response.ok) {
              const cardsData = await response.json();
              this.tarjetas = Array.isArray(cardsData) ? cardsData.map(card => ({
                id: card.id,
                tipo: card.brand || 'Tarjeta',
                terminacion: card.last4 || card.terminacion || '****',
                vencimiento: card.exp_month && card.exp_year ? (String(card.exp_month).padStart(2, '0') + '/' + String(card.exp_year).slice(-2)) : card.vencimiento || 'N/A',
                logo: card.brand === 'visa' ? 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg' : 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg'
              })) : [];
              this.actualizarStorage();
            }
          } catch (err) {
            console.error('Error al cargar tarjetas:', err);
          }
        }
        
        // Si no hay tarjetas de API, cargar desde localStorage
        if (this.tarjetas.length === 0) {
          const guardadas = localStorage.getItem('mis_tarjetas');
          if (guardadas) {
            this.tarjetas = JSON.parse(guardadas);
          }
        }
      },

      actualizarStorage() {
        localStorage.setItem('mis_tarjetas', JSON.stringify(this.tarjetas));
      },

      formatCardNumber(value) {
        return value.replace(/\\D/g, '').replace(/(.{4})/g, '$1 ').trim();
      },

      get cardType() {
        const num = this.form.numero.replace(/\\s/g, '');
        if (num.startsWith('4')) return 'Visa';
        if (num.startsWith('5')) return 'Mastercard';
        return '';
      },

      guardarTarjeta() {
        const numLimpio = this.form.numero.replace(/\\s/g, '');
        if (numLimpio.length < 15) return alert('N√∫mero de tarjeta no v√°lido');
        
        const token = localStorage.getItem('token');
        const cardPayload = {
          number: numLimpio,
          holder_name: this.form.titular,
          exp_month: parseInt(this.form.mes),
          exp_year: parseInt('20' + this.form.anio),
          cvv: this.form.cvv
        };

        fetch('https://nginx-production-728f.up.railway.app/api/v1/cards', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(cardPayload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            // Card saved successfully, add to local list
            const nueva = {
              id: data.id,
              tipo: this.cardType || 'Tarjeta',
              terminacion: numLimpio.slice(-4),
              vencimiento: this.form.mes + '/' + this.form.anio,
              logo: this.cardType === 'Visa' 
                ? 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg' 
                : 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg'
            };
            
            this.tarjetas.push(nueva);
            this.actualizarStorage();
            this.showModal = false;
            this.form = { numero: '', titular: '', mes: '', anio: '', cvv: '' };
          } else {
            alert('Error al guardar la tarjeta. Intenta de nuevo.');
          }
        })
        .catch(err => {
          console.error('Error saving card:', err);
          alert('Error al conectar con el servidor');
        });
      },

      eliminarTarjeta(id) {
        const token = localStorage.getItem('token');
        if (!confirm('¬øEst√°s seguro de que deseas eliminar esta tarjeta?')) return;

        fetch('https://nginx-production-728f.up.railway.app/api/v1/cards/' + id, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        })
        .then(res => {
          if (res.ok) {
            this.tarjetas = this.tarjetas.filter(t => t.id !== id);
            this.actualizarStorage();
          } else {
            alert('Error al eliminar la tarjeta');
          }
        })
        .catch(err => {
          console.error('Error deleting card:', err);
          alert('Error al conectar con el servidor');
        });
      }
    }`}
  >
    <header class="main-header">
      <div class="header-content">
        <div class="user-profile">
          <div class="avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="svg-icon">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="welcome-text">
            <span class="greeting">M√©todos de Pago</span>
            <h1 x-text="`Hola, ${alumno.split(' ')[0]}`"></h1>
          </div>
        </div>
        <div class="balance-summary">
          <span class="label">Tarjetas Vinculadas</span>
          <span class="amount" x-text="tarjetas.length"></span>
        </div>
      </div>
    </header>

    <main class="content-grid">
      <section class="section-container">
        <div class="section-header">
          <h2 class="section-title">Mis Tarjetas</h2>
          <button @click="showModal = true" class="add-inline-btn">
            + A√±adir Nueva
          </button>
        </div>

        <div class="cards-stack">
          <template x-for="tarjeta in tarjetas" :key="tarjeta.id">
            <div class="modern-card">
              <div class="card-left">
                <div class="bank-logo-container">
                   <img :src="tarjeta.logo" alt="logo" class="bank-logo">
                </div>
                <div class="details">
                  <h3 x-text="'‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + tarjeta.terminacion"></h3>
                  <p class="date">
                    <span x-text="tarjeta.tipo"></span> | Exp: <span x-text="tarjeta.vencimiento"></span>
                  </p>
                </div>
              </div>
              <button @click="eliminarTarjeta(tarjeta.id)" class="delete-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </template>

          <template x-if="tarjetas.length === 0">
            <div class="empty-state" @click="showModal = true" style="text-align: center; padding: 3rem; background: white; border-radius: 24px; cursor: pointer; border: 2px dashed #e2e8f0;">
                <p style="color: #64748b; font-weight: 600;">No tienes tarjetas registradas. Toca para a√±adir una.</p>
            </div>
          </template>
        </div>
      </section>
    </main>

    <div x-show="showModal" x-cloak class="modal-overlay">
      <div class="modal-backdrop" @click="showModal = false" x-show="showModal" x-transition.opacity></div>
      <div class="modal-sheet" x-show="showModal" x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-y-full md:translate-y-4 md:opacity-0" x-transition:enter-end="translate-y-0 md:translate-y-0 md:opacity-100">
        <div class="sheet-handle"></div>
        <div class="sheet-body">
          <div class="payment-header">
            <h2 class="grand-total">Nueva Tarjeta</h2>
            <p class="subtitle">Ingresa los datos de tu m√©todo de pago</p>
          </div>
          <div class="card-form-grid">
            <div class="input-field">
              <label for="card-numero">N√∫mero de Tarjeta</label>
              <div class="input-wrapper">
                <input id="card-numero" name="cardNumero" type="text" x-model="form.numero" @input="form.numero = formatCardNumber($event.target.value)" maxlength="19" inputmode="numeric" placeholder="0000 0000 0000 0000">
                <span class="card-hint" x-text="cardType"></span>
              </div>
            </div>
            <div class="input-field">
              <label for="card-titular">Titular</label>
              <input id="card-titular" name="cardTitular" type="text" x-model="form.titular" placeholder="NOMBRE COMPLETO" class="uppercase">
            </div>
            <div class="input-row">
              <div class="input-field">
                <label for="card-mes">Vencimiento</label>
                <div class="expiry-group">
                    <input id="card-mes" name="cardMes" type="text" x-model="form.mes" placeholder="MM" maxlength="2" inputmode="numeric">
                    <span class="sep">/</span>
                    <input id="card-anio" name="cardAnio" type="text" x-model="form.anio" placeholder="AA" maxlength="2" inputmode="numeric">
                </div>
              </div>
              <div class="input-field">
                <label for="card-cvv">CVV</label>
                <input id="card-cvv" name="cardCvv" type="password" x-model="form.cvv" placeholder="***" maxlength="3" inputmode="numeric">
              </div>
            </div>
            <div class="button-group">
                <button @click="guardarTarjeta()" class="btn-primary-action">VINCULAR TARJETA</button>
                <button @click="showModal = false" class="btn-secondary-action">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</StudentLayout>

<style>
  /* [Tus estilos CSS se mantienen iguales] */
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
  :root { --primary: #112d26; --accent: #c4a47c; --bg: #f9fbfb; --white: #ffffff; --text-muted: #64748b; --shadow: 0 12px 34px -10px rgba(17, 45, 38, 0.12); }
  .page-wrapper { max-width: 1000px; margin: 0 auto; padding: 2.5rem 1.5rem; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); min-height: 100vh; }
  .main-header { background: var(--primary); border-radius: 28px; padding: 2.5rem; color: white; margin-bottom: 2.5rem; box-shadow: 0 20px 40px -15px rgba(17, 45, 38, 0.3); }
  .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
  .user-profile { display: flex; align-items: center; gap: 1.5rem; }
  .avatar { width: 64px; height: 64px; background: var(--accent); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: var(--primary); flex-shrink: 0; }
  .svg-icon { width: 32px; height: 32px; }
  .welcome-text h1 { margin: 0; font-size: 1.8rem; font-weight: 800; }
  .greeting { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.7; font-weight: 700; }
  .balance-summary { background: rgba(255, 255, 255, 0.08); padding: 1rem 1.5rem; border-radius: 22px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
  .balance-summary .label { font-size: 0.75rem; opacity: 0.6; display: block; }
  .balance-summary .amount { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
  .section-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); }
  .add-inline-btn { background: var(--primary); color: white; border: none; padding: 0.7rem 1.2rem; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
  .modern-card { background: var(--white); border-radius: 24px; padding: 1.2rem 1.5rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; box-shadow: var(--shadow); }
  .card-left { display: flex; align-items: center; gap: 1.2rem; }
  .bank-logo-container { width: 55px; height: 35px; background: #f8fafc; border-radius: 8px; display: flex; padding: 4px; }
  .bank-logo { width: 100%; object-fit: contain; }
  .details h3 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: 800; }
  .date { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
  .delete-btn { background: #fff1f1; color: #ff4d4d; border: none; padding: 10px; border-radius: 12px; cursor: pointer; }
  .modal-overlay { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
  .modal-backdrop { position: absolute; inset: 0; background: rgba(17, 45, 38, 0.4); backdrop-filter: blur(6px); }
  .modal-sheet { position: relative; background: white; width: 100%; max-width: 480px; border-radius: 32px; overflow: hidden; z-index: 10; }
  .sheet-handle { width: 40px; height: 4px; background: #e2e8f0; border-radius: 10px; margin: 12px auto 0; display: none; }
  .sheet-body { padding: 2.2rem; }
  .payment-header { text-align: center; margin-bottom: 1.8rem; }
  .grand-total { font-size: 1.6rem; font-weight: 800; color: var(--primary); margin: 0; }
  .subtitle { font-size: 0.85rem; color: var(--text-muted); }
  .card-form-grid { display: flex; flex-direction: column; gap: 1.2rem; }
  .input-field label { display: block; font-size: 0.75rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 6px; }
  .input-field input { width: 100%; padding: 1rem; border: 2px solid #f1f5f9; border-radius: 14px; background: #f8fafc; font-size: 1rem; font-weight: 600; transition: 0.2s; }
  .input-field input:focus { border-color: var(--accent); outline: none; background: white; }
  .input-wrapper { position: relative; }
  .card-hint { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; font-weight: 800; color: var(--accent); }
  .expiry-group { display: flex; align-items: center; background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 14px; padding: 0 10px; }
  .expiry-group input { border: none; text-align: center; background: transparent; }
  .expiry-group .sep { color: #cbd5e1; font-weight: bold; }
  .input-row { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 1rem; }
  .button-group { display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem; }
  .btn-primary-action { background: var(--primary); color: white; padding: 1.1rem; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; }
  .btn-secondary-action { background: transparent; color: var(--text-muted); border: none; font-weight: 700; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }

  @media (max-width: 768px) {
    .page-wrapper { padding: 1rem 0.5rem; }
    .main-header { padding: 1.2rem; }
    .modal-overlay { align-items: flex-end; }
    .modal-sheet { border-radius: 24px 24px 0 0; max-width: 100%; }
    .sheet-handle { display: block; }
  }

  [x-cloak] { display: none !important; }
</style>

<script>
  // Script para actualizar el nombre del usuario en tiempo real
  document.addEventListener('DOMContentLoaded', () => {
    const userNameFromStorage = localStorage.getItem('userName');
    console.log('üìù [Tarjetas] Nombre en localStorage:', userNameFromStorage);
    
    // Intentar encontrar el elemento Alpine y actualizar
    const xData = document.querySelector('[x-data]');
    if (xData && userNameFromStorage && userNameFromStorage !== 'Estudiante' && userNameFromStorage !== 'Usuario') {
      // El Alpine.js deber√≠a haber cargado el nombre en init()
      console.log('‚úÖ [Tarjetas] Alpine.js deber√≠a mostrar:', userNameFromStorage);
    }
  });
  
  // Listener para cambios en localStorage
  window.addEventListener('storage', (e) => {
    if (e.key === 'userName') {
      console.log('üîÑ [Tarjetas] Nombre del usuario cambi√≥ a:', e.newValue);
      // Recargar la p√°gina para reflejar el nuevo usuario
      location.reload();
    }
  });
</script>

<script>
  // Debug script para verificar localStorage
  document.addEventListener('alpine:init', () => {
    console.log('üîç Alpine.js inicializado en Tarjetas');
    console.log('üîç userName en localStorage:', localStorage.getItem('userName'));
    console.log('üîç userId en localStorage:', localStorage.getItem('userId'));
  });
</script>