---
// src/pages/pago_estado.astro
import Layout from "../layouts/Layout.astro"; 

const pageTitle = "Historial de Pagos - CBTA 71";

// Configuración de Carreras para el mapeo de nombres en Excel
const CAREER_MAP = {
  'TAG-E': 'Técnico Agropecuario',
  'TOF': 'Técnico en Ofimática',
  'TEM': 'Técnico en Admón. de Emprendimiento',
  'TAG-M': 'Técnico Agropecuario (Mixta)',
  'TRH': 'Técnico en Admón. de Recursos Humanos (Mixta)',
  '': 'Sin Carrera'
};

let students = [];
try {
    const res = await fetch('/api/students');
    if (res.ok) {
        const json = await res.json();
        students = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    }
} catch (e) {}

if (!students.length) {
    try {
        const mod = await import('../data/students.js'); 
        students = mod.default || mod.students || [];
    } catch (e) {
        students = [];
    }
}

const safeStudents = students.map((s, i) => ({
    id: s.id ?? String(i + 1),
    numControl: s.numControl ?? s.id ?? '',
    nombre: s.nombre ?? s.name ?? '',
    apellidoP: s.apellidoP ?? s.apellidoPaterno ?? '',
    apellidoM: s.apellidoM ?? s.apellidoMaterno ?? '',
    semestre: s.semestre ?? '1',
    carrera: s.carrera ?? '',
}));

const studentsJSON = JSON.stringify(safeStudents).replace(/</g, '\\u003c');
const careerMapJSON = JSON.stringify(CAREER_MAP);
---

<Layout title={pageTitle}>
<style is:global>
    :root { --cbta-green: #2E594D; }
    
    .page-link {
        width: 2.5rem; height: 2.5rem;
        display: flex; align-items: center; justify-content: center;
        border-radius: 0.75rem; border: 1px solid #f3f4f6;
        color: #9ca3af; transition: all 0.2s;
        background: white; cursor: pointer; font-weight: 700;
    }
    .page-link.active {
        background-color: #2E594D; color: white; border-color: #2E594D;
    }

    .filter-card {
        position: absolute; top: 100%; right: 0; margin-top: 0.5rem;
        width: 18rem; background: white; border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        border: 1px solid #f3f4f6; padding: 1.25rem;
        z-index: 50; display: none;
    }
    .filter-card.show { display: block; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous" defer></script>

<div class="max-w-7xl mx-auto px-6 py-10 bg-white min-h-screen">

    <div class="flex items-center gap-5 mb-8">
        <div class="w-16 h-16 bg-[#eaf1ef] rounded-2xl flex items-center justify-center border-2 border-[#2E594D] shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2E594D" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        </div>
        <div>
            <h1 class="text-3xl font-black text-gray-800 tracking-tight leading-none">Historial de Pagos Realizados</h1>
            <p class="text-gray-500 font-medium mt-1">Panel de control y auditoría financiera</p>
        </div>
    </div>

    <div class="flex flex-row items-center gap-3 mb-8 w-full">
        <div class="relative flex-grow">
            <input type="text" id="search-input" placeholder="Buscar por nombre, matrícula o concepto..." class="w-full pl-12 pr-4 h-[46px] bg-gray-50 border border-gray-200 rounded-xl text-sm text-gray-700 focus:ring-2 focus:ring-[#2E594D] focus:bg-white outline-none transition-all shadow-sm" />
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>

        <div class="flex items-center gap-2 relative">
            <button id="toggle-filters" class="flex items-center gap-2 px-5 h-[46px] border-2 border-[#2E594D] text-[#2E594D] font-bold text-sm rounded-xl hover:bg-[#2E594D] hover:text-white transition-all shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filtros
            </button>
            <button id="export-xlsx" class="flex items-center gap-2 px-5 h-[46px] bg-emerald-700 text-white font-bold text-sm rounded-xl hover:bg-emerald-800 transition-all shadow-lg active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                EXPORTAR REPORTE
            </button>

            <div id="filter-menu" class="filter-card">
                <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Opciones de Filtrado</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Semestre:</label>
                        <select id="semester-filter" class="w-full mt-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-[#2E594D]">
                            <option value="all">Todos</option>
                            {[...Array(10)].map((_, i) => ( <option value={i + 1}>{i + 1}º Semestre</option> ))}
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Método:</label>
                        <select id="method-filter" class="w-full mt-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-[#2E594D]">
                            <option value="all">Todos</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Depósito">Depósito</option>
                        </select>
                    </div>
                    <button id="clear-filters" class="w-full mt-2 p-2 bg-red-50 text-red-500 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors">Limpiar Filtros</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden mb-8">
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-[#2E594D] text-white">
                        <th class="px-6 py-5 text-left text-xs font-black uppercase tracking-widest">Fecha</th>
                        <th class="px-6 py-5 text-left text-xs font-black uppercase tracking-widest">Concepto de Pago</th>
                        <th class="px-6 py-5 text-left text-xs font-black uppercase tracking-widest">Estudiante</th>
                        <th class="px-6 py-5 text-left text-xs font-black uppercase tracking-widest">Método</th>
                        <th class="px-6 py-5 text-right text-xs font-black uppercase tracking-widest">Monto</th>
                    </tr>
                </thead>
                <tbody id="payments-table-body" class="divide-y divide-gray-50"></tbody>
            </table>
        </div>
    </div>

    <div class="flex flex-col items-center gap-4 py-4">
        <p class="text-slate-500 text-sm font-medium">Registros: <span id="p-total" class="font-bold text-slate-800">0</span></p>
        <div class="flex items-center gap-2" id="pagination-controls"></div>
    </div>
</div>

<script is:inline define:vars={{ studentsJSON, careerMapJSON }}>
window.__INITIAL_STUDENTS_PAYMENTS = JSON.parse(studentsJSON);
window.__CAREER_MAP = JSON.parse(careerMapJSON);
</script>

<script type="module">
(function() {
    let currentPage = 1;
    const itemsPerPage = 50;
    let filteredData = [];

    const tableBody = document.getElementById('payments-table-body');
    const searchInput = document.getElementById('search-input');
    const filterMenu = document.getElementById('filter-menu');
    const btnExport = document.getElementById('export-xlsx');

    document.getElementById('toggle-filters').onclick = (e) => { e.stopPropagation(); filterMenu.classList.toggle('show'); };
    document.onclick = () => filterMenu.classList.remove('show');
    filterMenu.onclick = (e) => e.stopPropagation();

    const render = () => {
        const students = JSON.parse(localStorage.getItem('studentsList') || '[]') || window.__INITIAL_STUDENTS_PAYMENTS;
        const allCharges = JSON.parse(localStorage.getItem('chargesList') || '[]').filter(c => 
            ['paid', 'pagado'].includes(String(c.status || '').toLowerCase())
        );

        const term = searchInput.value.toLowerCase();
        const semesterSel = document.getElementById('semester-filter').value;
        const methodSel = document.getElementById('method-filter').value;

        filteredData = allCharges.filter(p => {
            const s = students.find(x => String(x.id) === String(p.studentId) || String(x.numControl) === String(p.studentId));
            if(!s) return false;
            
            const conceptoReal = p.conceptTitle || p.conceptName || p.conceptText || p.concept || p.title || 'PAGO GENERAL';
            const fullName = `${s.nombre} ${s.apellidoP} ${s.apellidoM}`.toLowerCase();
            
            const matchesSearch = fullName.includes(term) || String(s.numControl).includes(term) || conceptoReal.toLowerCase().includes(term);
            const matchesSemester = semesterSel === 'all' || String(s.semestre) === semesterSel;
            const matchesMethod = methodSel === 'all' || p.paymentMethod === methodSel;
            
            return matchesSearch && matchesSemester && matchesMethod;
        });

        const startIdx = (currentPage - 1) * itemsPerPage;
        const pageItems = filteredData.slice(startIdx, startIdx + itemsPerPage);

        tableBody.innerHTML = pageItems.map(p => {
            const s = students.find(x => String(x.id) === String(p.studentId) || String(x.numControl) === String(p.studentId));
            const displayConcept = p.conceptTitle || p.conceptName || p.conceptText || p.concept || p.title || 'PAGO REGISTRADO';

            return `
                <tr class="hover:bg-gray-50/50 transition-colors">
                    <td class="px-6 py-5 text-gray-500 font-mono text-xs">${new Date(p.paidAt || p.date).toLocaleDateString('es-MX')}</td>
                    <td class="px-6 py-5">
                        <span class="text-gray-900 font-extrabold text-xs uppercase block" style="letter-spacing: -0.01em;">
                            ${displayConcept}
                        </span>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex flex-col">
                            <span class="text-gray-800 font-bold text-xs uppercase leading-tight">${s.nombre} ${s.apellidoP} ${s.apellidoM}</span>
                            <span class="text-[9px] text-gray-400 font-mono">${s.numControl}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-[10px] font-bold text-gray-400 uppercase">${p.paymentMethod || 'EFECTIVO'}</td>
                    <td class="px-6 py-5 text-right font-black text-[#2E594D] text-sm">
                        $${Number(p.amount).toLocaleString('es-MX', {minimumFractionDigits:2})}
                    </td>
                </tr>
            `;
        }).join('');

        document.getElementById('p-total').textContent = filteredData.length;
        renderPagination(Math.ceil(filteredData.length / itemsPerPage));
    };

    const renderPagination = (totalPages) => {
        const controls = document.getElementById('pagination-controls');
        if(totalPages <= 1) { controls.innerHTML = ''; return; }
        let html = '';
        for(let i=1; i<=totalPages; i++) {
            html += `<button class="page-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }
        controls.innerHTML = html;
        controls.querySelectorAll('button').forEach(b => {
            b.onclick = () => { currentPage = parseInt(b.dataset.page); render(); };
        });
    };

    // --- NUEVA LÓGICA DE EXPORTACIÓN POR CARRERAS ---
    btnExport.onclick = () => {
        if(filteredData.length === 0) return alert("No hay datos para exportar");
        
        const students = JSON.parse(localStorage.getItem('studentsList') || '[]') || window.__INITIAL_STUDENTS_PAYMENTS;
        const CAREER_MAP = window.__CAREER_MAP;
        const wb = XLSX.utils.book_new();

        // 1. Identificar las carreras únicas presentes en los resultados filtrados
        const uniqueCareers = [...new Set(filteredData.map(p => {
            const s = students.find(x => String(x.id) === String(p.studentId) || String(x.numControl) === String(p.studentId));
            return s ? s.carrera : '';
        }))];

        // 2. Crear una pestaña por cada carrera
        uniqueCareers.forEach(careerCode => {
            const paymentsInCareer = filteredData.filter(p => {
                const s = students.find(x => String(x.id) === String(p.studentId) || String(x.numControl) === String(p.studentId));
                return s && s.carrera === careerCode;
            });

            // Ordenar por semestre y luego por nombre
            const sortedPayments = paymentsInCareer.sort((a, b) => {
                const sA = students.find(x => String(x.id) === String(a.studentId) || String(x.numControl) === String(a.studentId));
                const sB = students.find(x => String(x.id) === String(b.studentId) || String(x.numControl) === String(b.studentId));
                return (sA.semestre - sB.semestre) || `${sA.nombre}`.localeCompare(`${sB.nombre}`);
            });

            const exportData = sortedPayments.map(p => {
                const s = students.find(x => String(x.id) === String(p.studentId) || String(x.numControl) === String(p.studentId));
                return {
                    'Fecha': new Date(p.paidAt || p.date).toLocaleDateString('es-MX'),
                    'Semestre': s.semestre + 'º',
                    'Matrícula': s.numControl,
                    'Estudiante': `${s.nombre} ${s.apellidoP} ${s.apellidoM}`,
                    'Concepto': p.conceptTitle || p.conceptName || p.concept || p.title || 'PAGO',
                    'Método': p.paymentMethod || 'Efectivo',
                    'Monto ($)': Number(p.amount)
                };
            });

            if (exportData.length > 0) {
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Nombre de la hoja limpio y corto (Máx 31 caracteres para Excel)
                let sheetName = (CAREER_MAP[careerCode] || careerCode || 'General')
                    .replace(/[\\*?:/\[\]]/g, '')
                    .substring(0, 31);
                
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            }
        });

        XLSX.writeFile(wb, `Reporte_Pagos_CBTA71_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
    };

    searchInput.oninput = () => { currentPage = 1; render(); };
    document.getElementById('semester-filter').onchange = () => { currentPage = 1; render(); };
    document.getElementById('method-filter').onchange = () => { currentPage = 1; render(); };
    document.getElementById('clear-filters').onclick = () => { 
        searchInput.value = ''; 
        document.getElementById('semester-filter').value = 'all'; 
        document.getElementById('method-filter').value = 'all'; 
        render(); 
    };

    render();
})();
</script>
</Layout>