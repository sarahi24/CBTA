---
// src/pages/concepts.astro
import Layout from '../layouts/Layout.astro'; 
const pageTitle = "Conceptos de Cobro"; 

const PRIMARY_ACCENT_COLOR = 'bg-[#2E584C]'; 
const PRIMARY_HOVER = 'hover:bg-[#274D43]'; 
const PRIMARY_TEXT_COLOR = 'text-[#2E584C]'; 
const API_BASE_URL = 'https://nginx-production-728f.up.railway.app/api';
---

<Layout title={pageTitle}>  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-10 bg-gray-50 min-h-screen">

  
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-gray-300">
      <div class="flex items-start">
        <div class={`p-3 ${PRIMARY_ACCENT_COLOR} rounded-lg shadow-xl mr-4 flex-shrink-0`}>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>

        <div>
          <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Gestión de Conceptos de Cobro</h1>
          <p class="text-md text-gray-500 mt-1">Definición y asignación de adeudos a grupos de estudiantes.</p>
        </div>
      </div>

      <a href="/new"
         class={`mt-4 sm:mt-0 px-6 py-2.5 ${PRIMARY_ACCENT_COLOR} text-white font-semibold rounded-lg shadow-lg ${PRIMARY_HOVER} transition-colors duration-300 text-sm sm:text-base`}>
        <i class="fas fa-plus-circle mr-2"></i> Crear Nuevo Concepto
      </a>
    </header>

    <div id="concepts-grid"
         class="grid gap-6"
         style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
    </div>

  </div>

<script type="module" client:load>
const PRIMARY_TEXT_COLOR_HEX = '#2E584C';
const API_BASE = API_BASE_URL;

function escapeHtml(str=''){
  return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m]));
}

function formatCurrency(amount){
  return new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2 }).format(amount);
}

function getStatusBadge(status){
  const s = (status || '').toLowerCase();
  if (s === 'finalizado' || s === 'finalized') return '<span class="inline-block mt-1 text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold uppercase">Finalizado</span>';
  if (s === 'inactivo' || s === 'inactive') return '<span class="inline-block mt-1 text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-bold uppercase">Inactivo</span>';
  return '<span class="inline-block mt-1 text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold uppercase">Vigente</span>';
}

async function apiFetch(url, options={}) {
  const token = localStorage.getItem('access_token');
  if (!token) throw new Error('No hay token, inicia sesión');
  const res = await fetch(url, {
    ...options,
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
      ...options.headers,
    }
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    throw new Error(data.message || 'Error de API');
  }
  return data;
}

let conceptsCache = [];

async function loadConcepts(){
  const grid = document.getElementById('concepts-grid');
  if(!grid) return;
  grid.innerHTML = '<div class="col-span-full text-center py-12 bg-white rounded-xl border">Cargando...</div>';
  try {
    const data = await apiFetch(`${API_BASE}/v1/concepts?perPage=50`, {
      headers: {
        'X-User-Role': 'financial-staff',
        'X-User-Permission': 'view.concepts'
      }
    });
    conceptsCache = data?.data?.concepts?.items || [];
    renderConcepts();
  } catch(err){
    console.error(err);
    grid.innerHTML = `<div class="col-span-full text-center py-12 bg-white rounded-xl border text-red-600">${escapeHtml(err.message || 'Error al cargar')}</div>`;
  }
}

function renderConcepts(){
  const grid = document.getElementById('concepts-grid');
  if(!grid) return;
  const list = [...conceptsCache];
  if(!list.length){
    grid.innerHTML = `<div class="col-span-full text-center py-16 bg-white rounded-xl shadow-lg border border-gray-100">Sin conceptos</div>`;
    return;
  }

  grid.innerHTML = list.map(c=>{
    const amount = Number(c.amount)||0;
    const isInactive = (c.status || '').toLowerCase() !== 'activo' && (c.status || '').toLowerCase() !== 'active';
    const scopeText = (() => {
      const applies = c.applies_to || c.appliesTo || '';
      if (applies === 'todos') return 'Todos';
      if (applies === 'students') return `${(c.userIds||c.user_ids||[]).length} alumnos`; 
      if (applies === 'career' || applies === 'careers') return `${(c.careerIds||c.careers||[]).length} carreras`;
      if (applies === 'semesters' || applies === 'semester') return `${(c.semesters||[]).length} semestres`;
      return 'No definido';
    })();
    const pending = c.pendingCharges || 0;

    return `
      <div class="bg-white rounded-xl shadow-lg border ${isInactive ? 'border-amber-200 bg-amber-50/30' : 'border-gray-200'} p-5 flex flex-col justify-between transition hover:shadow-2xl">
        <div class="flex justify-between items-start mb-4">
          <div class="pr-2">
            <h3 class="font-bold text-lg text-gray-900 leading-tight line-clamp-2">${escapeHtml(c.concept_name || c.conceptName || c.title || '')}</h3>
            ${getStatusBadge(c.status)}
          </div>
          <div class="text-xl font-black text-[${PRIMARY_TEXT_COLOR_HEX}] flex-shrink-0">${formatCurrency(amount)}</div>
        </div>

        <div class="text-sm space-y-2 py-3 rounded-lg bg-white/50 border border-gray-100 px-3 mb-4">
          <div class="flex justify-between items-center">
            <span class="text-gray-500 font-medium text-xs uppercase italic">Filtro:</span>
            <span class="font-semibold text-gray-800">${scopeText}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500 font-medium text-xs uppercase italic">Vigencia:</span>
            <span class="font-semibold text-gray-800">${escapeHtml(c.start_date || '')} - ${escapeHtml(c.end_date || '')}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500 font-medium text-xs uppercase italic">Adeudos Activos:</span>
            <span class="font-bold ${pending > 0 ? 'text-red-600' : 'text-green-600'}">${pending}</span>
          </div>
        </div>

        <div class="space-y-3">
          <div class="hidden text-xs text-gray-600 bg-gray-50 p-2 rounded border mb-2" id="details-${c.id}">
              ${escapeHtml(c.description || 'Sin descripción.')}
          </div>
          
          <div class="flex gap-2">
            <button onclick="window.editConcept('${c.id}')" class="w-1/3 py-2 text-xs font-bold border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
              <i class="fas fa-edit mr-1"></i> Editar
            </button>

            ${!isInactive ? `
              <button onclick="window.finalizeConcept('${c.id}')" class="w-1/3 py-2 text-xs font-bold bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 border border-amber-200 transition">
                <i class="fas fa-check-double mr-1"></i> Finalizar
              </button>
            ` : `
              <button onclick="window.activateConcept('${c.id}')" class="w-1/3 py-2 text-xs font-bold bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 border border-emerald-200 transition">
                <i class="fas fa-play mr-1"></i> Activar
              </button>
            `}

            <button onclick="window.deleteConcept('${c.id}')" class="w-1/3 py-2 text-xs font-bold bg-red-50 text-red-600 rounded-lg hover:bg-red-100 border border-red-200 transition">
              <i class="fas fa-trash-alt mr-1"></i> Borrar
            </button>
          </div>
          
          <button onclick="document.getElementById('details-${c.id}').classList.toggle('hidden')" class="w-full text-[10px] text-gray-400 hover:text-gray-600 uppercase font-bold tracking-widest transition">
            Ver descripción <i class="fas fa-chevron-down ml-1"></i>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

async function mutateConcept(id, action){
  const endpoints = {
    finalize: `${API_BASE}/v1/concepts/${id}/finalize`,
    activate: `${API_BASE}/v1/concepts/${id}/activate`,
    disable: `${API_BASE}/v1/concepts/${id}/disable`,
    delete: `${API_BASE}/v1/concepts/${id}`
  };
  const perms = {
    finalize: 'finalize.concepts',
    activate: 'activate.concepts',
    disable: 'disable.concepts',
    delete: 'eliminate.concepts'
  };
  const method = action === 'delete' ? 'DELETE' : 'POST';
  await apiFetch(endpoints[action], {
    method,
    headers: {
      'X-User-Role': 'financial-staff',
      'X-User-Permission': perms[action]
    }
  });
  await loadConcepts();
}

/* --- EXPOSICIÓN GLOBAL --- */
window.editConcept = (id) => {
  const c = conceptsCache.find(x=>String(x.id)===String(id));
  localStorage.setItem('editingConcept', JSON.stringify({
    id: c.id,
    title: c.concept_name || c.conceptName,
    amount: c.amount,
    description: c.description,
    status: c.status,
    scopeRules: {
      allStudents: (c.applies_to || c.appliesTo) === 'todos',
      careers: c.careerIds || c.careers || [],
      semesters: c.semesters || [],
      specificStudents: c.userIds || c.user_ids || []
    }
  }));
  window.location.href = '/new?edit='+encodeURIComponent(id);
};
window.finalizeConcept = (id) => mutateConcept(id, 'finalize');
window.activateConcept = (id) => mutateConcept(id, 'activate');
window.deleteConcept = (id) => {
  if(!confirm('⚠️ ¿ELIMINAR concepto definitivamente?')) return;
  mutateConcept(id, 'delete');
};

loadConcepts();
</script>

<style>
.hidden { display:none; }
.line-clamp-2 { overflow:hidden; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; }
.col-span-full { grid-column: 1 / -1; }
</style>
</Layout>