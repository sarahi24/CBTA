---
import Layout from '../layouts/Layout.astro';
const API_BASE_URL = 'https://nginx-production-728f.up.railway.app/api';
---

<Layout title="Gesti√≥n de Usuarios | CBTA 71">
    <script is:inline src="/js/xlsx.min.js"></script>
    <script is:inline define:vars={{ API_BASE_URL }}>
        window.__API_BASE_URL__ = API_BASE_URL;
    </script>
    
    <style is:global>
        [x-cloak] { display: none !important; }
        
        .bg-institucional { background-color: #2E594D; }
        .text-institucional { color: #2E594D; }
        .border-institucional { border-color: #2E594D; }
        .hover-institucional:hover { background-color: #234238; }
        
        .input-institucional:focus {
            outline: none;
            border-color: #2E594D;
            box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.1);
        }
    </style>

    <div x-data="usersApp()" class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
        
        <!-- Notificaci√≥n -->
        <template x-teleport="body">
            <div x-show="notification.show" x-cloak
                 x-transition:enter="transition ease-out duration-300"
                 class="fixed top-5 right-5 z-[100] p-4 rounded-xl shadow-2xl text-white font-bold"
                 :class="notification.type === 'success' ? 'bg-institucional' : 'bg-red-600'">
                <span x-text="notification.message"></span>
            </div>
        </template>

        <!-- Header -->
        <div class="mb-8">
            <div x-show="isLoading" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-blue-900">‚è≥ Cargando usuarios...</h3>
                        <p class="text-sm text-blue-700">Conectando con la API</p>
                    </div>
                </div>
            </div>

            <div x-show="apiError && !isLoading" class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div>
                        <h3 class="font-bold text-red-900">‚ùå Error de Autenticaci√≥n</h3>
                        <p class="text-sm text-red-700" x-text="apiError"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 mb-1">üë• Gesti√≥n de Usuarios</h1>
                    <p class="text-slate-500">Administraci√≥n completa de usuarios y roles del sistema</p>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex flex-wrap gap-3">
                <button @click="openModal(null)" 
                        class="px-4 py-2 bg-institucional text-white rounded-lg hover-institucional transition-colors font-medium flex items-center gap-2">
                    ‚ûï Nuevo Usuario
                </button>
                <button @click="openImportModal('users')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2">
                    üì• Importar Usuarios
                </button>
                <button @click="openImportModal('students')" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center gap-2">
                    üìö Importar Estudiantes
                </button>
                <button @click="promoteStudents()" 
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center gap-2">
                    üéì Promover Estudiantes
                </button>
                <button @click="loadUsers(true)" 
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium flex items-center gap-2">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                <div class="p-6 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium uppercase">Total Usuarios</p>
                            <p class="text-2xl font-bold text-slate-800" x-text="pagination.total"></p>
                        </div>
                    </div>
                </div>
                <div class="p-6 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium uppercase">En Esta P√°gina</p>
                            <p class="text-2xl font-bold text-green-600" x-text="users.length"></p>
                        </div>
                    </div>
                </div>
                <div class="p-6 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-medium uppercase">Seleccionados</p>
                            <p class="text-2xl font-bold text-purple-600" x-text="selectedUsers.length"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        x-model="searchTerm"
                        placeholder="Buscar por nombre, email o ID..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    />
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Estado:</label>
                    <select
                        x-model="filters.status"
                        @change="loadUsers()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    >
                        <option value="activo">Activo</option>
                        <option value="baja-temporal">Baja Temporal</option>
                        <option value="baja">Baja</option>
                        <option value="eliminado">Eliminado</option>
                    </select>
                </div>
            </div>

            <!-- Acciones Masivas -->
            <div x-show="selectedUsers.length > 0" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
                <span class="text-sm font-medium text-blue-900">
                    <span x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                </span>
                <div class="flex gap-2">
                    <button @click="bulkDisableTemporary()" class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700">
                        Baja Temporal
                    </button>
                    <button @click="bulkDisable()" class="px-3 py-1 text-sm bg-orange-600 text-white rounded hover:bg-orange-700">
                        Dar de Baja
                    </button>
                    <button @click="bulkDelete()" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Usuarios -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input
                                    type="checkbox"
                                    @change="toggleSelectAll()"
                                    :checked="selectedUsers.length === users.length && users.length > 0"
                                    class="rounded border-gray-300"
                                />
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Roles</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="user in filteredUsers" :key="user.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <input
                                        type="checkbox"
                                        @change="toggleUserSelection(user.id)"
                                        :checked="selectedUsers.includes(user.id)"
                                        class="rounded border-gray-300"
                                    />
                                </td>
                                <td class="px-4 py-3 text-sm" x-text="user.id"></td>
                                <td class="px-4 py-3">
                                    <div class="text-sm font-medium" x-text="user.fullName"></div>
                                    <div class="text-xs text-gray-500" x-text="user.createdAtHuman"></div>
                                </td>
                                <td class="px-4 py-3 text-sm" x-text="user.email"></td>
                                <td class="px-4 py-3">
                                    <span 
                                        class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                        :class="user.status === 'active' || user.status === 'activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                        x-text="user.status"
                                    ></span>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <span x-text="user.roles_count || 0"></span> rol(es)
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex justify-end gap-2">
                                        <button @click="openModal(user)" class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button
                                            @click="deleteUser(user)"
                                            :disabled="normalizeStatus(user.status) === 'eliminado'"
                                            :class="normalizeStatus(user.status) === 'eliminado' ? 'text-gray-400 cursor-not-allowed text-sm font-medium' : 'text-red-600 hover:text-red-900 text-sm font-medium'"
                                        >
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Paginaci√≥n -->
            <div x-show="pagination.total > pagination.perPage" class="bg-gray-50 px-4 py-3 border-t">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Mostrando <span x-text="((pagination.currentPage - 1) * pagination.perPage) + 1"></span> a 
                        <span x-text="Math.min(pagination.currentPage * pagination.perPage, pagination.total)"></span> de 
                        <span x-text="pagination.total"></span> usuarios
                    </div>
                    <div class="flex gap-2">
                        <button
                            @click="changePage(pagination.currentPage - 1)"
                            :disabled="pagination.currentPage === 1"
                            class="px-3 py-1 rounded border text-sm disabled:opacity-50"
                        >
                            Anterior
                        </button>
                        <span class="px-3 py-1 text-sm">
                            P√°gina <span x-text="pagination.currentPage"></span> de <span x-text="pagination.lastPage"></span>
                        </span>
                        <button
                            @click="changePage(pagination.currentPage + 1)"
                            :disabled="pagination.currentPage === pagination.lastPage"
                            class="px-3 py-1 rounded border text-sm disabled:opacity-50"
                        >
                            Siguiente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Usuario (Crear/Editar) -->
        <div x-show="showModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div @click.away="closeModal()" class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-institucional text-white px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold" x-text="editingUser ? '‚úèÔ∏è Editar Usuario' : '‚ûï Nuevo Usuario'"></h2>
                    <button @click="closeModal()" class="text-2xl">&times;</button>
                </div>

                <form @submit.prevent="saveUser()" class="p-6 space-y-6">
                    <!-- Datos Personales -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">üìã Datos Personales</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nombre(s) <span class="text-red-500">*</span></label>
                                <input x-model="formData.name" type="text" required class="w-full px-3 py-2 border rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Apellidos <span class="text-red-500">*</span></label>
                                <input x-model="formData.last_name" type="text" required class="w-full px-3 py-2 border rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Email <span class="text-red-500">*</span></label>
                                <input x-model="formData.email" type="email" required class="w-full px-3 py-2 border rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">CURP <span class="text-red-500">*</span></label>
                                <input x-model="formData.curp" type="text" maxlength="18" required class="w-full px-3 py-2 border rounded-lg uppercase"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tel√©fono</label>
                                <input x-model="formData.phone_number" type="tel" class="w-full px-3 py-2 border rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Fecha de Nacimiento <span class="text-red-500">*</span></label>
                                <input x-model="formData.birthdate" type="date" required class="w-full px-3 py-2 border rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">G√©nero</label>
                                <select x-model="formData.gender" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="hombre">Hombre</option>
                                    <option value="mujer">Mujer</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tipo de Sangre</label>
                                <select x-model="formData.blood_type" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleccionar...</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de Estudiante (Opcional) -->
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            <input type="checkbox" id="isStudent" x-model="formData.is_student" class="w-4 h-4 rounded border-gray-300 cursor-pointer"/>
                            <label for="isStudent" class="text-lg font-semibold cursor-pointer">üéì ¬øEs Estudiante?</label>
                        </div>
                        
                        <template x-if="formData.is_student">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-4">
                                <h3 class="text-sm font-semibold text-blue-900 mb-3">üìö Informaci√≥n Acad√©mica</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Carrera <span class="text-red-500">*</span></label>
                                        <select x-model="formData.student.career_id" @change="$watch('formData.is_student', () => {})" class="w-full px-3 py-2 border rounded-lg" :class="studentErrors.career_id ? 'border-red-500' : ''">
                                            <option value="">Seleccionar carrera...</option>
                                            <template x-for="career in careers" :key="career.id">
                                                <option :value="career.id" x-text="career.career_name"></option>
                                            </template>
                                        </select>
                                        <template x-if="studentErrors.career_id">
                                            <p class="text-red-500 text-xs mt-1" x-text="studentErrors.career_id"></p>
                                        </template>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">N√∫mero de Control <span class="text-red-500">*</span></label>
                                        <input x-model="formData.student.n_control" type="text" placeholder="ej: 2025001" class="w-full px-3 py-2 border rounded-lg" :class="studentErrors.n_control ? 'border-red-500' : ''"/>
                                        <template x-if="studentErrors.n_control">
                                            <p class="text-red-500 text-xs mt-1" x-text="studentErrors.n_control"></p>
                                        </template>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Semestre <span class="text-red-500">*</span></label>
                                        <select x-model="formData.student.semestre" class="w-full px-3 py-2 border rounded-lg" :class="studentErrors.semestre ? 'border-red-500' : ''">
                                            <option value="">Seleccionar semestre...</option>
                                            <template x-for="sem in semesters" :key="sem">
                                                <option :value="sem" x-text="'Semestre ' + sem"></option>
                                            </template>
                                        </select>
                                        <template x-if="studentErrors.semestre">
                                            <p class="text-red-500 text-xs mt-1" x-text="studentErrors.semestre"></p>
                                        </template>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Grupo</label>
                                        <input x-model="formData.student.group" type="text" placeholder="ej: A" class="w-full px-3 py-2 border rounded-lg"/>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium mb-1">Taller</label>
                                        <input x-model="formData.student.workshop" type="text" placeholder="ej: Taller de Programaci√≥n" class="w-full px-3 py-2 border rounded-lg"/>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Botones -->
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" @click="closeModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" :disabled="isLoading" class="px-6 py-2 bg-institucional text-white rounded-lg hover-institucional disabled:opacity-50">
                            <span x-show="!isLoading">üíæ <span x-text="editingUser ? 'Actualizar' : 'Crear'"></span></span>
                            <span x-show="isLoading">Guardando...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Importaci√≥n -->
        <div x-show="showImportModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div @click.away="closeImportModal()" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h2 class="text-xl font-bold mb-4" x-text="importType === 'users' ? 'üì• Importar Usuarios' : 'üìö Importar Estudiantes'"></h2>
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                        <p class="font-semibold text-blue-900 mb-2">Formato Excel (.xlsx)</p>
                        <ul class="list-disc list-inside text-blue-800 space-y-1 text-xs">
                            <template x-if="importType === 'users'">
                                <div>
                                    <li>name, last_name, email, curp</li>
                                    <li>birthdate, gender, phone_number</li>
                                </div>
                            </template>
                            <template x-if="importType === 'students'">
                                <div>
                                    <li>curp (debe existir)</li>
                                    <li>career_id, n_control, semestre</li>
                                </div>
                            </template>
                        </ul>
                    </div>
                    <input
                        type="file"
                        accept=".xlsx"
                        @change="handleFileImport($event)"
                        class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-institucional file:text-white"
                    />
                    <button @click="closeImportModal()" class="w-full px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // @ts-nocheck
        function usersApp() {
            return {
                users: [],
                pagination: {
                    currentPage: 1,
                    lastPage: 1,
                    perPage: 15,
                    total: 0
                },
                filters: {
                    status: 'activo'
                },
                searchTerm: '',
                selectedUsers: [],
                isLoading: false,
                apiError: null,
                notification: { show: false, message: '', type: 'success' },
                showModal: false,
                showImportModal: false,
                importType: 'users',
                editingUser: null,
                formData: {},
                careers: [],
                semesters: Array.from({length: 12}, (_, i) => i + 1),
                studentErrors: {},

                init() {
                    this.formData = this.getEmptyFormData();
                    this.loadCareers();
                    this.loadUsers();
                },

                getEmptyFormData() {
                    return {
                        name: '',
                        last_name: '',
                        email: '',
                        phone_number: '',
                        birthdate: '',
                        gender: 'hombre',
                        curp: '',
                        address: ['', '', ''],
                        blood_type: '',
                        status: 'activo',
                        is_student: false,
                        student: {
                            career_id: '',
                            n_control: '',
                            semestre: '',
                            group: '',
                            workshop: ''
                        }
                    };
                },

                async authenticatedFetch(url, options = {}) {
                    const accessToken = localStorage.getItem('access_token');
                    const refreshToken = localStorage.getItem('refresh_token');

                    if (!accessToken) {
                        throw new Error('No hay token de autenticaci√≥n');
                    }

                    const headers = {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json',
                        ...options.headers,
                    };

                    if (options.body && !(options.body instanceof FormData) && !headers['Content-Type']) {
                        headers['Content-Type'] = 'application/json';
                    }

                    const execFetch = () => fetch(url, { ...options, headers });
                    let response = await execFetch();

                    if (response.status === 401 && refreshToken) {
                        const refreshResponse = await fetch(`${window.__API_BASE_URL__}/v1/refresh`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ refresh_token: refreshToken })
                        });

                        if (refreshResponse.ok) {
                            const data = await refreshResponse.json().catch(() => ({}));
                            const newAccess = data.data?.access_token;
                            const newRefresh = data.data?.refresh_token;
                            if (newAccess) {
                                localStorage.setItem('access_token', newAccess);
                                headers['Authorization'] = `Bearer ${newAccess}`;
                            }
                            if (newRefresh) {
                                localStorage.setItem('refresh_token', newRefresh);
                            }
                            response = await execFetch();
                        } else {
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('refresh_token');
                            window.location.href = '/';
                            throw new Error('Sesi√≥n expirada, vuelve a iniciar sesi√≥n');
                        }
                    }

                    return response;
                },

                normalizeStatus(status) {
                    const normalized = (status || '').toLowerCase();
                    return normalized === 'active' ? 'activo' : normalized;
                },

                get filteredUsers() {
                    const search = (this.searchTerm || '').toLowerCase().trim();
                    const requestedStatus = this.normalizeStatus(this.filters.status);

                    return this.users.filter(u => {
                        const normalizedStatus = this.normalizeStatus(u.status);
                        const matchesStatus = !requestedStatus || normalizedStatus === requestedStatus;
                        const matchesSearch = !search || (
                            (u.fullName || '').toLowerCase().includes(search) ||
                            (u.email || '').toLowerCase().includes(search) ||
                            u.id?.toString().includes(search)
                        );
                        return matchesStatus && matchesSearch;
                    });
                },

                async loadUsers(forceRefresh = false) {
                    this.isLoading = true;
                    this.apiError = null;

                    try {
                        const params = new URLSearchParams({
                            page: this.pagination.currentPage,
                            perPage: this.pagination.perPage,
                            status: this.filters.status,
                            forceRefresh: forceRefresh
                        });

                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/show-users?${params}`, {
                            method: 'GET',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.users'
                            }
                        });

                        if (!response.ok) throw new Error('Error al cargar usuarios');

                        const data = await response.json();
                        if (data.success && data.data?.users) {
                            const userData = data.data.users;
                            this.users = userData.items || [];
                            this.pagination = {
                                currentPage: userData.currentPage || 1,
                                lastPage: userData.lastPage || 1,
                                perPage: userData.perPage || 15,
                                total: userData.total || 0
                            };
                        }
                    } catch (error) {
                        this.apiError = error.message;
                        console.error('Error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                changePage(page) {
                    if (page >= 1 && page <= this.pagination.lastPage) {
                        this.pagination.currentPage = page;
                        this.loadUsers();
                    }
                },

                toggleSelectAll() {
                    if (this.selectedUsers.length === this.users.length) {
                        this.selectedUsers = [];
                    } else {
                        this.selectedUsers = this.users.map(u => u.id);
                    }
                },

                toggleUserSelection(userId) {
                    const index = this.selectedUsers.indexOf(userId);
                    if (index > -1) {
                        this.selectedUsers.splice(index, 1);
                    } else {
                        this.selectedUsers.push(userId);
                    }
                },

                openModal(user) {
                    this.editingUser = user;
                    if (user) {
                        this.formData = {
                            name: user.name || '',
                            last_name: user.last_name || '',
                            email: user.email || '',
                            phone_number: user.phone_number || '',
                            birthdate: user.birthdate || '',
                            gender: user.gender || 'hombre',
                            curp: user.curp || '',
                            address: Array.isArray(user.address) ? user.address : ['', '', ''],
                            blood_type: user.blood_type || '',
                            status: this.normalizeStatus(user.status) || 'activo',
                            is_student: false,
                            student: {
                                career_id: '',
                                n_control: '',
                                semestre: '',
                                group: '',
                                workshop: ''
                            }
                        };
                    } else {
                        this.formData = this.getEmptyFormData();
                    }
                    this.showModal = true;
                },

                closeModal() {
                    this.showModal = false;
                    this.editingUser = null;
                    this.studentErrors = {};
                },

                async loadCareers() {
                    try {
                        const response = await this.authenticatedFetch(
                            `${window.__API_BASE_URL__}/v1/careers?forceRefresh=false`,
                            {
                                method: 'GET',
                                headers: {
                                    'X-User-Role': 'admin'
                                }
                            }
                        );

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data?.careers) {
                                this.careers = data.data.careers;
                            }
                        }
                    } catch (error) {
                        console.error('Error al cargar carreras:', error);
                    }
                },

                validateStudentFields() {
                    this.studentErrors = {};
                    
                    if (!this.formData.is_student) return true;

                    if (!this.formData.student.career_id) {
                        this.studentErrors.career_id = 'La carrera es requerida';
                    }
                    if (!this.formData.student.n_control || this.formData.student.n_control.trim() === '') {
                        this.studentErrors.n_control = 'El n√∫mero de control es requerido';
                    }
                    if (!this.formData.student.semestre) {
                        this.studentErrors.semestre = 'El semestre es requerido';
                    }

                    return Object.keys(this.studentErrors).length === 0;
                },

                async saveUser() {
                    this.isLoading = true;
                    try {
                        if (this.formData.is_student && !this.validateStudentFields()) {
                            this.showNotification('‚ö†Ô∏è Por favor completa todos los campos requeridos de estudiante', 'error');
                            this.isLoading = false;
                            return;
                        }

                        const url = this.editingUser 
                            ? `${window.__API_BASE_URL__}/v1/admin-actions/update-user/${this.editingUser.id}`
                            : `${window.__API_BASE_URL__}/v1/admin-actions/register`;

                        const response = await this.authenticatedFetch(url, {
                            method: this.editingUser ? 'PUT' : 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': this.editingUser ? 'update.user' : 'create.user'
                            },
                            body: JSON.stringify(this.formData)
                        });

                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            throw new Error(data.message || 'Error al guardar usuario');
                        }

                        // Obtener ID del usuario creado/actualizado
                        const newUserId = this.editingUser?.id 
                            || data?.data?.user?.id 
                            || data?.data?.id 
                            || data?.id;

                        // Si es estudiante, adjuntar detalles
                        if (this.formData.is_student && newUserId) {
                            const attachBody = {
                                user_id: newUserId,
                                career_id: this.formData.student.career_id,
                                n_control: this.formData.student.n_control,
                                semestre: Number(this.formData.student.semestre),
                                group: this.formData.student.group,
                                workshop: this.formData.student.workshop
                            };
                            const attachRes = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/attach-student`, {
                                method: 'POST',
                                headers: {
                                    'X-User-Role': 'admin',
                                    'X-User-Permission': 'attach.student'
                                },
                                body: JSON.stringify(attachBody)
                            });
                            const attachData = await attachRes.json().catch(() => ({}));
                            if (!attachRes.ok) {
                                throw new Error(attachData.message || 'Error al asociar detalles de estudiante');
                            }
                        }

                        // Intentar mostrar contrase√±a generada si viene en la respuesta
                        const possiblePwd = (
                            data?.data?.user?.plain_password ||
                            data?.data?.plain_password ||
                            data?.plain_password ||
                            data?.data?.generated_password ||
                            data?.generated_password
                        );

                        if (possiblePwd) {
                            this.showNotification(`‚úÖ Usuario creado. Contrase√±a: ${possiblePwd}`, 'success');
                        } else if (this.formData.is_student) {
                            this.showNotification(`‚úÖ Usuario y detalles de estudiante guardados correctamente`, 'success');
                        } else {
                            this.showNotification(this.editingUser ? '‚úÖ Usuario actualizado' : '‚úÖ Usuario creado', 'success');
                        }

                        this.closeModal();
                        this.loadUsers(true);
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async deleteUser(userOrId) {
                    const target = typeof userOrId === 'object' ? userOrId : this.users.find(u => u.id === userOrId);
                    if (target && this.normalizeStatus(target.status) === 'eliminado') {
                        this.showNotification('Este usuario ya est√° marcado como eliminado', 'success');
                        return;
                    }

                    const userId = target?.id ?? userOrId;
                    if (!userId) {
                        this.showNotification('No se pudo identificar el usuario a eliminar', 'error');
                        return;
                    }

                    if (!confirm('¬øEliminar este usuario?')) return;

                    try {
                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/delete-user/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-User-Role': 'admin'
                            }
                        });

                        if (response.status === 409) {
                            const data = await response.json().catch(() => ({}));
                            this.showNotification(data.message || 'El usuario ya estaba eliminado', 'success');
                            this.loadUsers(true);
                            return;
                        }

                        if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            throw new Error(data.message || 'Error al eliminar');
                        }

                        this.showNotification('Usuario eliminado', 'success');
                        this.loadUsers(true);
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async bulkDelete() {
                    if (!confirm(`¬øEliminar ${this.selectedUsers.length} usuarios?`)) return;

                    try {
                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/delete-users`, {
                            method: 'DELETE',
                            body: JSON.stringify({ user_ids: this.selectedUsers }),
                            headers: {
                                'X-User-Role': 'admin'
                            }
                        });

                        if (response.status === 409) {
                            const data = await response.json().catch(() => ({}));
                            this.showNotification(data.message || 'Algunos usuarios ya estaban eliminados', 'success');
                        } else if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            throw new Error(data.message || 'Error al eliminar usuarios');
                        } else {
                            this.showNotification('Usuarios eliminados', 'success');
                        }
                        this.selectedUsers = [];
                        this.loadUsers(true);
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async bulkDisable() {
                    if (!confirm(`¬øDar de baja a ${this.selectedUsers.length} usuarios?`)) return;

                    try {
                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/disable-users`, {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin'
                            },
                            body: JSON.stringify({ user_ids: this.selectedUsers })
                        });

                        if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            throw new Error(data.message || 'Error al dar de baja');
                        }

                        this.showNotification('Usuarios dados de baja', 'success');
                        this.selectedUsers = [];
                        this.loadUsers(true);
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async bulkDisableTemporary() {
                    if (!confirm(`¬øBaja temporal a ${this.selectedUsers.length} usuarios?`)) return;

                    try {
                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/temporary-disable-users`, {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin'
                            },
                            body: JSON.stringify({ user_ids: this.selectedUsers })
                        });

                        if (!response.ok) {
                            const data = await response.json().catch(() => ({}));
                            throw new Error(data.message || 'Error al aplicar baja temporal');
                        }

                        this.showNotification('Baja temporal aplicada', 'success');
                        this.selectedUsers = [];
                        this.loadUsers(true);
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async promoteStudents() {
                    if (!confirm('¬øPromover TODOS los estudiantes?')) return;

                    try {
                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}/v1/admin-actions/promotion`, {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'promote.student'
                            }
                        });

                        const data = await response.json();
                        if (data.success) {
                            const affected = data.data?.affected;
                            this.showNotification(`‚úÖ ${affected?.usuarios_promovidos || 0} promovidos, ${affected?.usuarios_baja || 0} dados de baja`, 'success');
                            this.loadUsers(true);
                        }
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                openImportModal(type) {
                    this.importType = type;
                    this.showImportModal = true;
                },

                closeImportModal() {
                    this.showImportModal = false;
                },

                async handleFileImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!confirm(`¬øImportar ${this.importType === 'users' ? 'usuarios' : 'estudiantes'}?`)) {
                        event.target.value = '';
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        const endpoint = this.importType === 'users' 
                            ? '/v1/admin-actions/import'
                            : '/v1/admin-actions/import-students';

                        const response = await this.authenticatedFetch(`${window.__API_BASE_URL__}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'import.users'
                            },
                            body: formData
                        });

                        const data = await response.json();
                        if (data.success) {
                            const summary = data.data?.summary?.summary;
                            this.showNotification(`‚úÖ ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`, 'success');
                            this.loadUsers(true);
                        }
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    } finally {
                        event.target.value = '';
                        this.closeImportModal();
                    }
                },

                showNotification(message, type = 'success') {
                    this.notification = { show: true, message, type };
                    setTimeout(() => {
                        this.notification = { show: false, message: '', type: 'success' };
                    }, 3000);
                }
            };
        }
    </script>
</Layout>
