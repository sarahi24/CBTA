---
import Layout from '../layouts/Layout.astro';

// No cargar usuarios en SSR - se cargar√°n del lado del cliente con autenticaci√≥n
const API_BASE_URL = 'https://nginx-production-728f.up.railway.app/api';
---

<Layout title="Gesti√≥n de Personal | CBTA 71">
    <script is:inline src="/js/xlsx.min.js"></script>
    <script is:inline define:vars={{ API_BASE_URL }}>
        window.__API_BASE_URL__ = API_BASE_URL;
    </script>
    
    <style is:global>
        [x-cloak] { display: none !important; }
        
        /* Colores institucionales */
        .bg-institucional { background-color: #2E594D; }
        .text-institucional { color: #2E594D; }
        .border-institucional { border-color: #2E594D; }
        .hover-institucional:hover { background-color: #234238; }
        
        .input-institucional:focus {
            outline: none;
            border-color: #2E594D;
            box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.1);
        }
        
        /* FORZAR TABLA HORIZONTAL 1x3 */
        table.stats-table {
            table-layout: fixed !important;
            width: 100% !important;
            border-collapse: collapse;
        }
        
        table.stats-table td {
            width: 33.333% !important;
        }
        
        .dropzone-active {
            border-color: #2E594D;
            background-color: rgba(46, 89, 77, 0.05);
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
            }
            /* En m√≥vil, si prefieres que se apilen, puedes quitar el table-fixed aqu√≠, 
               pero seg√∫n tu petici√≥n de "tabla 1x3" se mantiene r√≠gido */
        }
    </style>

    <div x-data="rolesData" class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
        
        <template x-teleport="body">
            <div x-show="notification.show" x-cloak
                 x-transition:enter="transition ease-out duration-300"
                 class="fixed top-5 right-5 z-[100] p-4 rounded-xl shadow-2xl text-white font-bold"
                 :class="notification.type === 'success' ? 'bg-institucional' : 'bg-red-600'">
                <span x-text="notification.message"></span>
            </div>
        </template>

        <div class="mb-8">
            <!-- Loading state -->
            <div x-show="isLoadingUsers" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-blue-900">‚è≥ Cargando usuarios...</h3>
                        <p class="text-sm text-blue-700">Conectando con la API</p>
                    </div>
                </div>
            </div>
            
            <!-- Error state -->
            <div x-show="apiError && !isLoadingUsers" class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-900">‚ùå Sin Autenticaci√≥n</h3>
                        <p class="text-sm text-red-700">No has iniciado sesi√≥n. Redirigiendo al login...</p>
                        <p class="text-xs text-red-600 mt-1">Abre la consola (F12) para ver detalles</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between gap-4 mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 mb-1">üë• Gesti√≥n de Usuarios</h1>
                    <p class="text-slate-500">Administraci√≥n completa de usuarios, roles y permisos</p>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex flex-wrap gap-2 md:gap-3">
                <button @click="openPanelForAdd()" 
                        class="px-3 md:px-4 py-2 bg-institucional text-white text-sm md:text-base font-semibold rounded-lg hover-institucional transition-all flex items-center gap-2 shadow-md">
                    ‚ûï Nuevo Usuario
                </button>
                <button @click="openStudentPanel()" 
                        class="px-3 md:px-4 py-2 bg-blue-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    üéì Asociar Estudiante
                </button>
                <button @click="openRolesPanel()" 
                        class="px-3 md:px-4 py-2 bg-purple-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                    üîê Gestionar Roles
                </button>
                <button @click="openPermissionsPanel()" 
                        class="px-3 md:px-4 py-2 bg-indigo-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                    üîë Permisos
                </button>
                <div class="relative" x-data="{ showImportMenu: false }">
                    <button @click="showImportMenu = !showImportMenu" 
                            class="px-3 md:px-4 py-2 bg-emerald-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-emerald-700 transition-all flex items-center gap-2">
                        üì• Importar
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div x-show="showImportMenu" @click.away="showImportMenu = false" 
                         class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                        <button @click="openImportModal(); showImportMenu = false" 
                                class="w-full text-left px-4 py-3 hover:bg-emerald-50 transition-colors flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            <div>
                                <div class="font-semibold text-gray-800">Usuarios Completos</div>
                                <div class="text-xs text-gray-500">Importar usuarios con todos sus datos</div>
                            </div>
                        </button>
                        <button @click="openImportStudentsModal(); showImportMenu = false" 
                                class="w-full text-left px-4 py-3 hover:bg-purple-50 transition-colors flex items-center gap-2 border-t">
                            <span class="text-2xl">üéì</span>
                            <div>
                                <div class="font-semibold text-gray-800">Detalles de Estudiantes</div>
                                <div class="text-xs text-gray-500">Solo datos acad√©micos (CURP requerido)</div>
                            </div>
                        </button>
                    </div>
                </div>
                <button @click="openCareerModal()"
                        class="px-3 md:px-4 py-2 bg-teal-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-teal-700 transition-all flex items-center gap-2">
                    üß≠ Nueva Carrera
                </button>
                <button @click="loadUsers(localStorage.getItem('access_token'))" 
                        class="px-3 md:px-4 py-2 bg-gray-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-gray-700 transition-all flex items-center gap-2">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        x-model="searchTerm"
                        placeholder="üîç Buscar por nombre, email o CURP..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional focus:border-transparent"
                    />
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Estado:</label>
                    <select
                        x-model="filterStatus"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    >
                        <option value="">Todos</option>
                        <option value="activo">Activo</option>
                        <option value="baja-temporal">Baja Temporal</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
            </div>

            <!-- Acciones Masivas -->
            <div x-show="selectedUsers.length > 0" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                    <span class="text-sm font-medium text-blue-900">
                        <span x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </span>
                    <div class="flex flex-wrap gap-2">
                        <button @click="openRolesPanel()" class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                            üîê Roles
                        </button>
                        <button @click="openPermissionsPanel()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                            üîë Permisos
                        </button>
                        <button @click="activateUsers()" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            ‚úÖ Activar
                        </button>
                        <button @click="bulkTemporaryDisable()" class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
                            ‚è∏Ô∏è Baja Temporal
                        </button>
                        <button @click="bulkDisable()" class="px-3 py-1 text-sm bg-orange-600 text-white rounded hover:bg-orange-700 transition">
                            üö´ Dar de Baja
                        </button>
                        <button @click="bulkDelete()" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
            <table class="stats-table">
                <tbody>
                    <tr class="divide-x divide-slate-200">
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Total Usuarios</p>
                                    <p class="text-2xl font-bold text-slate-800" x-text="stats.total"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Usuarios Activos</p>
                                    <p class="text-2xl font-bold text-green-600" x-text="stats.active"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-institucional bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-institucional" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Administradores</p>
                                    <p class="text-2xl font-bold text-institucional" x-text="stats.admins"></p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input
                                    type="checkbox"
                                    @change="toggleSelectAll()"
                                    :checked="selectedUsers.length === filteredUsers.length && filteredUsers.length > 0"
                                    class="rounded border-gray-300"
                                />
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Usuario</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Contacto</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">CURP</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Rol</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <template x-for="user in filteredUsers" :key="user.id">
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <input
                                        type="checkbox"
                                        @change="toggleUserSelection(user.id)"
                                        :checked="selectedUsers.includes(user.id)"
                                        class="rounded border-gray-300"
                                    />
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-institucional to-teal-600 flex items-center justify-center text-white font-bold">
                                            <span x-text="(user.fullName || user.name || 'Usuario').split(' ').map(n => n.charAt(0)).slice(0, 2).join('').toUpperCase()"></span>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-slate-800" x-text="user.fullName || `${user.name || ''} ${user.last_name || ''}`.trim() || 'Sin nombre'"></div>
                                            <div class="text-xs text-slate-500" x-text="user.createdAtHuman || 'Reciente'"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-slate-700" x-text="user.email"></div>
                                    <div class="text-xs text-slate-500" x-text="user.id ? `ID: ${user.id}` : ''"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded inline-block" x-text="user.curp || 'N/A'"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1.5 rounded-full text-xs font-semibold inline-flex items-center gap-1"
                                          x-bind:class="roleClass(user.roleKey)"
                                          x-text="user.roleLabel"></span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold"
                                          x-bind:class="user.status === 'activo' ? 'bg-green-100 text-green-700' : user.status === 'baja-temporal' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'"
                                          x-text="statusLabel(user.status)"></span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button @click="viewUserDetails(user.id)" 
                                                class="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors"
                                                title="Ver detalles">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </button>
                                        <button @click="openStudentPanel(user.id)" 
                                                class="p-2 text-slate-400 hover:text-purple-500 hover:bg-purple-50 rounded-lg transition-colors"
                                                title="Asociar estudiante">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                                <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/>
                                            </svg>
                                        </button>
                                        <button @click="openPanelForEdit(user)" 
                                                class="p-2 text-slate-400 hover:text-institucional hover:bg-slate-100 rounded-lg transition-colors"
                                                title="Editar">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </button>
                                        <button @click="confirmDeleteUser(user)" 
                                                class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="isPanelOpen" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center p-4">
            <div x-show="isPanelOpen" x-transition.opacity @click="closePanel()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
            <div x-show="isPanelOpen" 
                 x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                 class="relative bg-white rounded-2xl p-6 sm:p-8 shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <button @click="closePanel()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="mb-6">
                    <h2 class="text-2xl font-black text-institucional mb-2" x-text="isEditing ? 'Editar Colaborador' : 'Registrar Administrador/Personal'"></h2>
                    <p class="text-xs text-slate-500 flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>La contrase√±a se genera autom√°ticamente por el sistema y se enviar√° al email del usuario.</span>
                    </p>
                </div>
                <form @submit.prevent="saveUser()" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre(s)</label>
                            <input x-model="newUser.name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Apellidos</label>
                            <input x-model="newUser.last_name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email</label>
                        <input x-model="newUser.email" type="email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tel√©fono</label>
                            <input x-model="newUser.phone_number" type="tel" pattern="[0-9]{10}" placeholder="5512345678" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Fecha Nacimiento</label>
                            <input x-model="newUser.birthdate" type="date" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">G√©nero</label>
                            <select x-model="newUser.gender" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                <option value="hombre">Hombre</option>
                                <option value="mujer">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tipo de Sangre</label>
                            <select x-model="newUser.blood_type" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CURP</label>
                        <input x-model="newUser.curp" type="text" pattern="[A-Z]{4}[0-9]{6}[A-Z]{6}[0-9]{2}" maxlength="18" placeholder="PELJ000512HDFRPN09" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional uppercase">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Calle y N√∫mero</label>
                        <input x-model="newUser.address[0]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Colonia</label>
                            <input x-model="newUser.address[1]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Ciudad/Estado</label>
                            <input x-model="newUser.address[2]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Asignar Rol</label>
                        <select x-model="newUser.role" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional font-semibold">
                            <option value="Administrador">Administrador</option>
                            <option value="Caja">Personal de Caja</option>
                            <option value="Maestro">Maestro</option>
                        </select>
                    </div>

                    <!-- SECCI√ìN DE DATOS DE ESTUDIANTE (si es estudiante) -->
                    <template x-if="isEditing">
                    <div class="sm:col-span-2 pt-6 border-t-2 border-slate-200">
                        <h3 class="text-lg font-bold text-institucional mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C6.5 6.253 3 9.2 3 12s3.5 5.747 9 5.747m0-13c5.5 0 9-2.948 9-5.747m0 13c5.5 0 9-2.948 9-5.747M12 6.253v13"/>
                            </svg>
                            Datos de Estudiante
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Matr√≠cula (N. Control)</label>
                                <input x-model="newUser.studentDetail.n_control" type="text" placeholder="2023001" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Carrera</label>
                                <select x-model="newUser.studentDetail.career_id" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                    <option value="">Seleccionar carrera...</option>
                                    <template x-for="career in careers" :key="career.id">
                                        <option :value="career.id" x-text="career.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Semestre</label>
                                <input x-model.number="newUser.studentDetail.semestre" type="number" min="1" max="12" placeholder="1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Grupo</label>
                                <input x-model="newUser.studentDetail.group" type="text" maxlength="10" placeholder="A" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Taller</label>
                                <input x-model="newUser.studentDetail.workshop" type="text" placeholder="Taller 1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                        </div>
                    </div>
                    </template>

                    <div class="flex flex-col sm:flex-row gap-3 pt-6 sm:col-span-2">
                        <button type="button" @click="closePanel()" :disabled="isSaving" class="flex-1 py-3 font-bold text-slate-600 hover:bg-slate-100 rounded-xl disabled:opacity-50 border-2 border-slate-200 transition-colors">Cancelar</button>
                        <button type="submit" :disabled="isSaving" class="flex-1 py-3 bg-institucional text-white font-bold rounded-xl shadow-lg hover-institucional disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!isSaving" x-text="isEditing ? 'Actualizar Datos' : 'Registrar Ahora'"></span>
                            <span x-show="isSaving" class="flex items-center justify-center gap-2">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Guardando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <template x-teleport="body">
            <div x-show="isDeleting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="isDeleting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">¬øEliminar usuario?</h3>
                    <p class="text-slate-500 text-sm mb-6" x-text="`Se eliminar√° permanentemente a ${userToDeleteName}`"></p>
                    <div class="flex gap-3">
                        <button @click="isDeleting = false" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">Cancelar</button>
                        <button @click="deleteUser(userToDeleteId)" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors">Eliminar</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-teleport="body">
            <div x-show="isImporting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="isImporting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">Importar Usuarios desde Excel</h3>
                    <p class="text-slate-500 text-sm mb-6">Carga un archivo Excel con los datos de m√∫ltiples usuarios para registrarlos masivamente</p>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInput.click()">
                        <input type="file" x-ref="fileInput" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-2">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-sm mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos aceptados: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-4 p-4 bg-slate-50 rounded-lg flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null; importedData = []" class="p-2 text-slate-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div x-show="importedData.length > 0" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <span class="font-bold" x-text="importedData.length"></span> usuario(s) detectado(s) en el archivo
                        </p>
                    </div>

                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-sm font-semibold text-amber-900 mb-2">üìã Columnas requeridas (en orden):</p>
                        <div class="text-xs text-amber-700 font-mono bg-white p-3 rounded overflow-x-auto">
                            <div>1. name | 2. last_name | 3. email | 4. phone_number</div>
                            <div>5. birthdate | 6. gender | 7. curp | 8. street</div>
                            <div>9. city | 10. state | 11. zip_code | 12. stripe_customer_id (opcional)</div>
                            <div>13. blood_type | 14. registration_date | 15. status</div>
                            <div>16. career_id | 17. n_control | 18. semestre | 19. group | 20. workshop</div>
                        </div>
                        <p class="text-xs text-amber-800 mt-2">
                            üí° <strong>Nota:</strong> El campo password no se incluye, se genera autom√°ticamente
                        </p>
                        <button @click="downloadTemplate()" class="mt-3 text-xs text-institucional hover:underline font-semibold flex items-center gap-1">
                            ‚¨áÔ∏è Descargar plantilla de ejemplo
                        </button>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="closeImportModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">Cancelar</button>
                        <button @click="processImport()" :disabled="!selectedFile || isSaving" class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isSaving">Importar Usuarios</span>
                            <span x-show="isSaving">Importando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Importaci√≥n de Estudiantes -->
        <template x-teleport="body">
            <div x-show="isImportingStudents" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="closeImportStudentsModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üìö Importar Detalles de Estudiantes</h3>
                    <p class="text-slate-500 text-sm mb-6">Carga un archivo Excel con los detalles acad√©micos de estudiantes existentes</p>

                    <div x-show="importStudentsError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
                        <span x-text="importStudentsError"></span>
                    </div>
                    <div x-show="importStudentsErrorDetails.length" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-xs text-red-700 space-y-1">
                        <template x-for="(err, idx) in importStudentsErrorDetails" :key="idx">
                            <div class="font-mono" x-text="err"></div>
                        </template>
                    </div>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInputStudents.click()">
                        <input type="file" x-ref="fileInputStudents" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-2">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-sm mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos aceptados: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-4 p-4 bg-slate-50 rounded-lg flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null" class="p-2 text-slate-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm font-semibold text-purple-900 mb-2">üìã Formato requerido (columnas en orden):</p>
                        <div class="text-xs text-purple-700 font-mono bg-white p-2 rounded break-all">
                            curp | career_id | n_control | semestre | group | workshop
                        </div>
                        <div class="mt-3 space-y-1 text-xs text-purple-800">
                            <p>‚ö†Ô∏è <strong>Importante:</strong></p>
                            <ul class="list-disc list-inside pl-2 space-y-1">
                                <li>El CURP debe existir en la base de datos</li>
                                <li><strong>career_id</strong>: n√∫mero entero (ejemplo: 1, 2, 3)</li>
                                <li><strong>n_control</strong>: texto (ejemplo: "20240001")</li>
                                <li><strong>semestre</strong>: n√∫mero del 1 al 12</li>
                                <li><strong>group</strong>: texto opcional (ejemplo: "A", "B")</li>
                                <li><strong>workshop</strong>: texto opcional (ejemplo: "Taller 1")</li>
                            </ul>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="closeImportStudentsModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                            Cancelar
                        </button>
                        <button @click="processImportStudents()" :disabled="!selectedFile || isSaving" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isSaving">Importar Estudiantes</span>
                            <span x-show="isSaving">Importando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Estudiante -->
        <template x-teleport="body">
            <div x-show="showStudentModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="showStudentModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üéì Asociar Detalles de Estudiante</h3>
                    <p class="text-slate-500 text-sm mb-6">Asignar informaci√≥n acad√©mica al usuario seleccionado</p>
                    
                    <!-- Datos del usuario seleccionado -->
                    <div x-show="currentStudentUser" class="bg-slate-50 p-4 rounded-lg mb-6 border border-slate-200">
                        <p class="text-sm text-slate-600"><strong>Usuario:</strong> <span x-text="(currentStudentUser?.nombre || currentStudentUser?.name || 'N/A') + ' ' + (currentStudentUser?.apellidoP || currentStudentUser?.apellidoPaterno || currentStudentUser?.apellido_paterno || '')"></span></p>
                        <p class="text-sm text-slate-600"><strong>Email:</strong> <span x-text="currentStudentUser?.correo || currentStudentUser?.email || 'N/A'"></span></p>
                        <p class="text-sm text-slate-600"><strong>ID:</strong> <span x-text="studentDetails.user_id"></span></p>
                    </div>
                    
                    <form @submit.prevent="saveStudentDetails()" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Carrera *</label>
                                <div class="flex items-start gap-2">
                                    <div class="flex-1">
                                        <select x-model="studentDetails.career_id" required
                                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                            <option value="">Selecciona una carrera</option>
                                            <template x-for="career in careers" :key="career.id">
                                                <option :value="career.id" x-text="`ID ${career.id} - ${career.career_name}`"></option>
                                            </template>
                                        </select>
                                        <p x-show="isLoadingCareers" class="text-xs text-slate-500 mt-1">Cargando carreras...</p>
                                        <p x-show="!isLoadingCareers && !careers.length" class="text-xs text-slate-500 mt-1">No hay carreras registradas.</p>
                                    </div>
                                    <button type="button" @click="loadCareers(true)"
                                            class="px-3 py-2 text-xs font-semibold text-teal-700 hover:text-teal-800 hover:bg-teal-50 rounded-lg border border-teal-200">
                                        üîÑ
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">N√∫mero de Control *</label>
                                <input x-model="studentDetails.n_control" type="text" required 
                                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Semestre *</label>
                                <input x-model="studentDetails.semestre" type="number" required min="1" max="12" 
                                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Grupo</label>
                                <input x-model="studentDetails.group" type="text" maxlength="10" 
                                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Taller</label>
                                <input x-model="studentDetails.workshop" type="text" 
                                       class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="button" @click="showStudentModal = false" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving" class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50">
                                <span x-show="!isSaving">Guardar Detalles</span>
                                <span x-show="isSaving">Guardando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>

        <!-- Modal de Creaci√≥n de Carrera -->
        <template x-teleport="body">
            <div x-show="showCareerModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="closeCareerModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-lg shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üß≠ Crear nueva carrera</h3>
                    <p class="text-slate-500 text-sm mb-6">Registra una carrera acad√©mica disponible para los estudiantes.</p>

                    <form @submit.prevent="saveCareer()" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre de la carrera *</label>
                            <input x-model="careerForm.career_name" type="text" required maxlength="100"
                                   class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional"
                                   placeholder="Ej. Ofim√°tica">
                            <p x-show="careerError" class="text-sm text-red-600 mt-2" x-text="careerError"></p>
                        </div>

                        <div class="flex gap-3 pt-2">
                            <button type="button" @click="closeCareerModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSavingCareer"
                                    class="flex-1 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!isSavingCareer">Crear carrera</span>
                                <span x-show="isSavingCareer">Creando...</span>
                            </button>
                        </div>
                    </form>

                    <div class="mt-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-semibold text-slate-800">Carreras existentes (ID)</h4>
                            <button type="button" @click="loadCareers(false)" class="text-xs font-semibold text-teal-700 hover:text-teal-800">
                                ‚Üª Actualizar
                            </button>
                        </div>
                        <div x-show="isLoadingCareers" class="text-sm text-slate-600">Cargando carreras...</div>
                        <div x-show="!isLoadingCareers && careers.length" class="max-h-56 overflow-y-auto divide-y divide-slate-200 text-sm">
                            <template x-for="career in careers" :key="career.id">
                                <div class="py-2 flex items-center justify-between gap-3">
                                    <div class="flex flex-col">
                                        <span class="font-mono text-slate-600" x-text="`ID ${career.id}`"></span>
                                        <span class="font-semibold text-slate-800" x-text="career.career_name"></span>
                                    </div>
                                    <button type="button"
                                            @click="deleteCareer(career.id)"
                                            :disabled="careerDeletingId === career.id"
                                            class="px-2 py-1 text-xs font-semibold text-red-700 hover:text-red-800 hover:bg-red-50 rounded disabled:opacity-50">
                                        <span x-show="careerDeletingId !== career.id">Eliminar</span>
                                        <span x-show="careerDeletingId === career.id">Borrando...</span>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <p x-show="!isLoadingCareers && !careers.length" class="text-sm text-slate-500">No hay carreras registradas.</p>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Roles -->
        <template x-teleport="body">
            <div x-show="showRolesModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="showRolesModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üîê Gestionar Roles</h3>
                    <p class="text-slate-500 text-sm mb-6">
                        Agregar o eliminar roles para <span class="font-bold" x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </p>
                    
                    <form @submit.prevent="updateRoles()" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Agregar Roles -->
                            <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                                <h4 class="font-bold text-green-900 mb-3">‚ûï Agregar Roles</h4>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    <template x-for="role in availableRoles" :key="role.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-green-100 rounded-lg cursor-pointer transition-colors">
                                            <input type="checkbox" :value="role.name" 
                                                   x-model="rolesToAdd"
                                                   class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                                            <span class="text-sm font-medium text-green-800" x-text="role.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Eliminar Roles -->
                            <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                                <h4 class="font-bold text-red-900 mb-3">‚ûñ Eliminar Roles</h4>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    <template x-for="role in availableRoles" :key="role.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-red-100 rounded-lg cursor-pointer transition-colors">
                                            <input type="checkbox" :value="role.name" 
                                                   x-model="rolesToRemove"
                                                   class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                                            <span class="text-sm font-medium text-red-800" x-text="role.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" @click="showRolesModal = false" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving || (rolesToAdd.length === 0 && rolesToRemove.length === 0)" 
                                    class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50">
                                <span x-show="!isSaving">Actualizar Roles</span>
                                <span x-show="isSaving">Actualizando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>

        <!-- Modal de Gesti√≥n de Permisos -->
        <template x-teleport="body">
            <div x-show="showPermissionsModal" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="showPermissionsModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üîë Gestionar Permisos</h3>
                    <p class="text-slate-500 text-sm mb-6">
                        Agregar o eliminar permisos para <span class="font-bold" x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </p>
                    
                    <form @submit.prevent="updatePermissions()" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Agregar Permisos -->
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                                <h4 class="font-bold text-blue-900 mb-3">‚ûï Agregar Permisos</h4>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    <template x-for="permission in availablePermissions" :key="permission.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-blue-100 rounded-lg cursor-pointer transition-colors">
                                            <input type="checkbox" :value="permission.name" 
                                                   x-model="permissionsToAdd"
                                                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <div class="flex-1">
                                                <span class="text-sm font-medium text-blue-800" x-text="permission.name"></span>
                                                <span class="text-xs text-blue-600" x-text="' (' + permission.type + ')'"></span>
                                            </div>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Eliminar Permisos -->
                            <div class="p-4 bg-orange-50 border border-orange-200 rounded-xl">
                                <h4 class="font-bold text-orange-900 mb-3">‚ûñ Eliminar Permisos</h4>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    <template x-for="permission in availablePermissions" :key="permission.id">
                                        <label class="flex items-center gap-2 p-2 hover:bg-orange-100 rounded-lg cursor-pointer transition-colors">
                                            <input type="checkbox" :value="permission.name" 
                                                   x-model="permissionsToRemove"
                                                   class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500">
                                            <div class="flex-1">
                                                <span class="text-sm font-medium text-orange-800" x-text="permission.name"></span>
                                                <span class="text-xs text-orange-600" x-text="' (' + permission.type + ')'"></span>
                                            </div>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" @click="showPermissionsModal = false" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" :disabled="isSaving || (permissionsToAdd.length === 0 && permissionsToRemove.length === 0)" 
                                    class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50">
                                <span x-show="!isSaving">Actualizar Permisos</span>
                                <span x-show="isSaving">Actualizando...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>
    </div>
</Layout>

<script is:inline>
    // Prevenir m√∫ltiples inicializaciones de Alpine
    (function() {
        if (window.__rolesDataRegistered__) return;
        window.__rolesDataRegistered__ = true;
        
        function registerComponent() {
            Alpine.data('rolesData', () => ({
                users: [],
                apiBaseUrl: window.__API_BASE_URL__ || '',
                apiError: null,
                isLoadingUsers: true,
                isPanelOpen: false,
                isEditing: false,
                isDeleting: false,
                isSaving: false,
                isImporting: false,
                isImportingStudents: false,
                isDragging: false,
                selectedFile: null,
                importedData: [],
                importStudentsError: '',
                importStudentsErrorDetails: [],
                userToDeleteId: null,
                userToDeleteName: '',
                selectedUsers: [],
                searchTerm: '',
                filterStatus: '',
                newUser: { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'Administrador',
                    studentDetail: {
                        user_id: null,
                        career_id: '',
                        n_control: '',
                        semestre: 1,
                        group: '',
                        workshop: ''
                    }
                },
                notification: { show: false, message: '', type: 'success' },
                
                // Estados para gesti√≥n de estudiantes
                showStudentModal: false,
                currentStudentUser: null,
                studentDetails: {
                    user_id: null,
                    career_id: '',
                    n_control: '',
                    semestre: 1,
                    group: '',
                    workshop: ''
                },

                // Estados para gesti√≥n de carreras
                showCareerModal: false,
                careerForm: { career_name: '' },
                careerError: '',
                isSavingCareer: false,
                careers: [],
                isLoadingCareers: false,
                careerDeletingId: null,
                
                // Estados para gesti√≥n de roles
                showRolesModal: false,
                availableRoles: [],
                rolesToAdd: [],
                rolesToRemove: [],
                
                // Estados para gesti√≥n de permisos
                showPermissionsModal: false,
                availablePermissions: [],
                permissionsToAdd: [],
                permissionsToRemove: [],
                permissionTargetRole: '',

            // Funci√≥n helper para hacer fetch con auto-refresh
            async authenticatedFetch(url, options = {}, isRetry = false) {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('No hay token de autenticaci√≥n');
                }

                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });

                // Si el token expir√≥ (401 o 403) y no hemos reintentado
                if ((response.status === 401 || response.status === 403) && !isRetry) {
                    console.log('üîÑ Token expirado. Intentando refresh...');
                    
                    const newToken = await this.refreshAuthToken();
                    
                    if (newToken) {
                        console.log('‚úÖ Token refrescado. Reintentando petici√≥n...');
                        // Reintentar con el nuevo token
                        return await this.authenticatedFetch(url, options, true);
                    } else {
                        console.error('‚ùå No se pudo refrescar el token. Cerrando sesi√≥n...');
                        this.showNotify('Tu sesi√≥n ha expirado', 'error');
                        setTimeout(() => {
                            localStorage.clear();
                            window.location.href = '/';
                        }, 2000);
                        throw new Error('Sesi√≥n expirada');
                    }
                } else if ((response.status === 401 || response.status === 403) && isRetry) {
                    // Ya reintentamos y fall√≥
                    this.showNotify('Tu sesi√≥n ha expirado', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/';
                    }, 2000);
                    throw new Error('Sesi√≥n expirada');
                }

                return response;
            },

            normalizeDate(value) {
                if (!value) return '';
                if (typeof value === 'string') {
                    return value.split('T')[0];
                }
                return value;
            },

            statusLabel(status) {
                const key = (status || '').toLowerCase();
                if (key === 'activo' || key === 'active') return 'Activo';
                if (key === 'baja-temporal') return 'Baja temporal';
                return 'Inactivo';
            },

            roleClass(roleKey) {
                const key = (roleKey || '').toLowerCase();
                if (key === 'admin' || key === 'administrador') return 'bg-purple-100 text-purple-700';
                if (key === 'caja' || key === 'financial-staff' || key === 'financial staff') return 'bg-blue-100 text-blue-700';
                if (key === 'maestro' || key === 'teacher' || key === 'docente') return 'bg-emerald-100 text-emerald-700';
                return 'bg-slate-100 text-slate-600';
            },

            mapUser(raw) {
                if (!raw) return null;
                
                // Log para debugging
                console.log('üîç mapUser recibi√≥:', raw);
                
                const roleValue = raw.role || raw.role_name || (Array.isArray(raw.roles) ? raw.roles[0] : (raw.roles?.[0]?.name || raw.roles?.[0])) || '';
                const roleKey = roleValue.toString().toLowerCase();
                let roleLabel = 'Sin rol';
                if (roleKey === 'admin' || roleKey === 'administrador') roleLabel = 'Administrador';
                else if (roleKey === 'caja' || roleKey === 'financial-staff' || roleKey === 'financial staff') roleLabel = 'Caja';
                else if (roleKey === 'maestro' || roleKey === 'teacher' || roleKey === 'docente') roleLabel = 'Maestro';

                const statusKey = (raw.status || '').toString().toLowerCase();
                let status = 'inactivo';
                if (statusKey === 'active' || statusKey === 'activo') status = 'activo';
                else if (statusKey === 'baja-temporal' || statusKey === 'baja temporal' || statusKey === 'temporary-disable') status = 'baja-temporal';
                else if (statusKey) status = statusKey;

                // Asegurar que address siempre sea un array
                let address = ['', '', ''];
                if (Array.isArray(raw.address)) {
                    address = raw.address;
                } else if (typeof raw.address === 'string') {
                    // Si es un string, dividirlo
                    address = [raw.address, '', ''];
                }

                // Extraer name y last_name desde fullName si no vienen separados
                let name = raw.name || '';
                let last_name = raw.last_name || '';
                
                if (!name && !last_name && raw.fullName) {
                    // Dividir fullName en partes
                    const parts = raw.fullName.trim().split(' ');
                    if (parts.length > 0) {
                        name = parts[0]; // Primera palabra = nombre
                        last_name = parts.slice(1).join(' '); // Resto = apellidos
                    }
                }

                const mapped = {
                    ...raw,
                    id: raw.id || null,
                    name: name,
                    last_name: last_name,
                    email: raw.email || '',
                    phone_number: raw.phone_number || '',
                    birthdate: this.normalizeDate(raw.birthdate),
                    gender: raw.gender || 'hombre',
                    curp: raw.curp || 'N/A',
                    blood_type: raw.blood_type || 'O+',
                    address: address,
                    registration_date: this.normalizeDate(raw.registration_date),
                    status: status,
                    fullName: raw.fullName || `${name} ${last_name}`.trim(),
                    role: roleLabel,
                    roleLabel,
                    roleKey,
                };

                console.log('üì§ mapUser retorna:', mapped);
                return mapped;
            },

            get stats() {
                const total = this.users.length;
                const active = this.users.filter(u => u.status === 'activo').length;
                const admins = this.users.filter(u => u.roleKey === 'admin' || u.roleLabel === 'Administrador').length;
                return { total, active, admins };
            },

            async init() {
                // Verificar autenticaci√≥n
                console.log('========================================');
                console.log('üîç ROLES.ASTRO - Verificando autenticaci√≥n');
                console.log('========================================');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üì¶ Valores en localStorage:');
                for (let key of Object.keys(localStorage)) {
                    const value = localStorage.getItem(key);
                    console.log(`   - ${key}: ${value ? value.substring(0, 50) + '...' : 'null'}`);
                }
                
                const token = localStorage.getItem('access_token');
                console.log('üîë Token access_token:', token ? `ENCONTRADO (${token.length} chars)` : '‚ùå NO ENCONTRADO');
                
                if (!token) {
                    console.error('‚ùå NO HAY TOKEN DE AUTENTICACI√ìN');
                    console.log('üí° Posibles causas:');
                    console.log('   1. No has iniciado sesi√≥n');
                    console.log('   2. El backend no devolvi√≥ el token');
                    console.log('   3. El token no se guard√≥ correctamente');
                    console.log('');
                    console.log('üîß SOLUCI√ìN: Ve a la p√°gina principal y vuelve a iniciar sesi√≥n');
                    console.log('üìß Usa: admin@uni.edu / password123');
                    console.log('');
                    console.log('‚è∞ Redirigiendo al login en 3 segundos...');
                    
                    this.apiError = 'Sin autenticaci√≥n';
                    this.isLoadingUsers = false;
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }

                console.log('‚úÖ Token encontrado, procediendo a cargar usuarios...');
                console.log('========================================');
                
                // Cargar usuarios desde la API
                await this.loadUsers(token);
            },

            async refreshAuthToken() {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    console.error('‚ùå No hay refresh token disponible');
                    return null;
                }

                console.log('üîÑ Intentando refrescar token...');
                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const newAccessToken = data.data?.access_token || data.access_token;
                        const newRefreshToken = data.data?.refresh_token || data.refresh_token;

                        if (newAccessToken) {
                            localStorage.setItem('access_token', newAccessToken);
                            console.log('‚úÖ Token refrescado exitosamente');
                            
                            if (newRefreshToken) {
                                localStorage.setItem('refresh_token', newRefreshToken);
                            }
                            
                            return newAccessToken;
                        }
                    }

                    console.error('‚ùå No se pudo refrescar el token');
                    return null;
                } catch (error) {
                    console.error('‚ùå Error al refrescar token:', error);
                    return null;
                }
            },

            async loadUsers(token, isRetry = false) {
                try {
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/show-users`;
                    console.log('========================================');
                    console.log('üîÑ CARGANDO USUARIOS DESDE LA API');
                    console.log('========================================');
                    console.log('üìç URL completa:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üîë Token (√∫ltimos 10 chars):', '...' + token.substring(token.length - 10));
                    console.log('üìè Longitud del token:', token.length);
                    console.log('üîÑ Es reintento despu√©s de refresh:', isRetry ? 'S√ç' : 'NO');
                    console.log('ÔøΩ Timestamp:', new Date().toISOString());
                    
                    console.log('üì° Enviando petici√≥n GET con auto-refresh...');
                    const requestStartTime = Date.now();
                    
                    // Usar authenticatedFetch que maneja refresh autom√°ticamente
                    const response = await this.authenticatedFetch(endpoint, { method: 'GET' }, isRetry);
                    
                    const requestDuration = Date.now() - requestStartTime;
                    
                    console.log('‚è±Ô∏è Respuesta recibida en:', requestDuration, 'ms');
                    console.log('üì° Response status:', response.status);
                    console.log('üì° Response ok:', response.ok);
                    console.log('========================================');
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Response data:', result);
                        
                        // Backend devuelve {success: true, data: {users: {items: [...]}}, message: '...'}
                        if (result.success && result.data && result.data.users && result.data.users.items) {
                            this.users = result.data.users.items.map(u => this.mapUser(u));
                        } else if (Array.isArray(result)) {
                            this.users = result.map(u => this.mapUser(u));
                        } else {
                            this.users = [];
                        }
                        
                        console.log(`‚úÖ ${this.users.length} usuarios cargados correctamente`);
                        console.log('üìã Estructura del primer usuario:');
                        if (this.users.length > 0) {
                            console.log(JSON.stringify(this.users[0], null, 2));
                        }
                        this.apiError = null;
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå Error al cargar usuarios:', response.status, errorData);
                        console.error('üìã Error completo:', JSON.stringify(errorData, null, 2));
                        
                        if (response.status === 500) {
                            this.apiError = `Error del servidor (500)`;
                            const errorMsg = errorData.message || errorData.error || 'Error interno del servidor';
                            this.showNotify(`‚ùå Error 500: ${errorMsg}`, 'error');
                            
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('üö® ERROR 500 = ERROR DEL BACKEND (NO FRONTEND)');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                            console.error('‚úÖ EL FRONTEND EST√Å HACIENDO TODO BIEN:');
                            console.error('   ‚úÖ Token se guard√≥ correctamente');
                            console.error('   ‚úÖ Token se env√≠a en Authorization header');
                            console.error('   ‚úÖ Endpoint es el correcto: /v1/admin-actions/showUsers');
                            console.error('   ‚úÖ M√©todo HTTP correcto: GET');
                            console.error('   ‚úÖ Headers correctos (Accept, Content-Type, Authorization)');
                            console.error('');
                            console.error('‚ùå EL BACKEND EST√Å FALLANDO:');
                            console.error('   ‚ùå Error 500 = Internal Server Error');
                            console.error('   ‚ùå El servidor recibi√≥ la petici√≥n pero tuvo un error al procesarla');
                            console.error('   ‚ùå Mensaje del backend:', errorMsg);
                            console.error('   ‚ùå Error code:', errorData.error_code);
                            console.error('');
                            console.error('üîß SOLUCI√ìN (ANGEL DEBE HACER ESTO):');
                            console.error('   1. Ir a Railway ‚Üí Project ‚Üí Deployments');
                            console.error('   2. Click en el √∫ltimo deployment ‚Üí View Logs');
                            console.error('   3. Buscar logs con error al hacer GET /v1/admin-actions/showUsers');
                            console.error('   4. Revisar el archivo: app/Http/Controllers/AdminActionsController.php');
                            console.error('   5. Verificar m√©todo showUsers()');
                            console.error('   6. Verificar que la base de datos tiene la tabla users');
                            console.error('   7. Verificar middleware auth:sanctum');
                            console.error('');
                            console.error('üìã INFO PARA ANGEL:');
                            console.error('   - Endpoint que falla:', endpoint);
                            console.error('   - Token enviado:', token ? 'S√ç (v√°lido)' : 'NO');
                            console.error('   - Headers enviados:', 'Accept, Content-Type, Authorization Bearer');
                            console.error('   - El error NO es del frontend');
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                        } else {
                            this.apiError = `Error ${response.status}`;
                            this.showNotify(`Error al cargar usuarios: ${errorData.message || response.statusText}`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error de conexi√≥n:', error);
                    
                    if (error.name === 'AbortError') {
                        this.apiError = 'Tiempo de espera agotado';
                        this.showNotify('La solicitud tard√≥ demasiado tiempo', 'error');
                    } else {
                        this.apiError = error.message;
                        this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            get filteredUsers() {
                let filtered = this.users;
                
                // Filtrar por t√©rmino de b√∫squeda
                if (this.searchTerm) {
                    const search = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(u => 
                        (u.fullName?.toLowerCase().includes(search)) ||
                        (u.email?.toLowerCase().includes(search)) ||
                        (u.curp?.toLowerCase().includes(search)) ||
                        (u.id?.toString().includes(search))
                    );
                }
                
                // Filtrar por estado
                if (this.filterStatus) {
                    filtered = filtered.filter(u => u.status === this.filterStatus);
                }
                
                return filtered;
            },

            toggleSelectAll() {
                if (this.selectedUsers.length === this.filteredUsers.length) {
                    this.selectedUsers = [];
                } else {
                    this.selectedUsers = this.filteredUsers.map(u => u.id);
                }
            },

            toggleUserSelection(userId) {
                const index = this.selectedUsers.indexOf(userId);
                if (index > -1) {
                    this.selectedUsers.splice(index, 1);
                } else {
                    this.selectedUsers.push(userId);
                }
            },

            async bulkDelete() {
                if (!confirm(`¬øMarcar como eliminados ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/delete-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'delete.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Usuarios marcados como eliminados', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al eliminar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDelete:', error);
                    this.showNotify('Error al eliminar usuarios', 'error');
                }
            },

            async bulkDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/disable-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'disable.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Usuarios dados de baja', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDisable:', error);
                    this.showNotify('Error al dar de baja usuarios', 'error');
                }
            },

            async bulkTemporaryDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja temporal a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/temporary-disable-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'disable.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.showNotify(result.message || 'Baja temporal aplicada', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja temporal', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkTemporaryDisable:', error);
                    this.showNotify('Error al dar de baja temporal', 'error');
                }
            },

            async activateUsers() {
                if (this.selectedUsers.length === 0) {
                    this.showNotify('Selecciona al menos un usuario', 'error');
                    return;
                }
                
                if (!confirm(`¬øActivar ${this.selectedUsers.length} usuario(s)?`)) {
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }
                
                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/activate-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'activate.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.showNotify(result.message || 'Usuarios activados correctamente', 'success');
                        this.selectedUsers = [];
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al activar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al activar usuarios:', error);
                    this.showNotify('Error de conexi√≥n', 'error');
                }
            },

            async promoteStudents() {
                if (!confirm('¬øEst√°s seguro de promover a TODOS los estudiantes? Se incrementar√° el semestre y se dar√°n de baja los que sobrepasen el semestre 12.')) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isLoadingUsers = true;
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/promotion`,
                        { method: 'POST' }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const affected = result.data?.affected;
                        this.showNotify(
                            `‚úÖ Promoci√≥n completada: ${affected?.usuarios_promovidos || 0} promovidos, ${affected?.usuarios_baja || 0} dados de baja`,
                            'success'
                        );
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al promover estudiantes', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en promoteStudents:', error);
                    this.showNotify('Error al promover estudiantes', 'error');
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            openImportStudentsModal() {
                this.isImportingStudents = true;
            },

            closeImportStudentsModal() {
                this.isImportingStudents = false;
                this.selectedFile = null;
                this.importedData = [];
            },

            async processImportStudents() {
                if (!this.selectedFile) return;

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    this.importStudentsError = '';
                    this.importStudentsErrorDetails = [];
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    console.log('üì§ Enviando archivo de estudiantes:', this.selectedFile.name);

                    const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/import-students`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json',
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'import.users'
                        },
                        body: formData
                    });

                    const result = await response.json();
                    console.log('üì• Respuesta del servidor:', response.status, result);

                    if (response.ok && result.success) {
                        const summary = result.data?.summary?.summary;
                        this.showNotify(
                            `‚úÖ Importaci√≥n completada: ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`,
                            'success'
                        );
                        this.closeImportStudentsModal();
                        await this.loadUsers(token);
                    } else {
                        console.error('‚ùå Error de validaci√≥n:', result);
                        
                        const validation = result.errors ? Object.values(result.errors).flat().join(', ') : '';
                        const message = validation || result.message || `Error ${response.status} al importar`;
                        this.importStudentsError = message;

                        const validationList = result.errors
                            ? Object.entries(result.errors).map(([k, v]) => `${k}: ${(v || []).join(', ')}`)
                            : [];
                        const rowErrors = Array.isArray(result.data?.summary?.errors)
                            ? result.data.summary.errors.map((e, i) => `Fila ${i + 1}: ${JSON.stringify(e)}`)
                            : [];
                        this.importStudentsErrorDetails = [...validationList, ...rowErrors];

                        this.showNotify(message, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar estudiantes:', error);
                    this.showNotify('Error al importar estudiantes', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            openPanelForAdd() {
                this.isEditing = false;
                this.newUser = { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'Administrador',
                    studentDetail: {
                        user_id: null,
                        career_id: '',
                        n_control: '',
                        semestre: 1,
                        group: '',
                        workshop: ''
                    }
                };
                this.isPanelOpen = true;
            },

            openPanelForEdit(user) {
                this.isEditing = true;
                const mapped = this.mapUser(user) || {};
                console.log('üîß Abriendo panel de edici√≥n. Usuario mapeado:', mapped);
                
                // Asegurar que todos los campos tengan valores
                const updatedUser = {
                    id: mapped.id || user?.id || null,
                    name: mapped.name || user?.name || '',
                    last_name: mapped.last_name || user?.last_name || '',
                    email: mapped.email || user?.email || '',
                    phone_number: mapped.phone_number || user?.phone_number || '',
                    birthdate: mapped.birthdate || user?.birthdate || '',
                    gender: mapped.gender || user?.gender || 'hombre',
                    curp: mapped.curp === 'N/A' ? '' : (mapped.curp || user?.curp || ''),
                    blood_type: mapped.blood_type || user?.blood_type || 'O+',
                    address: Array.isArray(mapped.address) ? [...mapped.address] : (Array.isArray(user?.address) ? [...user.address] : ['', '', '']),
                    registration_date: mapped.registration_date || user?.registration_date || new Date().toISOString().split('T')[0],
                    status: mapped.status || user?.status || 'activo',
                    role: mapped.role || mapped.roleLabel || user?.role || 'Sin rol'
                    // NO incluir studentDetail aqu√≠, se maneja aparte
                };
                
                // Usar Object.assign para actualizar reactivamente en Alpine.js
                Object.assign(this.newUser, updatedUser);
                
                // Resetear studentDetail a objeto vac√≠o antes de cargar
                Object.assign(this.newUser.studentDetail, {
                    user_id: mapped.id || user?.id,
                    career_id: '',
                    n_control: '',
                    semestre: 1,
                    group: '',
                    workshop: ''
                });
                
                console.log('‚úÖ Formulario poblado. newUser:', this.newUser);
                
                // Cargar datos de estudiante si existen
                this.loadStudentDetailsForEdit(mapped.id || user?.id);
                
                this.isPanelOpen = true;
            },

            async loadStudentDetailsForEdit(userId) {
                const token = localStorage.getItem('access_token');
                if (!token || !userId) {
                    console.log('‚ö†Ô∏è No hay token o userId para cargar detalles de estudiante');
                    return;
                }

                // Cargar carreras si no est√°n cargadas
                if (!this.careers || this.careers.length === 0) {
                    console.log('üìö Cargando carreras...');
                    await this.loadCareers();
                }

                try {
                    console.log(`üîç Cargando detalles de estudiante para usuario ID: ${userId}`);
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                        { method: 'GET' }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.data && result.data.user && result.data.user.studentDetail) {
                            const studentDetail = result.data.user.studentDetail;
                            console.log('üéì Detalles de estudiante encontrados:', studentDetail);
                            
                            // Buscar career_id por careerName si es necesario
                            let careerIdValue = studentDetail.career_id || '';
                            if (!careerIdValue && studentDetail.careerName) {
                                const foundCareer = this.careers.find(c => c.name === studentDetail.careerName || c.career_name === studentDetail.careerName);
                                careerIdValue = foundCareer ? foundCareer.id : '';
                            }
                            
                            // Asignar datos de estudiante (mapear nControl ‚Üí n_control)
                            Object.assign(this.newUser.studentDetail, {
                                user_id: studentDetail.user_id || userId,
                                career_id: careerIdValue,
                                n_control: studentDetail.n_control || studentDetail.nControl || '',
                                semestre: studentDetail.semestre || 1,
                                group: studentDetail.group || '',
                                workshop: studentDetail.workshop || ''
                            });
                            
                            console.log('‚úÖ Datos de estudiante cargados en el formulario:', this.newUser.studentDetail);
                        } else {
                            console.log('‚ÑπÔ∏è El usuario no es estudiante');
                            // Mantener studentDetail como objeto vac√≠o, no null
                            Object.assign(this.newUser.studentDetail, {
                                user_id: userId,
                                career_id: '',
                                n_control: '',
                                semestre: 1,
                                group: '',
                                workshop: ''
                            });
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar detalles de estudiante:', error);
                }
            },

            async viewUserDetails(userId) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    console.log(`üîç Obteniendo detalles completos del usuario ID: ${userId}`);
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                        { method: 'GET' }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Detalles completos del usuario:', result);
                        
                        if (result.success && result.data && result.data.user) {
                            const userDetails = result.data.user;
                            
                            // Mostrar detalles en consola
                            console.log('üë§ Informaci√≥n B√°sica:', userDetails.basicInfo);
                            console.log('üé≠ Roles:', userDetails.roles);
                            console.log('üîí Permisos:', userDetails.permissions);
                            if (userDetails.studentDetail) {
                                console.log('üéì Detalles de Estudiante:', userDetails.studentDetail);
                            }
                            
                            // Mostrar notificaci√≥n
                            const rolesText = userDetails.roles?.join(', ') || 'Sin roles';
                            const permissionsCount = userDetails.permissions?.length || 0;
                            this.showNotify(`üë§ ${rolesText} | üîí ${permissionsCount} permisos | Ver consola para m√°s detalles`, 'success');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        this.showNotify(errorData.message || 'Error al cargar detalles', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar detalles:', error);
                    this.showNotify('Error de conexi√≥n', 'error');
                }
            },

            closePanel() { this.isPanelOpen = false; },

            async saveUser() {
                this.isSaving = true;
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isSaving = false;
                    return;
                }
                
                try {
                    const userData = {
                        ...this.newUser,
                        address: Array.isArray(this.newUser.address) ? this.newUser.address : ['', '', ''],
                        birthdate: this.normalizeDate(this.newUser.birthdate),
                        registration_date: this.normalizeDate(this.newUser.registration_date),
                    };
                    delete userData.password;
                    delete userData.studentDetail; // No incluir studentDetail en la petici√≥n de usuario
                    
                    if (this.isEditing) {
                        console.log('üîÑ Actualizando usuario ID:', this.newUser.id);
                        const response = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/update-user/${this.newUser.id}`,
                            {
                                method: 'PATCH',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'X-User-Role': 'admin',
                                    'X-User-Permission': 'update.users'
                                },
                                body: JSON.stringify(userData)
                            }
                        );
                        const result = await response.json();
                        if (response.ok && result.success) {
                            const updatedUser = this.mapUser(result.data?.user || result.data || result);
                            const index = this.users.findIndex(u => u.id === this.newUser.id);
                            if (index !== -1) this.users[index] = updatedUser;
                            
                            // Guardar datos de estudiante si existen
                            if (this.newUser.studentDetail) {
                                await this.saveStudentDetailsFromEditPanel();
                            }
                            
                            this.showNotify(result.message || 'Usuario actualizado');
                            this.closePanel();
                        } else {
                            this.showNotify(result.message || 'Error', 'error');
                        }
                    } else {
                        // Generar contrase√±a autom√°tica
                        const autoPassword = 'Pass' + Math.random().toString(36).slice(-8) + '!';
                        userData.password = autoPassword;
                        
                        // Formatear tel√©fono con +52 si no lo tiene
                        if (userData.phone_number && !userData.phone_number.startsWith('+52')) {
                            userData.phone_number = '+52' + userData.phone_number.replace(/\D/g, '');
                        }
                        
                        console.log('üì§ Enviando datos de nuevo usuario:');
                        console.log(JSON.stringify({
                            ...userData,
                            password: '***HIDDEN***'
                        }, null, 2));
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/register`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'create.user'
                            },
                            body: JSON.stringify(userData),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        
                        console.log('üì• Respuesta del servidor:');
                        console.log(JSON.stringify(result, null, 2));
                        
                        if (response.status === 201 && result.success) {
                            const newUser = this.mapUser(result.data?.user || result.data || result || userData);
                            this.users.push(newUser);
                            this.showNotify(result.message || 'Usuario creado');
                            this.closePanel();
                        } else {
                            console.error('‚ùå Error de validaci√≥n:', result);
                            const errorMsg = result.message || 'Error al crear usuario';
                            const errors = result.errors ? '\n' + Object.entries(result.errors).map(([k,v]) => `${k}: ${v.join(', ')}`).join('\n') : '';
                            this.showNotify(errorMsg + errors, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error en saveUser:', error);
                    if (error.name === 'AbortError') {
                        this.showNotify('La solicitud tard√≥ demasiado', 'error');
                    } else {
                        this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                } finally {
                    this.isSaving = false;
                }
            },

            async saveStudentDetailsFromEditPanel() {
                const token = localStorage.getItem('access_token');
                if (!token || !this.newUser.studentDetail) {
                    console.log('‚ö†Ô∏è No hay datos de estudiante para guardar');
                    return;
                }

                try {
                    const studentData = this.newUser.studentDetail;
                    
                    // Verificar si el estudiante ya existe
                    const checkResponse = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${studentData.user_id}`,
                        { method: 'GET' }
                    );

                    if (checkResponse.ok) {
                        // Actualizar estudiante existente
                        console.log('üîÑ Actualizando detalles de estudiante...');
                        const updateResponse = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/update-student/${studentData.user_id}`,
                            {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    career_id: studentData.career_id,
                                    group: studentData.group,
                                    workshop: studentData.workshop
                                })
                            }
                        );

                        if (updateResponse.ok) {
                            console.log('‚úÖ Detalles de estudiante actualizados');
                        } else {
                            console.error('‚ùå Error al actualizar detalles de estudiante');
                        }
                    } else {
                        // Crear nuevo registro de estudiante
                        console.log('‚ûï Creando nuevo registro de estudiante...');
                        const createResponse = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/attach-student`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(studentData)
                            }
                        );

                        if (createResponse.ok) {
                            console.log('‚úÖ Detalles de estudiante creados');
                        } else {
                            console.error('‚ùå Error al crear detalles de estudiante');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al guardar detalles de estudiante:', error);
                }
            },

            confirmDeleteUser(user) {
                this.userToDeleteId = user.id;
                this.userToDeleteName = `${user.name} ${user.last_name}`;
                this.isDeleting = true;
            },

            async deleteUser(id) {
                if (!id) {
                    console.error('‚ùå ID undefined en deleteUser');
                    this.showNotify('Error: ID de usuario no v√°lido', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                try {
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/delete-users`;
                    console.log('========================================');
                    console.log('üóëÔ∏è ELIMINANDO USUARIO');
                    console.log('========================================');
                    console.log('üë§ Usuario ID:', id);
                    console.log('üìç Endpoint:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üì° M√©todo: POST');
                    console.log('üì¶ Payload:', JSON.stringify({ ids: [id] }));
                    console.log('‚è∞ Timestamp:', new Date().toISOString());
                    
                    const response = await this.authenticatedFetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'delete.users'
                        },
                        body: JSON.stringify({ ids: [id] })
                    });
                    
                    console.log('üì° Status recibido:', response.status);
                    console.log('üì° Status ok:', response.ok);
                    
                    const result = await response.json();
                    console.log('üì¶ Respuesta completa:', JSON.stringify(result, null, 2));
                    
                    if (response.ok) {
                        console.log('‚úÖ Usuario marcado como eliminado');
                        this.showNotify(result.message || 'Usuario eliminado correctamente', 'success');
                        // Recargar lista para reflejar cambios
                        await this.loadUsers(token);
                    } else if (response.status === 409) {
                        // Usuario ya estaba eliminado, removerlo de la lista
                        console.log('‚ö†Ô∏è Usuario ya estaba eliminado, removiendo de la lista');
                        this.users = this.users.filter(u => u.id !== id);
                        this.showNotify('Usuario ya estaba eliminado', 'success');
                    } else {
                        console.error('‚ùå Error al eliminar:', response.status, result);
                        this.showNotify(result.message || 'Error al eliminar usuario', 'error');
                    }
                    console.log('========================================');
                } catch (error) {
                    console.error('‚ùå Error en deleteUser:', error);
                    this.showNotify(`Error al eliminar: ${error.message}`, 'error');
                }
                this.isDeleting = false;
            },

            openImportModal() { this.isImporting = true; },
            closeImportModal() { this.isImporting = false; },

            handleFileDrop(event) {
                const file = event.dataTransfer?.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            handleFileSelect(event) {
                const file = event.target.files?.[0];
                if (file) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            readExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target?.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const rows = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        this.importedData = rows.map(row => ({
                            name: row.name || '',
                            last_name: row.last_name || '',
                            email: row.email || '',
                            phone_number: row.phone_number || '',
                            birthdate: row.birthdate || '',
                            gender: row.gender || 'hombre',
                            curp: row.curp || '',
                            address: [row.address_line1 || '', row.address_line2 || '', row.address_line3 || ''],
                            blood_type: row.blood_type || 'O+',
                            registration_date: new Date().toISOString().split('T')[0],
                            status: 'activo',
                            role: row.role || 'Maestro'
                        }));
                    } catch (error) { this.showNotify('Error al leer Excel', 'error'); }
                };
                reader.readAsArrayBuffer(file);
            },

            async processImport() {
                if (!this.selectedFile) {
                    this.showNotify('Selecciona un archivo Excel', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/import`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json',
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'import.users'
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const summary = result.data?.summary?.summary;
                        const hasErrors = result.data?.summary?.has_errors;
                        const message = hasErrors
                            ? `‚ö†Ô∏è Importaci√≥n con errores: ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`
                            : `‚úÖ Importaci√≥n completada: ${summary?.rows_inserted || 0} usuarios importados`;
                        
                        this.showNotify(message, hasErrors ? 'error' : 'success');
                        this.closeImportModal();
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al importar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar:', error);
                    this.showNotify('Error al procesar importaci√≥n', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            downloadTemplate() {
                const template = [{
                    name: 'Juan',
                    last_name: 'P√©rez L√≥pez',
                    email: 'juan.perez@example.com',
                    phone_number: '5512345678',
                    birthdate: '2000-05-12',
                    gender: 'hombre',
                    curp: 'PELJ000512HDFRPN09',
                    street: 'Calle Hidalgo #123',
                    city: 'Col. Centro',
                    state: 'CDMX',
                    zip_code: '06000',
                    stripe_customer_id: '',
                    blood_type: 'O+',
                    registration_date: '2025-01-01',
                    status: 'activo',
                    career_id: 1,
                    n_control: '20250001',
                    semestre: 1,
                    group: 'A',
                    workshop: 'Programaci√≥n'
                }];
                const ws = window.XLSX.utils.json_to_sheet(template);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Usuarios');
                window.XLSX.writeFile(wb, 'plantilla_usuarios_completos.xlsx');
            },

            showNotify(msg, type = 'success') {
                this.notification = { show: true, message: msg, type };
                setTimeout(() => this.notification.show = false, 3000);
            },

            async testAuth() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('‚ùå No hay token de autenticaci√≥n');
                    return;
                }

                console.log('üß™ PROBANDO AUTENTICACI√ìN...');
                console.log('üìç Endpoint: /v1/test-auth');
                console.log('üîë Token:', token.substring(0, 30) + '...');

                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/test-auth`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('üì° Status:', response.status);
                    const data = await response.json();
                    console.log('üì¶ Response:', data);

                    if (response.ok) {
                        alert(`‚úÖ Autenticaci√≥n funcionando!\n\nUsuario: ${data.user.name}\nEmail: ${data.user.email}\nRoles: ${data.user.roles.join(', ')}`);
                    } else {
                        alert(`‚ùå Error ${response.status}\n\n${JSON.stringify(data, null, 2)}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert(`‚ùå Error de red: ${error.message}`);
                }
            },

            // ==================== GESTI√ìN DE ESTUDIANTES ====================
            
            async openStudentPanel(userId) {
                // Si no se proporciona userId, usar el primer usuario seleccionado
                if (!userId) {
                    if (this.selectedUsers.length === 0) {
                        this.showNotify('Selecciona un usuario desde la tabla', 'error');
                        return;
                    }
                    userId = this.selectedUsers[0];
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                // Obtener los datos del usuario para mostrar en la modal
                this.currentStudentUser = this.users.find(u => u.id === userId);
                console.log('üë§ Usuario seleccionado:', this.currentStudentUser);

                // Asegurar que las carreras est√©n cargadas antes de mostrar el modal
                await this.loadCareers();
                
                try {
                    // Obtener detalles del estudiante si ya existen
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${userId}`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.student'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const result = await response.json();
                        const student = result.data?.user || {};
                        console.log('üìö Detalles del estudiante cargados:', student);
                        this.studentDetails = {
                            user_id: userId,
                            career_id: student.career_id || '',
                            n_control: student.n_control || '',
                            semestre: student.semestre || 1,
                            group: student.group || '',
                            workshop: student.workshop || ''
                        };
                    } else {
                        console.log('‚ÑπÔ∏è No hay detalles previos, creando nuevo registro');
                        // No tiene detalles, crear uno nuevo
                        this.studentDetails = {
                            user_id: userId,
                            career_id: '',
                            n_control: '',
                            semestre: 1,
                            group: '',
                            workshop: ''
                        };
                    }
                    
                    console.log('üìã Estado final de studentDetails:', this.studentDetails);
                    this.showStudentModal = true;
                } catch (error) {
                    console.error('‚ùå Error al abrir panel de estudiante:', error);
                    this.showNotify('Error al cargar detalles del estudiante', 'error');
                }
            },

            async saveStudentDetails() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (!this.studentDetails.user_id) {
                    this.showNotify('Usuario no v√°lido', 'error');
                    return;
                }

                if (!this.studentDetails.career_id || !this.studentDetails.n_control) {
                    this.showNotify('Completa carrera y n√∫mero de control', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    
                    // Verificar si ya tiene detalles (UPDATE) o es nuevo (ATTACH)
                    const checkResponse = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/get-student/${this.studentDetails.user_id}`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.student'
                            }
                        }
                    );

                    let endpoint, method, permission, payload;
                    if (checkResponse.ok) {
                        // Ya existe, actualizar (PATCH - solo career_id, group, workshop)
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/update-student/${this.studentDetails.user_id}`;
                        method = 'PATCH';
                        permission = 'update.student';
                        payload = {
                            career_id: Number(this.studentDetails.career_id)
                        };
                        // Solo incluir campos opcionales si tienen valor
                        if (this.studentDetails.group && String(this.studentDetails.group).trim()) {
                            payload.group = String(this.studentDetails.group).trim();
                        }
                        if (this.studentDetails.workshop && String(this.studentDetails.workshop).trim()) {
                            payload.workshop = String(this.studentDetails.workshop).trim();
                        }
                    } else {
                        // No existe, crear (POST - requiere user_id, career_id, n_control, semestre)
                        endpoint = `${this.apiBaseUrl}/v1/admin-actions/attach-student`;
                        method = 'POST';
                        permission = 'attach.student';
                        payload = {
                            user_id: Number(this.studentDetails.user_id),
                            career_id: Number(this.studentDetails.career_id),
                            n_control: String(this.studentDetails.n_control).trim(),
                            semestre: Number(this.studentDetails.semestre)
                        };
                        // Solo incluir campos opcionales si tienen valor
                        if (this.studentDetails.group && String(this.studentDetails.group).trim()) {
                            payload.group = String(this.studentDetails.group).trim();
                        }
                        if (this.studentDetails.workshop && String(this.studentDetails.workshop).trim()) {
                            payload.workshop = String(this.studentDetails.workshop).trim();
                        }
                    }

                    console.log(`üì§ ${method} ${endpoint}`);
                    console.log('üì¶ Payload completo:', JSON.stringify(payload, null, 2));

                    const response = await this.authenticatedFetch(endpoint, {
                        method,
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': permission
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    console.log('üì• Status:', response.status);
                    console.log('üì• Respuesta completa:', JSON.stringify(result, null, 2));

                    if (response.ok && result.success) {
                        this.showNotify(result.message || 'Detalles de estudiante guardados', 'success');
                        this.showStudentModal = false;
                        
                        // Obtener los datos completos del usuario para enviar con el evento
                        const studentUser = this.users.find(u => u.id === this.studentDetails.user_id);
                        console.log('üîç Buscando usuario con ID:', this.studentDetails.user_id);
                        console.log('üë• Usuarios disponibles:', this.users);
                        console.log('‚úì Usuario encontrado:', studentUser);
                        
                        // Obtener el nombre de la carrera
                        const careerData = this.careers.find(c => c.id === Number(this.studentDetails.career_id) || c.name === this.studentDetails.career_id);
                        const careerName = careerData?.name || this.studentDetails.career_id;
                        console.log('üè´ Carrera encontrada:', careerData, 'Nombre:', careerName);
                        
                        if (studentUser) {
                            const studentData = {
                                id: studentUser.id,
                                numControl: this.studentDetails.n_control,
                                nombre: studentUser.nombre || studentUser.name || '',
                                apellidoP: studentUser.apellidoP || studentUser.apellidoPaterno || studentUser.apellido_paterno || '',
                                apellidoM: studentUser.apellidoM || studentUser.apellidoMaterno || studentUser.apellido_materno || '',
                                semestre: Number(this.studentDetails.semestre),
                                carrera: careerName,
                                correo: studentUser.correo || studentUser.email || '',
                                group: this.studentDetails.group || '',
                                workshop: this.studentDetails.workshop || ''
                            };
                            
                            console.log('üì¶ Datos del estudiante a enviar:', studentData);
                            
                            // Guardar en localStorage tambi√©n para sincronizaci√≥n persistente
                            try {
                                let studentsList = [];
                                const stored = localStorage.getItem('studentsList');
                                if (stored) {
                                    try {
                                        studentsList = JSON.parse(stored);
                                        if (!Array.isArray(studentsList)) studentsList = [];
                                    } catch (e) {
                                        studentsList = [];
                                    }
                                }
                                
                                // Buscar si ya existe
                                const existingIndex = studentsList.findIndex(s => s.id === studentData.id);
                                if (existingIndex !== -1) {
                                    // Actualizar
                                    studentsList[existingIndex] = studentData;
                                    console.log('üíæ Estudiante actualizado en localStorage');
                                } else {
                                    // Agregar nuevo
                                    studentsList.unshift(studentData);
                                    console.log('üíæ Nuevo estudiante guardado en localStorage');
                                }
                                
                                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                                console.log('‚úÖ StudentList actualizado en localStorage');
                            } catch (storageError) {
                                console.warn('‚ö†Ô∏è Error al guardar en localStorage:', storageError);
                            }
                            
                            // Enviar evento personalizado a estudiante_lista.astro
                            window.dispatchEvent(new CustomEvent('student-associated', {
                                detail: {
                                    student: studentData,
                                    action: checkResponse.ok ? 'update' : 'create'
                                }
                            }));
                            console.log('üì¢ Evento student-associated enviado:', studentData);
                        } else {
                            console.warn('‚ö†Ô∏è No se encontr√≥ el usuario, posible sincronizaci√≥n lenta');
                        }
                        
                        await this.loadUsers(token);
                    } else {
                        console.error('‚ùå Error desde API:', JSON.stringify(result, null, 2));
                        
                        // Mostrar errores de validaci√≥n detallados
                        if (result.errors) {
                            const errorMessages = Object.entries(result.errors)
                                .map(([field, msgs]) => `${field}: ${msgs.join(', ')}`)
                                .join('\n');
                            console.error('üìã Errores de validaci√≥n:\n' + errorMessages);
                            this.showNotify(`Error de validaci√≥n:\n${errorMessages}`, 'error');
                        } else {
                            this.showNotify(result.message || `Error: ${response.status}`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al guardar estudiante:', error);
                    this.showNotify('Error al guardar detalles del estudiante', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== GESTI√ìN DE CARRERAS ====================

            openCareerModal() {
                this.careerForm = { career_name: '' };
                this.careerError = '';
                this.loadCareers();
                this.showCareerModal = true;
            },

            closeCareerModal() {
                this.showCareerModal = false;
                this.careerError = '';
            },

            async saveCareer() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                const careerName = (this.careerForm.career_name || '').trim();
                if (!careerName) {
                    this.careerError = 'Ingresa el nombre de la carrera';
                    return;
                }

                this.isSavingCareer = true;
                this.careerError = '';

                try {
                    const response = await this.authenticatedFetch(`${this.apiBaseUrl}/v1/careers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Role': 'admin'
                        },
                        body: JSON.stringify({ career_name: careerName })
                    });

                    const result = await response.json();
                    if (response.status === 201 && result.success) {
                        this.showNotify(result.message || 'Carrera creada exitosamente', 'success');
                        const created = result.data?.career || result.data;
                        if (created) {
                            // Mantener la lista actualizada sin recargar
                            this.careers = [{ id: created.id, career_name: created.career_name }, ...this.careers];
                        }
                        this.closeCareerModal();
                    } else if (response.status === 409) {
                        const message = result.message || 'La carrera ya existe';
                        this.careerError = message;
                        this.showNotify(message, 'error');
                    } else {
                        const validation = result.errors ? Object.values(result.errors).flat().join(', ') : '';
                        const message = validation || result.message || 'Error al crear la carrera';
                        this.careerError = message;
                        this.showNotify(message, 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al crear carrera:', error);
                    this.careerError = 'Error de conexi√≥n al crear la carrera';
                    this.showNotify(this.careerError, 'error');
                } finally {
                    this.isSavingCareer = false;
                }
            },

            async loadCareers(forceRefresh = false) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                this.isLoadingCareers = true;
                try {
                    const url = forceRefresh
                        ? `${this.apiBaseUrl}/v1/careers?forceRefresh=true`
                        : `${this.apiBaseUrl}/v1/careers`;
                    const response = await this.authenticatedFetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'X-User-Role': 'admin'
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.careers = result.data?.careers || result.data || [];
                    } else if (response.status === 429) {
                        this.showNotify('Demasiadas solicitudes, intenta de nuevo en unos segundos', 'error');
                    } else {
                        this.careers = [];
                        this.showNotify(result.message || 'No se pudieron cargar las carreras', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar carreras:', error);
                    this.showNotify('Error al cargar carreras', 'error');
                } finally {
                    this.isLoadingCareers = false;
                }
            },

            async deleteCareer(id) {
                if (!id) return;

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (!confirm('¬øEliminar esta carrera? Esta acci√≥n es irreversible.')) {
                    return;
                }

                this.careerDeletingId = id;
                try {
                    const response = await this.authenticatedFetch(`${this.apiBaseUrl}/v1/careers/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'X-User-Role': 'admin'
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.careers = this.careers.filter(c => c.id !== id);
                        this.showNotify(result.message || 'Carrera eliminada con √©xito', 'success');
                    } else {
                        this.showNotify(result.message || 'No se pudo eliminar la carrera', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al eliminar carrera:', error);
                    this.showNotify('Error al eliminar la carrera', 'error');
                } finally {
                    this.careerDeletingId = null;
                }
            },

            // ==================== GESTI√ìN DE ROLES ====================

            async openRolesPanel() {
                if (this.selectedUsers.length === 0) {
                    this.showNotify('Selecciona al menos un usuario', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    // Cargar roles disponibles
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/find-roles`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.roles'
                            }
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.availableRoles = result.data?.roles || [];
                        this.rolesToAdd = [];
                        this.rolesToRemove = [];
                        this.showRolesModal = true;
                    } else {
                        this.showNotify('Error al cargar roles', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar roles:', error);
                    this.showNotify('Error al cargar roles disponibles', 'error');
                }
            },

            async updateRoles() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (this.rolesToAdd.length === 0 && this.rolesToRemove.length === 0) {
                    this.showNotify('Selecciona roles para agregar o eliminar', 'error');
                    return;
                }

                try {
                    this.isSaving = true;

                    // Obtener CURPs de usuarios seleccionados
                    const curps = this.users
                        .filter(u => this.selectedUsers.includes(u.id))
                        .map(u => u.curp);

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/updated-roles`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'sync.roles'
                            },
                            body: JSON.stringify({
                                curps,
                                rolesToAdd: this.rolesToAdd,
                                rolesToRemove: this.rolesToRemove
                            })
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const metadata = result.data?.users_roles?.metadata;
                        this.showNotify(
                            `‚úÖ Roles actualizados: ${metadata?.totalUpdated || 0} usuarios afectados`,
                            'success'
                        );
                        this.showRolesModal = false;
                        this.selectedUsers = [];
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al actualizar roles', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al actualizar roles:', error);
                    this.showNotify('Error al actualizar roles', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== GESTI√ìN DE PERMISOS ====================

            async openPermissionsPanel() {
                if (this.selectedUsers.length === 0 && !this.permissionTargetRole) {
                    this.showNotify('Selecciona usuarios o un rol', 'error');
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    // Obtener permisos actuales de los usuarios o rol
                    const curps = this.users
                        .filter(u => this.selectedUsers.includes(u.id))
                        .map(u => u.curp);

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/find-permissions`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.permissions'
                            },
                            body: JSON.stringify({
                                curps: curps.length > 0 ? curps : undefined,
                                role: this.permissionTargetRole || undefined
                            })
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        this.availablePermissions = result.data?.permissions?.permissions || [];
                        this.permissionsToAdd = [];
                        this.permissionsToRemove = [];
                        this.showPermissionsModal = true;
                    } else {
                        this.showNotify('Error al cargar permisos', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar permisos:', error);
                    this.showNotify('Error al cargar permisos', 'error');
                }
            },

            async updatePermissions() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                if (this.permissionsToAdd.length === 0 && this.permissionsToRemove.length === 0) {
                    this.showNotify('Selecciona permisos para agregar o eliminar', 'error');
                    return;
                }

                try {
                    this.isSaving = true;

                    const curps = this.users
                        .filter(u => this.selectedUsers.includes(u.id))
                        .map(u => u.curp);

                    // Solo uno de los dos: curps o role
                    const payload = curps.length > 0
                        ? { curps }
                        : this.permissionTargetRole
                            ? { role: this.permissionTargetRole }
                            : null;

                    if (!payload) {
                        this.showNotify('Selecciona usuarios o un rol', 'error');
                        this.isSaving = false;
                        return;
                    }

                    payload.permissionsToAdd = this.permissionsToAdd;
                    payload.permissionsToRemove = this.permissionsToRemove;

                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/update-permissions`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'sync.permissions'
                            },
                            body: JSON.stringify(payload)
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const metadata = result.data?.users_permissions?.[0]?.metadata;
                        this.showNotify(
                            `‚úÖ Permisos actualizados: ${metadata?.totalUpdated || 0} usuarios afectados`,
                            'success'
                        );
                        this.showPermissionsModal = false;
                        this.selectedUsers = [];
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al actualizar permisos', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al actualizar permisos:', error);
                    this.showNotify('Error al actualizar permisos', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            // ==================== OBTENER DETALLES DE USUARIO ====================

            async getUserDetails(userId) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return null;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                        {
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'view.users'
                            }
                        }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        return result.data?.user;
                    } else {
                        this.showNotify('Error al obtener detalles del usuario', 'error');
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Error al obtener detalles:', error);
                    return null;
                }
            },

            showDebugInfo() {
                const token = localStorage.getItem('access_token');
                const userData = localStorage.getItem('user_data');
                const refreshToken = localStorage.getItem('refresh_token');
                
                console.log('=== DEBUG INFO ===');
                console.log('üîë Access Token:', token ? `Presente (${token.length} caracteres)` : 'NO ENCONTRADO');
                console.log('üîÑ Refresh Token:', refreshToken ? 'Presente' : 'No encontrado');
                console.log('üë§ User Data:', userData || 'No encontrado');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üåê API Base URL:', this.apiBaseUrl);
                console.log('üë• Usuarios cargados:', this.users.length);
                console.log('‚ùå Error actual:', this.apiError || 'Ninguno');
                console.log('‚è≥ Cargando:', this.isLoadingUsers);
                
                alert(`Debug Info (ver consola para detalles):\n\n` +
                    `Token: ${token ? '‚úÖ Presente' : '‚ùå NO ENCONTRADO'}\n` +
                    `Usuarios cargados: ${this.users.length}\n` +
                    `Error: ${this.apiError || 'Ninguno'}\n` +
                    `Estado: ${this.isLoadingUsers ? 'Cargando...' : 'Completo'}\n\n` +
                    `Revisa la consola del navegador (F12) para m√°s detalles.`
                );
            }
        }));
        }
        
        // Registrar cuando Alpine est√© disponible
        if (typeof Alpine !== 'undefined') {
            registerComponent();
        } else {
            document.addEventListener('alpine:init', registerComponent);
        }
    })();
</script>