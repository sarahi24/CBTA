---
import Layout from '../layouts/Layout.astro';

// No cargar usuarios en SSR - se cargar√°n del lado del cliente con autenticaci√≥n
const API_BASE_URL = 'https://nginx-production-728f.up.railway.app/api';
---

<Layout title="Gesti√≥n de Personal | CBTA 71">
    <script is:inline src="/js/xlsx.min.js"></script>
    <script is:inline define:vars={{ API_BASE_URL }}>
        window.__API_BASE_URL__ = API_BASE_URL;
    </script>
    
    <style is:global>
        [x-cloak] { display: none !important; }
        
        /* Colores institucionales */
        .bg-institucional { background-color: #2E594D; }
        .text-institucional { color: #2E594D; }
        .border-institucional { border-color: #2E594D; }
        .hover-institucional:hover { background-color: #234238; }
        
        .input-institucional:focus {
            outline: none;
            border-color: #2E594D;
            box-shadow: 0 0 0 3px rgba(46, 89, 77, 0.1);
        }
        
        /* FORZAR TABLA HORIZONTAL 1x3 */
        table.stats-table {
            table-layout: fixed !important;
            width: 100% !important;
            border-collapse: collapse;
        }
        
        table.stats-table td {
            width: 33.333% !important;
        }
        
        .dropzone-active {
            border-color: #2E594D;
            background-color: rgba(46, 89, 77, 0.05);
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
            }
            /* En m√≥vil, si prefieres que se apilen, puedes quitar el table-fixed aqu√≠, 
               pero seg√∫n tu petici√≥n de "tabla 1x3" se mantiene r√≠gido */
        }
    </style>

    <div x-data="rolesData" class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
        
        <template x-teleport="body">
            <div x-show="notification.show" x-cloak
                 x-transition:enter="transition ease-out duration-300"
                 class="fixed top-5 right-5 z-[100] p-4 rounded-xl shadow-2xl text-white font-bold"
                 :class="notification.type === 'success' ? 'bg-institucional' : 'bg-red-600'">
                <span x-text="notification.message"></span>
            </div>
        </template>

        <div class="mb-8">
            <!-- Loading state -->
            <div x-show="isLoadingUsers" class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-blue-900">‚è≥ Cargando usuarios...</h3>
                        <p class="text-sm text-blue-700">Conectando con la API</p>
                    </div>
                </div>
            </div>
            
            <!-- Error state -->
            <div x-show="apiError && !isLoadingUsers" class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-900">‚ùå Sin Autenticaci√≥n</h3>
                        <p class="text-sm text-red-700">No has iniciado sesi√≥n. Redirigiendo al login...</p>
                        <p class="text-xs text-red-600 mt-1">Abre la consola (F12) para ver detalles</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between gap-4 mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800 mb-1">üë• Gesti√≥n de Usuarios</h1>
                    <p class="text-slate-500">Administraci√≥n completa de usuarios, roles y permisos</p>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex flex-wrap gap-2 md:gap-3">
                <button @click="openPanelForAdd()" 
                        class="px-3 md:px-4 py-2 bg-institucional text-white text-sm md:text-base font-semibold rounded-lg hover-institucional transition-all flex items-center gap-2 shadow-md">
                    ‚ûï Nuevo Usuario
                </button>
                <button @click="openStudentPanel()" 
                        class="px-3 md:px-4 py-2 bg-blue-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                    üéì Asociar Estudiante
                </button>
                <button @click="openRolesPanel()" 
                        class="px-3 md:px-4 py-2 bg-purple-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                    üîê Gestionar Roles
                </button>
                <button @click="openPermissionsPanel()" 
                        class="px-3 md:px-4 py-2 bg-indigo-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                    üîë Permisos
                </button>
                <button @click="openImportPanel()" 
                        class="px-3 md:px-4 py-2 bg-emerald-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-emerald-700 transition-all flex items-center gap-2">
                    üì• Importar
                </button>
                <button @click="loadUsers(localStorage.getItem('access_token'))" 
                        class="px-3 md:px-4 py-2 bg-gray-600 text-white text-sm md:text-base font-semibold rounded-lg hover:bg-gray-700 transition-all flex items-center gap-2">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Filtros y B√∫squeda -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        x-model="searchTerm"
                        placeholder="üîç Buscar por nombre, email o CURP..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional focus:border-transparent"
                    />
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Estado:</label>
                    <select
                        x-model="filterStatus"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-institucional"
                    >
                        <option value="">Todos</option>
                        <option value="activo">Activo</option>
                        <option value="baja-temporal">Baja Temporal</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
            </div>

            <!-- Acciones Masivas -->
            <div x-show="selectedUsers.length > 0" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                    <span class="text-sm font-medium text-blue-900">
                        <span x-text="selectedUsers.length"></span> usuario(s) seleccionado(s)
                    </span>
                    <div class="flex flex-wrap gap-2">
                        <button @click="activateUsers()" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            ‚úÖ Activar
                        </button>
                        <button @click="bulkTemporaryDisable()" class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 transition">
                            ‚è∏Ô∏è Baja Temporal
                        </button>
                        <button @click="bulkDisable()" class="px-3 py-1 text-sm bg-orange-600 text-white rounded hover:bg-orange-700 transition">
                            üö´ Dar de Baja
                        </button>
                        <button @click="bulkDelete()" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
            <table class="stats-table">
                <tbody>
                    <tr class="divide-x divide-slate-200">
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Total Usuarios</p>
                                    <p class="text-2xl font-bold text-slate-800" x-text="stats.total"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Usuarios Activos</p>
                                    <p class="text-2xl font-bold text-green-600" x-text="stats.active"></p>
                                </div>
                            </div>
                        </td>
                        <td class="p-6 hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-institucional bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-institucional" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Administradores</p>
                                    <p class="text-2xl font-bold text-institucional" x-text="stats.admins"></p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input
                                    type="checkbox"
                                    @change="toggleSelectAll()"
                                    :checked="selectedUsers.length === filteredUsers.length && filteredUsers.length > 0"
                                    class="rounded border-gray-300"
                                />
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Usuario</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Contacto</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">CURP</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Rol</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <template x-for="user in filteredUsers" :key="user.id">
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <input
                                        type="checkbox"
                                        @change="toggleUserSelection(user.id)"
                                        :checked="selectedUsers.includes(user.id)"
                                        class="rounded border-gray-300"
                                    />
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-institucional to-teal-600 flex items-center justify-center text-white font-bold">
                                            <span x-text="(user.fullName || user.name || 'Usuario').split(' ').map(n => n.charAt(0)).slice(0, 2).join('').toUpperCase()"></span>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-slate-800" x-text="user.fullName || `${user.name || ''} ${user.last_name || ''}`.trim() || 'Sin nombre'"></div>
                                            <div class="text-xs text-slate-500" x-text="user.createdAtHuman || 'Reciente'"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-slate-700" x-text="user.email"></div>
                                    <div class="text-xs text-slate-500" x-text="user.id ? `ID: ${user.id}` : ''"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded inline-block" x-text="user.curp || 'N/A'"></div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1.5 rounded-full text-xs font-semibold inline-flex items-center gap-1"
                                          x-bind:class="roleClass(user.roleKey)"
                                          x-text="user.roleLabel"></span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold"
                                          x-bind:class="user.status === 'activo' ? 'bg-green-100 text-green-700' : user.status === 'baja-temporal' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'"
                                          x-text="statusLabel(user.status)"></span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button @click="viewUserDetails(user.id)" 
                                                class="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors"
                                                title="Ver detalles">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </button>
                                        <button @click="openPanelForEdit(user)" 
                                                class="p-2 text-slate-400 hover:text-institucional hover:bg-slate-100 rounded-lg transition-colors"
                                                title="Editar">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </button>
                                        <button @click="confirmDeleteUser(user)" 
                                                class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="isPanelOpen" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center p-4">
            <div x-show="isPanelOpen" x-transition.opacity @click="closePanel()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
            <div x-show="isPanelOpen" 
                 x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                 class="relative bg-white rounded-2xl p-6 sm:p-8 shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <button @click="closePanel()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="mb-6">
                    <h2 class="text-2xl font-black text-institucional mb-2" x-text="isEditing ? 'Editar Colaborador' : 'Registrar Administrador/Personal'"></h2>
                    <p class="text-xs text-slate-500 flex items-start gap-2">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>La contrase√±a se genera autom√°ticamente por el sistema y se enviar√° al email del usuario.</span>
                    </p>
                </div>
                <form @submit.prevent="saveUser()" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre(s)</label>
                            <input x-model="newUser.name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Apellidos</label>
                            <input x-model="newUser.last_name" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email</label>
                        <input x-model="newUser.email" type="email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tel√©fono</label>
                            <input x-model="newUser.phone_number" type="tel" pattern="[0-9]{10}" placeholder="5512345678" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Fecha Nacimiento</label>
                            <input x-model="newUser.birthdate" type="date" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">G√©nero</label>
                            <select x-model="newUser.gender" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                <option value="hombre">Hombre</option>
                                <option value="mujer">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tipo de Sangre</label>
                            <select x-model="newUser.blood_type" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CURP</label>
                        <input x-model="newUser.curp" type="text" pattern="[A-Z]{4}[0-9]{6}[A-Z]{6}[0-9]{2}" maxlength="18" placeholder="PELJ000512HDFRPN09" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional uppercase">
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Calle y N√∫mero</label>
                        <input x-model="newUser.address[0]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:col-span-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Colonia</label>
                            <input x-model="newUser.address[1]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Ciudad/Estado</label>
                            <input x-model="newUser.address[2]" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                        </div>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Asignar Rol</label>
                        <select x-model="newUser.role" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional font-semibold">
                            <option value="Administrador">Administrador</option>
                            <option value="Caja">Personal de Caja</option>
                            <option value="Maestro">Maestro</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 pt-6 sm:col-span-2">
                        <button type="button" @click="closePanel()" :disabled="isSaving" class="flex-1 py-3 font-bold text-slate-600 hover:bg-slate-100 rounded-xl disabled:opacity-50 border-2 border-slate-200 transition-colors">Cancelar</button>
                        <button type="submit" :disabled="isSaving" class="flex-1 py-3 bg-institucional text-white font-bold rounded-xl shadow-lg hover-institucional disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!isSaving" x-text="isEditing ? 'Actualizar Datos' : 'Registrar Ahora'"></span>
                            <span x-show="isSaving" class="flex items-center justify-center gap-2">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Guardando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <template x-teleport="body">
            <div x-show="isDeleting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="isDeleting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">¬øEliminar usuario?</h3>
                    <p class="text-slate-500 text-sm mb-6" x-text="`Se eliminar√° permanentemente a ${userToDeleteName}`"></p>
                    <div class="flex gap-3">
                        <button @click="isDeleting = false" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">Cancelar</button>
                        <button @click="deleteUser(userToDeleteId)" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors">Eliminar</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-teleport="body">
            <div x-show="isImporting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="isImporting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">Importar Usuarios desde Excel</h3>
                    <p class="text-slate-500 text-sm mb-6">Carga un archivo Excel con los datos de m√∫ltiples usuarios para registrarlos masivamente</p>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInput.click()">
                        <input type="file" x-ref="fileInput" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-2">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-sm mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos aceptados: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-4 p-4 bg-slate-50 rounded-lg flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null; importedData = []" class="p-2 text-slate-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div x-show="importedData.length > 0" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <span class="font-bold" x-text="importedData.length"></span> usuario(s) detectado(s) en el archivo
                        </p>
                    </div>

                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-sm font-semibold text-amber-900 mb-2">üìã Formato requerido:</p>
                        <div class="text-xs text-amber-700 font-mono bg-white p-2 rounded break-all">
                            name | last_name | email | phone_number | birthdate | gender | curp | address_line1 | address_line2 | address_line3 | blood_type | role
                        </div>
                        <button @click="downloadTemplate()" class="mt-3 text-xs text-institucional hover:underline font-semibold">
                            ‚¨áÔ∏è Descargar plantilla de ejemplo
                        </button>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="closeImportModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">Cancelar</button>
                        <button @click="processImport()" :disabled="importedData.length === 0" class="flex-1 py-3 bg-institucional hover-institucional text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Importar <span x-text="importedData.length"></span> Usuario(s)
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Modal de Importaci√≥n de Estudiantes -->
        <template x-teleport="body">
            <div x-show="isImportingStudents" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="closeImportStudentsModal()" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-2xl p-8 w-full max-w-2xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">üìö Importar Detalles de Estudiantes</h3>
                    <p class="text-slate-500 text-sm mb-6">Carga un archivo Excel con los detalles acad√©micos de estudiantes existentes</p>
                    
                    <div @dragover.prevent="isDragging = true" 
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleFileDrop($event)"
                         :class="isDragging ? 'dropzone-active' : ''"
                         class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-institucional"
                         @click="$refs.fileInputStudents.click()">
                        <input type="file" x-ref="fileInputStudents" @change="handleFileSelect($event)" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-slate-700 font-semibold mb-2">Arrastra tu archivo Excel aqu√≠</p>
                        <p class="text-slate-500 text-sm mb-4">o haz clic para seleccionar</p>
                        <p class="text-xs text-slate-400">Formatos aceptados: .xlsx, .xls</p>
                    </div>

                    <div x-show="selectedFile" class="mt-4 p-4 bg-slate-50 rounded-lg flex items-center gap-3">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-slate-500" x-text="selectedFile ? `${(selectedFile.size / 1024).toFixed(2)} KB` : ''"></p>
                        </div>
                        <button @click="selectedFile = null" class="p-2 text-slate-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm font-semibold text-purple-900 mb-2">üìã Formato requerido (columnas en orden):</p>
                        <div class="text-xs text-purple-700 font-mono bg-white p-2 rounded break-all">
                            curp | career_id | n_control | semestre | group | workshop
                        </div>
                        <p class="text-xs text-purple-800 mt-2">
                            ‚ö†Ô∏è <strong>Importante:</strong> El CURP debe existir en la base de datos. Solo se insertar√°n filas con CURP v√°lido.
                        </p>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button @click="closeImportStudentsModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-semibold transition-colors">
                            Cancelar
                        </button>
                        <button @click="processImportStudents()" :disabled="!selectedFile || isSaving" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isSaving">Importar Estudiantes</span>
                            <span x-show="isSaving">Importando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</Layout>

<script is:inline>
    // Prevenir m√∫ltiples inicializaciones de Alpine
    (function() {
        if (window.__rolesDataRegistered__) return;
        window.__rolesDataRegistered__ = true;
        
        function registerComponent() {
            Alpine.data('rolesData', () => ({
                users: [],
                apiBaseUrl: window.__API_BASE_URL__ || '',
                apiError: null,
                isLoadingUsers: true,
                isPanelOpen: false,
                isEditing: false,
                isDeleting: false,
                isSaving: false,
                isImporting: false,
                isImportingStudents: false,
                isDragging: false,
                selectedFile: null,
                importedData: [],
                userToDeleteId: null,
                userToDeleteName: '',
                selectedUsers: [],
                searchTerm: '',
                filterStatus: '',
                newUser: { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'Administrador'
                },
                notification: { show: false, message: '', type: 'success' },

            // Funci√≥n helper para hacer fetch con auto-refresh
            async authenticatedFetch(url, options = {}, isRetry = false) {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    throw new Error('No hay token de autenticaci√≥n');
                }

                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                });

                // Si el token expir√≥ (401 o 403) y no hemos reintentado
                if ((response.status === 401 || response.status === 403) && !isRetry) {
                    console.log('üîÑ Token expirado. Intentando refresh...');
                    
                    const newToken = await this.refreshAuthToken();
                    
                    if (newToken) {
                        console.log('‚úÖ Token refrescado. Reintentando petici√≥n...');
                        // Reintentar con el nuevo token
                        return await this.authenticatedFetch(url, options, true);
                    } else {
                        console.error('‚ùå No se pudo refrescar el token. Cerrando sesi√≥n...');
                        this.showNotify('Tu sesi√≥n ha expirado', 'error');
                        setTimeout(() => {
                            localStorage.clear();
                            window.location.href = '/';
                        }, 2000);
                        throw new Error('Sesi√≥n expirada');
                    }
                } else if ((response.status === 401 || response.status === 403) && isRetry) {
                    // Ya reintentamos y fall√≥
                    this.showNotify('Tu sesi√≥n ha expirado', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/';
                    }, 2000);
                    throw new Error('Sesi√≥n expirada');
                }

                return response;
            },

            normalizeDate(value) {
                if (!value) return '';
                if (typeof value === 'string') {
                    return value.split('T')[0];
                }
                return value;
            },

            statusLabel(status) {
                const key = (status || '').toLowerCase();
                if (key === 'activo' || key === 'active') return 'Activo';
                if (key === 'baja-temporal') return 'Baja temporal';
                return 'Inactivo';
            },

            roleClass(roleKey) {
                const key = (roleKey || '').toLowerCase();
                if (key === 'admin' || key === 'administrador') return 'bg-purple-100 text-purple-700';
                if (key === 'caja' || key === 'financial-staff' || key === 'financial staff') return 'bg-blue-100 text-blue-700';
                if (key === 'maestro' || key === 'teacher' || key === 'docente') return 'bg-emerald-100 text-emerald-700';
                return 'bg-slate-100 text-slate-600';
            },

            mapUser(raw) {
                if (!raw) return raw;
                const roleValue = raw.role || raw.role_name || (Array.isArray(raw.roles) ? raw.roles[0] : (raw.roles?.[0]?.name || raw.roles?.[0])) || '';
                const roleKey = roleValue.toString().toLowerCase();
                let roleLabel = 'Sin rol';
                if (roleKey === 'admin' || roleKey === 'administrador') roleLabel = 'Administrador';
                else if (roleKey === 'caja' || roleKey === 'financial-staff' || roleKey === 'financial staff') roleLabel = 'Caja';
                else if (roleKey === 'maestro' || roleKey === 'teacher' || roleKey === 'docente') roleLabel = 'Maestro';

                const statusKey = (raw.status || '').toString().toLowerCase();
                let status = 'inactivo';
                if (statusKey === 'active' || statusKey === 'activo') status = 'activo';
                else if (statusKey === 'baja-temporal' || statusKey === 'baja temporal' || statusKey === 'temporary-disable') status = 'baja-temporal';
                else if (statusKey) status = statusKey;

                return {
                    ...raw,
                    fullName: raw.fullName || `${raw.name || ''} ${raw.last_name || ''}`.trim(),
                    role: roleLabel,
                    roleLabel,
                    roleKey,
                    status,
                    address: Array.isArray(raw.address) ? raw.address : ['', '', ''],
                    birthdate: this.normalizeDate(raw.birthdate),
                    registration_date: this.normalizeDate(raw.registration_date),
                };
            },

            get stats() {
                const total = this.users.length;
                const active = this.users.filter(u => u.status === 'activo').length;
                const admins = this.users.filter(u => u.roleKey === 'admin' || u.roleLabel === 'Administrador').length;
                return { total, active, admins };
            },

            async init() {
                // Verificar autenticaci√≥n
                console.log('========================================');
                console.log('üîç ROLES.ASTRO - Verificando autenticaci√≥n');
                console.log('========================================');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üì¶ Valores en localStorage:');
                for (let key of Object.keys(localStorage)) {
                    const value = localStorage.getItem(key);
                    console.log(`   - ${key}: ${value ? value.substring(0, 50) + '...' : 'null'}`);
                }
                
                const token = localStorage.getItem('access_token');
                console.log('üîë Token access_token:', token ? `ENCONTRADO (${token.length} chars)` : '‚ùå NO ENCONTRADO');
                
                if (!token) {
                    console.error('‚ùå NO HAY TOKEN DE AUTENTICACI√ìN');
                    console.log('üí° Posibles causas:');
                    console.log('   1. No has iniciado sesi√≥n');
                    console.log('   2. El backend no devolvi√≥ el token');
                    console.log('   3. El token no se guard√≥ correctamente');
                    console.log('');
                    console.log('üîß SOLUCI√ìN: Ve a la p√°gina principal y vuelve a iniciar sesi√≥n');
                    console.log('üìß Usa: admin@uni.edu / password123');
                    console.log('');
                    console.log('‚è∞ Redirigiendo al login en 3 segundos...');
                    
                    this.apiError = 'Sin autenticaci√≥n';
                    this.isLoadingUsers = false;
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }

                console.log('‚úÖ Token encontrado, procediendo a cargar usuarios...');
                console.log('========================================');
                
                // Cargar usuarios desde la API
                await this.loadUsers(token);
            },

            async refreshAuthToken() {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    console.error('‚ùå No hay refresh token disponible');
                    return null;
                }

                console.log('üîÑ Intentando refrescar token...');
                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const newAccessToken = data.data?.access_token || data.access_token;
                        const newRefreshToken = data.data?.refresh_token || data.refresh_token;

                        if (newAccessToken) {
                            localStorage.setItem('access_token', newAccessToken);
                            console.log('‚úÖ Token refrescado exitosamente');
                            
                            if (newRefreshToken) {
                                localStorage.setItem('refresh_token', newRefreshToken);
                            }
                            
                            return newAccessToken;
                        }
                    }

                    console.error('‚ùå No se pudo refrescar el token');
                    return null;
                } catch (error) {
                    console.error('‚ùå Error al refrescar token:', error);
                    return null;
                }
            },

            async loadUsers(token, isRetry = false) {
                try {
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/show-users`;
                    console.log('========================================');
                    console.log('üîÑ CARGANDO USUARIOS DESDE LA API');
                    console.log('========================================');
                    console.log('üìç URL completa:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üîë Token (√∫ltimos 10 chars):', '...' + token.substring(token.length - 10));
                    console.log('üìè Longitud del token:', token.length);
                    console.log('üîÑ Es reintento despu√©s de refresh:', isRetry ? 'S√ç' : 'NO');
                    console.log('ÔøΩ Timestamp:', new Date().toISOString());
                    
                    console.log('üì° Enviando petici√≥n GET con auto-refresh...');
                    const requestStartTime = Date.now();
                    
                    // Usar authenticatedFetch que maneja refresh autom√°ticamente
                    const response = await this.authenticatedFetch(endpoint, { method: 'GET' }, isRetry);
                    
                    const requestDuration = Date.now() - requestStartTime;
                    
                    console.log('‚è±Ô∏è Respuesta recibida en:', requestDuration, 'ms');
                    console.log('üì° Response status:', response.status);
                    console.log('üì° Response ok:', response.ok);
                    console.log('========================================');
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Response data:', result);
                        
                        // Backend devuelve {success: true, data: {users: {items: [...]}}, message: '...'}
                        if (result.success && result.data && result.data.users && result.data.users.items) {
                            this.users = result.data.users.items.map(u => this.mapUser(u));
                        } else if (Array.isArray(result)) {
                            this.users = result.map(u => this.mapUser(u));
                        } else {
                            this.users = [];
                        }
                        
                        console.log(`‚úÖ ${this.users.length} usuarios cargados correctamente`);
                        console.log('üìã Estructura del primer usuario:');
                        if (this.users.length > 0) {
                            console.log(JSON.stringify(this.users[0], null, 2));
                        }
                        this.apiError = null;
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå Error al cargar usuarios:', response.status, errorData);
                        console.error('üìã Error completo:', JSON.stringify(errorData, null, 2));
                        
                        if (response.status === 500) {
                            this.apiError = `Error del servidor (500)`;
                            const errorMsg = errorData.message || errorData.error || 'Error interno del servidor';
                            this.showNotify(`‚ùå Error 500: ${errorMsg}`, 'error');
                            
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('üö® ERROR 500 = ERROR DEL BACKEND (NO FRONTEND)');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                            console.error('‚úÖ EL FRONTEND EST√Å HACIENDO TODO BIEN:');
                            console.error('   ‚úÖ Token se guard√≥ correctamente');
                            console.error('   ‚úÖ Token se env√≠a en Authorization header');
                            console.error('   ‚úÖ Endpoint es el correcto: /v1/admin-actions/showUsers');
                            console.error('   ‚úÖ M√©todo HTTP correcto: GET');
                            console.error('   ‚úÖ Headers correctos (Accept, Content-Type, Authorization)');
                            console.error('');
                            console.error('‚ùå EL BACKEND EST√Å FALLANDO:');
                            console.error('   ‚ùå Error 500 = Internal Server Error');
                            console.error('   ‚ùå El servidor recibi√≥ la petici√≥n pero tuvo un error al procesarla');
                            console.error('   ‚ùå Mensaje del backend:', errorMsg);
                            console.error('   ‚ùå Error code:', errorData.error_code);
                            console.error('');
                            console.error('üîß SOLUCI√ìN (ANGEL DEBE HACER ESTO):');
                            console.error('   1. Ir a Railway ‚Üí Project ‚Üí Deployments');
                            console.error('   2. Click en el √∫ltimo deployment ‚Üí View Logs');
                            console.error('   3. Buscar logs con error al hacer GET /v1/admin-actions/showUsers');
                            console.error('   4. Revisar el archivo: app/Http/Controllers/AdminActionsController.php');
                            console.error('   5. Verificar m√©todo showUsers()');
                            console.error('   6. Verificar que la base de datos tiene la tabla users');
                            console.error('   7. Verificar middleware auth:sanctum');
                            console.error('');
                            console.error('üìã INFO PARA ANGEL:');
                            console.error('   - Endpoint que falla:', endpoint);
                            console.error('   - Token enviado:', token ? 'S√ç (v√°lido)' : 'NO');
                            console.error('   - Headers enviados:', 'Accept, Content-Type, Authorization Bearer');
                            console.error('   - El error NO es del frontend');
                            console.error('');
                            console.error('üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®üö®');
                            console.error('');
                        } else {
                            this.apiError = `Error ${response.status}`;
                            this.showNotify(`Error al cargar usuarios: ${errorData.message || response.statusText}`, 'error');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error de conexi√≥n:', error);
                    
                    if (error.name === 'AbortError') {
                        this.apiError = 'Tiempo de espera agotado';
                        this.showNotify('La solicitud tard√≥ demasiado tiempo', 'error');
                    } else {
                        this.apiError = error.message;
                        this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            get filteredUsers() {
                let filtered = this.users;
                
                // Filtrar por t√©rmino de b√∫squeda
                if (this.searchTerm) {
                    const search = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(u => 
                        (u.fullName?.toLowerCase().includes(search)) ||
                        (u.email?.toLowerCase().includes(search)) ||
                        (u.curp?.toLowerCase().includes(search)) ||
                        (u.id?.toString().includes(search))
                    );
                }
                
                // Filtrar por estado
                if (this.filterStatus) {
                    filtered = filtered.filter(u => u.status === this.filterStatus);
                }
                
                return filtered;
            },

            toggleSelectAll() {
                if (this.selectedUsers.length === this.filteredUsers.length) {
                    this.selectedUsers = [];
                } else {
                    this.selectedUsers = this.filteredUsers.map(u => u.id);
                }
            },

            toggleUserSelection(userId) {
                const index = this.selectedUsers.indexOf(userId);
                if (index > -1) {
                    this.selectedUsers.splice(index, 1);
                } else {
                    this.selectedUsers.push(userId);
                }
            },

            async bulkDelete() {
                if (!confirm(`¬øMarcar como eliminados ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/delete-users`,
                        {
                            method: 'POST',
                            headers: {
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'delete.users'
                            },
                            body: JSON.stringify({ ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.selectedUsers.forEach(id => {
                            const user = this.users.find(u => u.id === id);
                            if (user) user.status = 'eliminado';
                        });
                        this.selectedUsers = [];
                        this.showNotify(result.message || 'Usuarios marcados como eliminados', 'success');
                    } else {
                        this.showNotify(result.message || 'Error al eliminar usuarios', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDelete:', error);
                    this.showNotify('Error al eliminar usuarios', 'error');
                }
            },

            async bulkDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/disable-users`,
                        {
                            method: 'POST',
                            body: JSON.stringify({ user_ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.selectedUsers.forEach(id => {
                            const user = this.users.find(u => u.id === id);
                            if (user) user.status = 'baja';
                        });
                        this.selectedUsers = [];
                        this.showNotify(result.message || 'Usuarios dados de baja', 'success');
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkDisable:', error);
                    this.showNotify('Error al dar de baja usuarios', 'error');
                }
            },

            async bulkTemporaryDisable() {
                if (!confirm(`¬øEst√°s seguro de dar de baja temporal a ${this.selectedUsers.length} usuarios?`)) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/temporary-disable-users`,
                        {
                            method: 'POST',
                            body: JSON.stringify({ user_ids: this.selectedUsers })
                        }
                    );

                    const result = await response.json();
                    if (response.ok) {
                        this.selectedUsers.forEach(id => {
                            const user = this.users.find(u => u.id === id);
                            if (user) user.status = 'baja-temporal';
                        });
                        this.selectedUsers = [];
                        this.showNotify(result.message || 'Baja temporal aplicada', 'success');
                    } else {
                        this.showNotify(result.message || 'Error al dar de baja temporal', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en bulkTemporaryDisable:', error);
                    this.showNotify('Error al dar de baja temporal', 'error');
                }
            },

            async promoteStudents() {
                if (!confirm('¬øEst√°s seguro de promover a TODOS los estudiantes? Se incrementar√° el semestre y se dar√°n de baja los que sobrepasen el semestre 12.')) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isLoadingUsers = true;
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/promotion`,
                        { method: 'POST' }
                    );

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const affected = result.data?.affected;
                        this.showNotify(
                            `‚úÖ Promoci√≥n completada: ${affected?.usuarios_promovidos || 0} promovidos, ${affected?.usuarios_baja || 0} dados de baja`,
                            'success'
                        );
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al promover estudiantes', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error en promoteStudents:', error);
                    this.showNotify('Error al promover estudiantes', 'error');
                } finally {
                    this.isLoadingUsers = false;
                }
            },

            openImportStudentsModal() {
                this.isImportingStudents = true;
            },

            closeImportStudentsModal() {
                this.isImportingStudents = false;
                this.selectedFile = null;
                this.importedData = [];
            },

            async processImportStudents() {
                if (!this.selectedFile) return;

                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    this.isSaving = true;
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/import-students`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json',
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'import.users'
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok && result.success) {
                        const summary = result.data?.summary?.summary;
                        this.showNotify(
                            `‚úÖ Importaci√≥n completada: ${summary?.rows_inserted || 0} insertados, ${summary?.rows_failed || 0} fallidos`,
                            'success'
                        );
                        this.closeImportStudentsModal();
                        await this.loadUsers(token);
                    } else {
                        this.showNotify(result.message || 'Error al importar estudiantes', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al importar estudiantes:', error);
                    this.showNotify('Error al importar estudiantes', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            openPanelForAdd() {
                this.isEditing = false;
                this.newUser = { 
                    id: null, name: '', last_name: '', email: '', phone_number: '',
                    birthdate: '', gender: 'hombre', curp: '', address: ['', '', ''],
                    blood_type: 'O+', registration_date: new Date().toISOString().split('T')[0],
                    status: 'activo', role: 'Administrador'
                };
                this.isPanelOpen = true;
            },

            openPanelForEdit(user) {
                this.isEditing = true;
                const mapped = this.mapUser(user) || {};
                this.newUser = { 
                    ...mapped,
                    curp: mapped.curp === 'N/A' ? '' : (mapped.curp || ''),
                    blood_type: mapped.blood_type || 'O+',
                    registration_date: mapped.registration_date || new Date().toISOString().split('T')[0]
                };
                this.isPanelOpen = true;
            },

            async viewUserDetails(userId) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    return;
                }

                try {
                    console.log(`üîç Obteniendo detalles completos del usuario ID: ${userId}`);
                    const response = await this.authenticatedFetch(
                        `${this.apiBaseUrl}/v1/admin-actions/show-users/${userId}`,
                        { method: 'GET' }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì¶ Detalles completos del usuario:', result);
                        
                        if (result.success && result.data && result.data.user) {
                            const userDetails = result.data.user;
                            
                            // Mostrar detalles en consola
                            console.log('üë§ Informaci√≥n B√°sica:', userDetails.basicInfo);
                            console.log('üé≠ Roles:', userDetails.roles);
                            console.log('üîí Permisos:', userDetails.permissions);
                            if (userDetails.studentDetail) {
                                console.log('üéì Detalles de Estudiante:', userDetails.studentDetail);
                            }
                            
                            // Mostrar notificaci√≥n
                            const rolesText = userDetails.roles?.join(', ') || 'Sin roles';
                            const permissionsCount = userDetails.permissions?.length || 0;
                            this.showNotify(`üë§ ${rolesText} | üîí ${permissionsCount} permisos | Ver consola para m√°s detalles`, 'success');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        this.showNotify(errorData.message || 'Error al cargar detalles', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error al cargar detalles:', error);
                    this.showNotify('Error de conexi√≥n', 'error');
                }
            },

            closePanel() { this.isPanelOpen = false; },

            async saveUser() {
                this.isSaving = true;
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isSaving = false;
                    return;
                }
                
                try {
                    const userData = {
                        ...this.newUser,
                        address: Array.isArray(this.newUser.address) ? this.newUser.address : ['', '', ''],
                        birthdate: this.normalizeDate(this.newUser.birthdate),
                        registration_date: this.normalizeDate(this.newUser.registration_date),
                    };
                    delete userData.password;
                    if (this.isEditing) {
                        console.log('üîÑ Actualizando usuario ID:', this.newUser.id);
                        const response = await this.authenticatedFetch(
                            `${this.apiBaseUrl}/v1/admin-actions/update-user/${this.newUser.id}`,
                            {
                                method: 'PATCH',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'X-User-Role': 'admin',
                                    'X-User-Permission': 'update.users'
                                },
                                body: JSON.stringify(userData)
                            }
                        );
                        const result = await response.json();
                        if (response.ok && result.success) {
                            const updatedUser = this.mapUser(result.data?.user || result.data || result);
                            const index = this.users.findIndex(u => u.id === this.newUser.id);
                            if (index !== -1) this.users[index] = updatedUser;
                            this.showNotify(result.message || 'Usuario actualizado');
                            this.closePanel();
                        } else {
                            this.showNotify(result.message || 'Error', 'error');
                        }
                    } else {
                        // Generar contrase√±a autom√°tica
                        const autoPassword = 'Pass' + Math.random().toString(36).slice(-8) + '!';
                        userData.password = autoPassword;
                        
                        // Formatear tel√©fono con +52 si no lo tiene
                        if (userData.phone_number && !userData.phone_number.startsWith('+52')) {
                            userData.phone_number = '+52' + userData.phone_number.replace(/\D/g, '');
                        }
                        
                        console.log('üì§ Enviando datos de nuevo usuario:');
                        console.log(JSON.stringify({
                            ...userData,
                            password: '***HIDDEN***'
                        }, null, 2));
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        const response = await fetch(`${this.apiBaseUrl}/v1/admin-actions/register`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'X-User-Role': 'admin',
                                'X-User-Permission': 'create.user'
                            },
                            body: JSON.stringify(userData),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        
                        console.log('üì• Respuesta del servidor:');
                        console.log(JSON.stringify(result, null, 2));
                        
                        if (response.status === 201 && result.success) {
                            const newUser = this.mapUser(result.data?.user || result.data || result || userData);
                            this.users.push(newUser);
                            this.showNotify(result.message || 'Usuario creado');
                            this.closePanel();
                        } else {
                            console.error('‚ùå Error de validaci√≥n:', result);
                            const errorMsg = result.message || 'Error al crear usuario';
                            const errors = result.errors ? '\n' + Object.entries(result.errors).map(([k,v]) => `${k}: ${v.join(', ')}`).join('\n') : '';
                            this.showNotify(errorMsg + errors, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error en saveUser:', error);
                    if (error.name === 'AbortError') {
                        this.showNotify('La solicitud tard√≥ demasiado', 'error');
                    } else {
                        this.showNotify(`Error de conexi√≥n: ${error.message}`, 'error');
                    }
                } finally {
                    this.isSaving = false;
                }
            },

            confirmDeleteUser(user) {
                this.userToDeleteId = user.id;
                this.userToDeleteName = `${user.name} ${user.last_name}`;
                this.isDeleting = true;
            },

            async deleteUser(id) {
                if (!id) {
                    console.error('‚ùå ID undefined en deleteUser');
                    this.showNotify('Error: ID de usuario no v√°lido', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isDeleting = false;
                    return;
                }
                
                try {
                    const endpoint = `${this.apiBaseUrl}/v1/admin-actions/delete-users`;
                    console.log('========================================');
                    console.log('üóëÔ∏è ELIMINANDO USUARIO');
                    console.log('========================================');
                    console.log('üë§ Usuario ID:', id);
                    console.log('üìç Endpoint:', endpoint);
                    console.log('üîë Token (primeros 30 chars):', token.substring(0, 30) + '...');
                    console.log('üì° M√©todo: POST');
                    console.log('üì¶ Payload:', JSON.stringify({ ids: [id] }));
                    console.log('‚è∞ Timestamp:', new Date().toISOString());
                    
                    const response = await this.authenticatedFetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'X-User-Role': 'admin',
                            'X-User-Permission': 'delete.users'
                        },
                        body: JSON.stringify({ ids: [id] })
                    });
                    
                    console.log('üì° Status recibido:', response.status);
                    console.log('üì° Status ok:', response.ok);
                    
                    const result = await response.json();
                    console.log('üì¶ Respuesta completa:', JSON.stringify(result, null, 2));
                    
                    if (response.ok) {
                        console.log('‚úÖ Usuario marcado como eliminado');
                        const user = this.users.find(u => u.id === id);
                        if (user) user.status = 'eliminado';
                        this.showNotify(result.message || 'Usuario eliminado correctamente', 'success');
                    } else {
                        console.error('‚ùå Error al eliminar:', response.status, result);
                        this.showNotify(result.message || 'Error al eliminar usuario', 'error');
                    }
                    console.log('========================================');
                } catch (error) {
                    console.error('‚ùå Error en deleteUser:', error);
                    this.showNotify(`Error al eliminar: ${error.message}`, 'error');
                }
                this.isDeleting = false;
            },

            openImportModal() { this.isImporting = true; },
            closeImportModal() { this.isImporting = false; },

            handleFileDrop(event) {
                const file = event.dataTransfer?.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            handleFileSelect(event) {
                const file = event.target.files?.[0];
                if (file) {
                    this.selectedFile = file;
                    this.readExcelFile(file);
                }
            },

            readExcelFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target?.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const rows = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        this.importedData = rows.map(row => ({
                            name: row.name || '',
                            last_name: row.last_name || '',
                            email: row.email || '',
                            phone_number: row.phone_number || '',
                            birthdate: row.birthdate || '',
                            gender: row.gender || 'hombre',
                            curp: row.curp || '',
                            address: [row.address_line1 || '', row.address_line2 || '', row.address_line3 || ''],
                            blood_type: row.blood_type || 'O+',
                            registration_date: new Date().toISOString().split('T')[0],
                            status: 'activo',
                            role: row.role || 'Maestro'
                        }));
                    } catch (error) { this.showNotify('Error al leer Excel', 'error'); }
                };
                reader.readAsArrayBuffer(file);
            },

            async processImport() {
                this.isSaving = true;
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    this.showNotify('No hay token de autenticaci√≥n', 'error');
                    this.isSaving = false;
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                for (const userData of this.importedData) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        const response = await fetch(`${this.apiBaseUrl}/v1/users`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json', 
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(userData),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        if (response.status === 201 && result.success) {
                            this.users.push(result.data?.user || result.data || result);
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (e) {
                        console.error('Error importing user:', e);
                        errorCount++;
                    }
                }
                this.isSaving = false;
                this.closeImportModal();
                const msg = `Importaci√≥n finalizada: ${successCount} exitosos, ${errorCount} errores`;
                this.showNotify(msg, errorCount > 0 ? 'error' : 'success');
            },

            downloadTemplate() {
                const template = [{
                    name: 'Juan', last_name: 'P√©rez L√≥pez', email: 'juan.perez@example.com',
                    phone_number: '5512345678', birthdate: '2000-05-12', gender: 'hombre',
                    curp: 'PELJ000512HDFRPN09', address_line1: 'Calle 1', address_line2: 'Col',
                    address_line3: 'CDMX', blood_type: 'O+', role: 'Maestro'
                }];
                const ws = window.XLSX.utils.json_to_sheet(template);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Usuarios');
                window.XLSX.writeFile(wb, 'plantilla_usuarios.xlsx');
            },

            showNotify(msg, type = 'success') {
                this.notification = { show: true, message: msg, type };
                setTimeout(() => this.notification.show = false, 3000);
            },

            async testAuth() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('‚ùå No hay token de autenticaci√≥n');
                    return;
                }

                console.log('üß™ PROBANDO AUTENTICACI√ìN...');
                console.log('üìç Endpoint: /v1/test-auth');
                console.log('üîë Token:', token.substring(0, 30) + '...');

                try {
                    const response = await fetch(`${this.apiBaseUrl}/v1/test-auth`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    console.log('üì° Status:', response.status);
                    const data = await response.json();
                    console.log('üì¶ Response:', data);

                    if (response.ok) {
                        alert(`‚úÖ Autenticaci√≥n funcionando!\n\nUsuario: ${data.user.name}\nEmail: ${data.user.email}\nRoles: ${data.user.roles.join(', ')}`);
                    } else {
                        alert(`‚ùå Error ${response.status}\n\n${JSON.stringify(data, null, 2)}`);
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert(`‚ùå Error de red: ${error.message}`);
                }
            },

            showDebugInfo() {
                const token = localStorage.getItem('access_token');
                const userData = localStorage.getItem('user_data');
                const refreshToken = localStorage.getItem('refresh_token');
                
                console.log('=== DEBUG INFO ===');
                console.log('üîë Access Token:', token ? `Presente (${token.length} caracteres)` : 'NO ENCONTRADO');
                console.log('üîÑ Refresh Token:', refreshToken ? 'Presente' : 'No encontrado');
                console.log('üë§ User Data:', userData || 'No encontrado');
                console.log('üìã Todas las keys en localStorage:', Object.keys(localStorage));
                console.log('üåê API Base URL:', this.apiBaseUrl);
                console.log('üë• Usuarios cargados:', this.users.length);
                console.log('‚ùå Error actual:', this.apiError || 'Ninguno');
                console.log('‚è≥ Cargando:', this.isLoadingUsers);
                
                alert(`Debug Info (ver consola para detalles):\n\n` +
                    `Token: ${token ? '‚úÖ Presente' : '‚ùå NO ENCONTRADO'}\n` +
                    `Usuarios cargados: ${this.users.length}\n` +
                    `Error: ${this.apiError || 'Ninguno'}\n` +
                    `Estado: ${this.isLoadingUsers ? 'Cargando...' : 'Completo'}\n\n` +
                    `Revisa la consola del navegador (F12) para m√°s detalles.`
                );
            }
        }));
        }
        
        // Registrar cuando Alpine est√© disponible
        if (typeof Alpine !== 'undefined') {
            registerComponent();
        } else {
            document.addEventListener('alpine:init', registerComponent);
        }
    })();
</script>