---
import Layout from '../layouts/Layout.astro';
import { API_ENDPOINTS } from '../config/api.js';

// Cargar usuarios desde la API
let initialUsers = [];
try {
  const res = await fetch(API_ENDPOINTS.users.list);
  if (res.ok) {
    const json = await res.json();
    initialUsers = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
  }
} catch (e) {
  // Fallback data si falla la API
  initialUsers = [
    { id: 100, username: 'admin', email: 'admin@cbta71.edu.mx', role: 'Administrador', status: 'Activo' },
    { id: 101, username: 'director', email: 'director@cbta71.edu.mx', role: 'Director', status: 'Activo' },
    { id: 102, username: 'finanzas', email: 'finanzas@cbta71.edu.mx', role: 'Finanzas', status: 'Activo' },
    { id: 103, username: 'servicios', email: 'servicios@cbta71.edu.mx', role: 'Servicios Escolares', status: 'Activo' },
    { id: 104, username: 'docente', email: 'docente@cbta71.edu.mx', role: 'Docente', status: 'Activo' },
    { id: 105, username: 'martha_caja', email: 'martha@cbta71.edu.mx', role: 'Caja', status: 'Activo' }
  ];
}

const usersJSON = JSON.stringify(initialUsers);
const API_USERS_ENDPOINT = API_ENDPOINTS.users.list;
const API_UPDATE_ENDPOINT = (id) => API_ENDPOINTS.users.update(id);
---

<Layout title="Gesti√≥n de Personal | CBTA 71">
    <style is:global>
        [x-cloak] { display: none !important; }
        
        .bg-institucional { background-color: #2E594D; }
        .text-institucional { color: #2E594D; }
        .border-institucional { border-color: #2E594D; }
        
        /* Estilo para el focus de los inputs */
        .input-institucional:focus {
            outline: none;
            ring: 2px;
            border-color: #2E594D;
            box-shadow: 0 0 0 2px rgba(46, 89, 77, 0.2);
        }
    </style>

    <div x-data="rolesData" class="space-y-8 p-4 md:p-10 bg-slate-50 min-h-screen">
        
        <template x-teleport="body">
            <div x-show="notification.show" x-cloak
                 x-transition:enter="transition ease-out duration-300"
                 class="fixed top-5 right-5 z-[100] p-4 rounded-xl shadow-2xl text-white font-bold"
                 :class="notification.type === 'success' ? 'bg-institucional' : 'bg-red-600'">
                <span x-text="notification.message"></span>
            </div>
        </template>

        <header class="flex flex-col md:flex-row justify-between items-center p-6 bg-white rounded-2xl shadow-sm border-b-4 border-institucional">
            <div>
                <h1 class="text-2xl font-black text-slate-800">Personal CBTA 71</h1>
                <p class="text-slate-500">Administraci√≥n de usuarios y roles</p>
            </div>
            <button @click="openPanelForAdd()" 
                    class="mt-4 md:mt-0 px-6 py-2.5 bg-institucional text-white font-bold rounded-xl shadow-lg hover:brightness-110 transition-all">
                + Nuevo Colaborador
            </button>
        </header>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-100">
                    <tr>
                        <th class="px-6 py-4 text-xs font-black text-slate-400 uppercase">Usuario</th>
                        <th class="px-6 py-4 text-xs font-black text-slate-400 uppercase">Rol Asignado</th>
                        <th class="px-6 py-4 text-xs font-black text-slate-400 uppercase text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    <template x-for="user in filteredUsers" :key="user.id">
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-700" x-text="user.username"></div>
                                <div class="text-xs text-slate-400" x-text="user.email"></div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-lg text-xs font-black border"
                                      :style="user.role === 'Administrador' ? 'background: #2E594D; color: white;' : 'border-color: #2E594D; color: #2E594D;'"
                                      x-text="user.role"></span>
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <button @click="openPanelForEdit(user)" class="text-slate-400 hover:text-institucional"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg></button>
                                <button @click="confirmDeleteUser(user)" class="text-slate-400 hover:text-red-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg></button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="isPanelOpen" x-cloak class="fixed inset-0 z-[110]">
            <div x-show="isPanelOpen" x-transition.opacity @click="closePanel()" class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
            <div x-show="isPanelOpen" 
                 x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
                 class="absolute right-0 top-0 h-full w-full max-w-md bg-white p-10 shadow-2xl overflow-y-auto">
                
                <h2 class="text-2xl font-black text-institucional mb-8" x-text="isEditing ? 'Editar Colaborador' : 'Registrar Administrador/Personal'"></h2>
                
                <form @submit.prevent="saveUser()" class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nombre de Usuario</label>
                        <input x-model="newUser.username" type="text" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Email Institucional</label>
                        <input x-model="newUser.email" type="email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Asignar Rol</label>
                        <select x-model="newUser.role" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-institucional font-bold">
                            <option value="Administrador">üëë Administrador</option>
                            <option value="Caja">üí∞ Personal de Caja</option>
                            <option value="Maestro">üë®‚Äçüè´ Maestro</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-4 pt-6">
                        <button type="button" @click="closePanel()" class="flex-1 py-3 font-bold text-slate-400 hover:bg-slate-100 rounded-xl">Cancelar</button>
                        <button type="submit" class="flex-1 py-3 bg-institucional text-white font-bold rounded-xl shadow-lg" x-text="isEditing ? 'Actualizar Datos' : 'Registrar Ahora'"></button>
                    </div>
                </form>
            </div>
        </div>

        <template x-teleport="body">
            <div x-show="isDeleting" x-cloak class="fixed inset-0 z-[120] flex items-center justify-center p-4">
                <div @click="isDeleting = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
                <div class="relative bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                    <h3 class="text-xl font-bold text-slate-800">¬øEliminar usuario?</h3>
                    <p class="text-slate-500 text-sm mt-2 mb-6" x-text="`Vas a eliminar a ${userToDeleteName}`"></p>
                    <div class="flex space-x-3">
                        <button @click="isDeleting = false" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">No</button>
                        <button @click="deleteUser(userToDeleteId)" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Eliminar</button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</Layout>

<script define:vars={{ usersJSON, API_USERS_ENDPOINT }}>
    document.addEventListener('alpine:init', () => {
        Alpine.data('rolesData', () => ({
            users: JSON.parse(usersJSON),
            apiEndpoint: API_USERS_ENDPOINT,
            isPanelOpen: false,
            isEditing: false,
            isDeleting: false,
            userToDeleteId: null,
            userToDeleteName: '',
            newUser: { id: null, username: '', email: '', role: 'Administrador', status: 'Activo' },
            notification: { show: false, message: '', type: 'success' },

            get filteredUsers() {
                return this.users;
            },

            openPanelForAdd() {
                this.isEditing = false;
                this.newUser = { id: null, username: '', email: '', role: 'Administrador', status: 'Activo' };
                this.isPanelOpen = true;
            },

            openPanelForEdit(user) {
                this.isEditing = true;
                this.newUser = { ...user };
                this.isPanelOpen = true;
            },

            closePanel() {
                this.isPanelOpen = false;
            },

            async saveUser() {
                try {
                    if (this.isEditing) {
                        // Actualizar usuario existente
                        const response = await fetch(`${this.apiEndpoint}/${this.newUser.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newUser)
                        });
                        
                        if (response.ok) {
                            const index = this.users.findIndex(u => u.id === this.newUser.id);
                            if (index !== -1) {
                                this.users[index] = { ...this.newUser };
                            }
                            this.showNotify('Datos actualizados correctamente');
                        }
                    } else {
                        // Crear nuevo usuario
                        const response = await fetch(this.apiEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newUser)
                        });
                        
                        if (response.ok) {
                            const newUser = await response.json();
                            this.users.push(newUser);
                            this.showNotify(`Usuario ${newUser.username} agregado`);
                        }
                    }
                    this.closePanel();
                } catch (error) {
                    this.showNotify('Error al guardar usuario', 'error');
                }
            },

            confirmDeleteUser(user) {
                this.userToDeleteId = user.id;
                this.userToDeleteName = user.username;
                this.isDeleting = true;
            },

            async deleteUser(id) {
                try {
                    const response = await fetch(`${this.apiEndpoint}/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.users = this.users.filter(u => u.id !== id);
                        this.showNotify('Usuario eliminado', 'error');
                    }
                } catch (error) {
                    this.showNotify('Error al eliminar usuario', 'error');
                }
                this.isDeleting = false;
            },

            showNotify(msg, type = 'success') {
                this.notification = { show: true, message: msg, type };
                setTimeout(() => this.notification.show = false, 3000);
            }
        }));
    });
</script>