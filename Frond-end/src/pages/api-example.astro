---
import Layout from '../layouts/Layout.astro';
import { API_ENDPOINTS } from '../config/api.js';

// === EJEMPLO 1: Consumir lista de estudiantes ===
let students = [];
let studentsError = null;

try {
  const response = await fetch(API_ENDPOINTS.students.list);
  
  if (!response.ok) {
    throw new Error(`Error: ${response.status} ${response.statusText}`);
  }
  
  const data = await response.json();
  
  // La API puede devolver { data: [...] } o directamente [...]
  students = Array.isArray(data) ? data : (data.data || []);
} catch (error) {
  studentsError = error.message;
  console.error('Error al cargar estudiantes:', error);
}

// === EJEMPLO 2: Consumir lista de pagos ===
let payments = [];
let paymentsError = null;

try {
  const response = await fetch(API_ENDPOINTS.payments.list);
  
  if (!response.ok) {
    throw new Error(`Error: ${response.status}`);
  }
  
  const data = await response.json();
  payments = Array.isArray(data) ? data : (data.data || []);
} catch (error) {
  paymentsError = error.message;
}

// === EJEMPLO 3: Consumir conceptos de pago ===
let concepts = [];
let conceptsError = null;

try {
  const response = await fetch(API_ENDPOINTS.concepts.list);
  
  if (!response.ok) {
    throw new Error(`Error: ${response.status}`);
  }
  
  const data = await response.json();
  concepts = Array.isArray(data) ? data : (data.data || []);
} catch (error) {
  conceptsError = error.message;
}

// === EJEMPLO 4: Consumir datos del dashboard ===
let dashboardStats = null;
let dashboardError = null;

try {
  const response = await fetch(API_ENDPOINTS.dashboardStaff.concepts);
  
  if (!response.ok) {
    throw new Error(`Error: ${response.status}`);
  }
  
  dashboardStats = await response.json();
} catch (error) {
  dashboardError = error.message;
}

const pageTitle = "Ejemplos de Consumo de API";
---

<Layout title={pageTitle}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-800">Ejemplos de Consumo de API</h1>

    <!-- EJEMPLO 1: Lista de Estudiantes -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">üìö Lista de Estudiantes</h2>
      <p class="text-sm text-gray-500 mb-4">Endpoint: <code class="bg-gray-100 px-2 py-1 rounded">{API_ENDPOINTS.students.list}</code></p>
      
      {studentsError ? (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          ‚ö†Ô∏è Error: {studentsError}
        </div>
      ) : (
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Num. Control</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Carrera</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Semestre</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {students.length === 0 ? (
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No hay estudiantes disponibles
                  </td>
                </tr>
              ) : (
                students.map((student) => (
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {student.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {student.nombre} {student.apellidoP} {student.apellidoM}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {student.numControl || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {student.carrera || 'Sin carrera'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {student.semestre || '-'}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      )}
    </section>

    <!-- EJEMPLO 2: Lista de Pagos -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">üí∞ Lista de Pagos</h2>
      <p class="text-sm text-gray-500 mb-4">Endpoint: <code class="bg-gray-100 px-2 py-1 rounded">{API_ENDPOINTS.payments.list}</code></p>
      
      {paymentsError ? (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          ‚ö†Ô∏è Error: {paymentsError}
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {payments.length === 0 ? (
            <div class="col-span-full text-center py-8 text-gray-500">
              No hay pagos disponibles
            </div>
          ) : (
            payments.slice(0, 6).map((payment) => (
              <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-gray-800">Pago #{payment.id}</h3>
                  <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                    {payment.status || 'Completado'}
                  </span>
                </div>
                <p class="text-sm text-gray-600 mb-1">
                  Monto: <span class="font-bold text-green-600">${payment.amount || '0.00'}</span>
                </p>
                <p class="text-xs text-gray-500">
                  Fecha: {payment.created_at ? new Date(payment.created_at).toLocaleDateString('es-MX') : 'N/A'}
                </p>
                <p class="text-xs text-gray-500">
                  Estudiante: {payment.student_name || 'N/A'}
                </p>
              </div>
            ))
          )}
        </div>
      )}
    </section>

    <!-- EJEMPLO 3: Conceptos de Pago -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">üìã Conceptos de Pago</h2>
      <p class="text-sm text-gray-500 mb-4">Endpoint: <code class="bg-gray-100 px-2 py-1 rounded">{API_ENDPOINTS.concepts.list}</code></p>
      
      {conceptsError ? (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          ‚ö†Ô∏è Error: {conceptsError}
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {concepts.length === 0 ? (
            <div class="col-span-full text-center py-8 text-gray-500">
              No hay conceptos disponibles
            </div>
          ) : (
            concepts.map((concept) => (
              <div class="bg-white rounded-lg shadow p-4 border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-2">{concept.name || 'Sin nombre'}</h3>
                <p class="text-sm text-gray-600 mb-2">{concept.description || 'Sin descripci√≥n'}</p>
                <div class="flex justify-between items-center">
                  <span class="text-lg font-bold text-blue-600">${concept.amount || '0.00'}</span>
                  <span class={`text-xs px-2 py-1 rounded-full ${concept.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                    {concept.active ? 'Activo' : 'Inactivo'}
                  </span>
                </div>
              </div>
            ))
          )}
        </div>
      )}
    </section>

    <!-- EJEMPLO 4: Dashboard Stats -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">üìä Estad√≠sticas del Dashboard</h2>
      <p class="text-sm text-gray-500 mb-4">Endpoint: <code class="bg-gray-100 px-2 py-1 rounded">{API_ENDPOINTS.dashboardStaff.concepts}</code></p>
      
      {dashboardError ? (
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          ‚ö†Ô∏è Error: {dashboardError}
        </div>
      ) : dashboardStats ? (
        <div class="bg-white rounded-lg shadow p-6">
          <pre class="bg-gray-50 p-4 rounded overflow-auto text-sm">
{JSON.stringify(dashboardStats, null, 2)}
          </pre>
        </div>
      ) : (
        <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded">
          ‚ÑπÔ∏è No hay estad√≠sticas disponibles
        </div>
      )}
    </section>

    <!-- C√≥digo de ejemplo -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">üíª C√≥digo de Ejemplo</h2>
      <div class="bg-gray-900 text-gray-100 rounded-lg p-6 overflow-x-auto">
        <pre class="text-sm"><code>{`---
import Layout from '../layouts/Layout.astro';
import { API_ENDPOINTS } from '../config/api.js';

// Consumir datos de la API
let data = [];
let error = null;

try {
  const response = await fetch(API_ENDPOINTS.students.list);
  
  if (!response.ok) {
    throw new Error(\`Error: \${response.status}\`);
  }
  
  const result = await response.json();
  data = Array.isArray(result) ? result : (result.data || []);
} catch (err) {
  error = err.message;
}
---

<Layout>
  {error ? (
    <div class="error">{error}</div>
  ) : (
    <div>
      {data.map((item) => (
        <div>
          <h3>{item.nombre}</h3>
          <p>{item.email}</p>
        </div>
      ))}
    </div>
  )}
</Layout>`}</code></pre>
      </div>
    </section>

  </div>
</Layout>

<style>
  code {
    font-family: 'Courier New', monospace;
  }
</style>
