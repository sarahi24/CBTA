---
import '../styles/global.css';
import '../styles/tailwind.css';

const pageTitle = "Acceso al Sistema - SIGE";
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{pageTitle}</title>

    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <script is:inline>
        // AuthService inline para evitar problemas de importaci√≥n din√°mica
        window.AuthService = {
            TOKEN_KEY: 'access_token',
            REFRESH_TOKEN_KEY: 'refresh_token',
            USER_DATA_KEY: 'user_data',
            API_BASE_URL: 'https://nginx-production-728f.up.railway.app/api',
            apiStatus: null,
            
            async testConnection() {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(`${this.API_BASE_URL}/v1/auth/login`, {
                        method: 'OPTIONS',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    this.apiStatus = 'online';
                    return true;
                } catch (error) {
                    console.error('API Connection Test Failed:', error);
                    this.apiStatus = 'offline';
                    return false;
                }
            },
            
            async login(email, password) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos timeout
                    
                    const response = await fetch(`${this.API_BASE_URL}/v1/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({ email, password }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.message || `Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.data?.access_token) {
                        localStorage.setItem(this.TOKEN_KEY, data.data.access_token);
                    }
                    if (data.data?.refresh_token) {
                        localStorage.setItem(this.REFRESH_TOKEN_KEY, data.data.refresh_token);
                    }
                    if (data.data?.user_data) {
                        localStorage.setItem(this.USER_DATA_KEY, JSON.stringify(data.data.user_data));
                    }
                    
                    return data;
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    console.log('üìç API URL:', this.API_BASE_URL);
                    console.log('üìß Email intentado:', email);
                    
                    // Mejorar mensajes de error
                    if (error.name === 'AbortError') {
                        throw new Error('‚è±Ô∏è La solicitud tard√≥ demasiado (>15s). Verifica tu conexi√≥n o intenta m√°s tarde.');
                    }
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        // Verificar si es error de CORS
                        throw new Error('üö´ Error de CORS: El servidor no permite conexiones desde este dominio. El administrador debe configurar CORS en el backend.');
                    }
                    
                    throw error;
                }
            },
            
            async register(userData) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(`${this.API_BASE_URL}/v1/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify(userData),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.message || `Error ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Register error:', error);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('La solicitud tard√≥ demasiado. Por favor, verifica tu conexi√≥n.');
                    }
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        throw new Error('No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.');
                    }
                    
                    throw error;
                }
            },
            
            getUserRole() {
                const userData = localStorage.getItem(this.USER_DATA_KEY);
                if (!userData) return null;
                try {
                    const parsed = JSON.parse(userData);
                    return parsed.role || parsed.type || null;
                } catch {
                    return null;
                }
            },
            
            logout() {
                localStorage.removeItem(this.TOKEN_KEY);
                localStorage.removeItem(this.REFRESH_TOKEN_KEY);
                localStorage.removeItem(this.USER_DATA_KEY);
            }
        };
    </script>

    <style>
        /* Forzar rebuild v2 */
        body {
            background-color: #17202A;
            background-image: radial-gradient(#2c3947 1px, transparent 0);
            background-size: 40px 40px;
        }
        .input-inset-shadow {
            background-color: #f4f7fa;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1), inset -2px -2px 5px rgba(255, 255, 255, 0.7);
        }
        .btn-hover-green:hover {
            background-color: #43A047;
            transform: scale(1.01);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
        }
        [x-cloak] { display: none !important; }
    </style>
</head>

<body class="min-h-screen antialiased font-inter relative">

<section class="min-h-screen flex items-center justify-center p-4 relative z-20"
    x-data="{
        mode: 'login',
        name: '',
        email: '',
        password: '',
        confirmPassword: '',
        error: '',
        message: '',
        isLoading: false,

        async handleLogin() {
            this.error = '';
            this.isLoading = true;

            if (!this.email || !this.password) {
                this.error = '‚ö†Ô∏è Por favor completa todos los campos.';
                this.isLoading = false;
                return;
            }

            try {
                console.log('üîê Intentando login con:', this.email);
                console.log('üåê API Base URL:', window.AuthService.API_BASE_URL);
                
                // Usar AuthService global
                const response = await window.AuthService.login(this.email, this.password);
                
                console.log('üì• Respuesta del servidor:', response);
                
                if (response.success) {
                    this.error = '‚úÖ Bienvenido. Redirigiendo...';
                    
                    // Determinar redirect seg√∫n el rol del usuario
                    const userRole = window.AuthService.getUserRole();
                    let redirectUrl = '/Dashboard'; // Default
                    
                    if (userRole === 'student' || userRole === 'parent') {
                        redirectUrl = '/Estudiante/PortalEstudiante';
                    } else if (userRole === 'admin' || userRole === 'financial-staff') {
                        redirectUrl = '/Dashboard';
                    }
                    
                    setTimeout(() => window.location.href = redirectUrl, 800);
                } else {
                    this.error = '‚ùå ' + (response.message || 'Credenciales incorrectas.');
                    this.isLoading = false;
                }
            } catch (error) {
                console.error('‚ùå Login error completo:', error);
                console.error('üìã Stack trace:', error.stack);
                
                // Mensaje de error m√°s detallado
                let errorMsg = error.message || 'Error desconocido';
                
                // Si es error de CORS
                if (errorMsg.includes('CORS') || errorMsg.includes('Access-Control')) {
                    errorMsg = 'üö´ ERROR DE CORS: El backend no permite conexiones desde este dominio. El administrador debe configurar CORS en backend/config/cors.php para permitir https://cbta-eight.vercel.app';
                } else if (errorMsg.includes('500')) {
                    errorMsg = 'üîß El servidor est√° experimentando problemas internos. Contacta al administrador.';
                } else if (errorMsg.includes('401') || errorMsg.includes('403')) {
                    errorMsg = 'üîí Credenciales incorrectas. Verifica tu email y contrase√±a.';
                } else if (errorMsg.includes('404')) {
                    errorMsg = '‚ùì Endpoint no encontrado. Verifica la configuraci√≥n de la API.';
                } else if (errorMsg.includes('Network') || errorMsg.includes('conectar') || errorMsg.includes('fetch')) {
                    errorMsg = 'üåê No se puede conectar al servidor. Posibles causas: Error de CORS, API no disponible, o problemas de red.';
                }
                
                this.error = '‚ùå ' + errorMsg;
                this.isLoading = false;
            }
        },

        async handleRegister() {
            this.error = '';
            this.message = '';
            this.isLoading = true;

            if (!this.name || !this.email || !this.password || !this.confirmPassword) {
                this.error = '‚ö†Ô∏è Por favor, completa todos los campos de registro.';
                this.isLoading = false;
                return;
            }

            if (this.password !== this.confirmPassword) {
                this.error = '‚ö†Ô∏è Las contrase√±as no coinciden.';
                this.isLoading = false;
                return;
            }

            if (this.password.length < 8) {
                this.error = '‚ö†Ô∏è La contrase√±a debe tener al menos 8 caracteres.';
                this.isLoading = false;
                return;
            }

            try {
                const userData = {
                    name: this.name,
                    email: this.email,
                    password: this.password,
                    password_confirmation: this.confirmPassword,
                };
                
                const response = await window.AuthService.register(userData);
                
                if (response.success) {
                    this.message = '‚úÖ Registro exitoso. Ya puedes iniciar sesi√≥n.';
                    this.mode = 'login';
                    this.name = '';
                    this.password = '';
                    this.confirmPassword = '';
                } else {
                    this.error = '‚ùå ' + (response.message || 'Error en el registro.');
                }
            } catch (error) {
                console.error('Register error:', error);
                this.error = '‚ùå ' + (error.message || 'Error al registrar. Intenta con otro correo.');
            } finally {
                this.isLoading = false;
            }
        },

        async handleRecovery() {
            this.message = '';
            this.isLoading = true;
            
            if (!this.email) {
                this.message = '‚ö†Ô∏è Ingresa un correo v√°lido.';
                this.isLoading = false;
                return;
            }

            try {
                const { AuthService } = await import('/src/utils/authService.js');
                const response = await AuthService.forgotPassword(this.email);
                
                if (response.success) {
                    this.message = 'üì© Se ha enviado un enlace de recuperaci√≥n a tu correo.';
                } else {
                    this.message = '‚ö†Ô∏è ' + (response.message || 'No se pudo enviar el correo.');
                }
            } catch (error) {
                console.error('Recovery error:', error);
                this.message = '‚ùå Error al enviar el correo de recuperaci√≥n.';
            } finally {
                this.isLoading = false;
            }
        }
    }"
>

    <div class="absolute top-8 left-1/2 transform -translate-x-1/2 translate-y-3 z-30">
        <img src="/Logo.png" alt="Logotipo SIGE" class="w-32 h-auto select-none pointer-events-none">
    </div>
    
    <!-- Indicador de estado de API -->
    <div class="absolute top-4 right-4 z-30" x-data="{ apiStatus: 'checking' }" x-init="
        (async () => {
            try {
                const isOnline = await window.AuthService.testConnection();
                apiStatus = isOnline ? 'online' : 'offline';
            } catch (e) {
                apiStatus = 'offline';
            }
        })()">
        <div class="flex items-center gap-2 bg-white/90 backdrop-blur-sm px-3 py-2 rounded-lg shadow-lg">
            <div class="relative">
                <div x-show="apiStatus === 'checking'" class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                <div x-show="apiStatus === 'online'" class="w-3 h-3 bg-green-500 rounded-full"></div>
                <div x-show="apiStatus === 'offline'" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            </div>
            <span class="text-xs font-medium" x-text="
                apiStatus === 'checking' ? 'Verificando...' :
                apiStatus === 'online' ? 'API Conectada' : 'API Desconectada'
            "></span>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-0 rounded-3xl overflow-hidden shadow-xl mt-28">

        <header class="space-y-4 pt-14 pb-6 border-b border-gray-100 text-center">
            <h1 class="text-3xl font-black text-gray-800 uppercase tracking-widest" 
                x-text="mode === 'login' ? 'SIGE' : (mode === 'register' ? 'Registro' : 'Recuperar')">
            </h1>
            <p class="text-sm text-gray-500 font-medium mt-1">Sistema Educativo</p>
        </header>

        <div class="p-8 space-y-7">
            <div x-show="error" :class="error.includes('‚úÖ') ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'" class="p-3 border rounded-xl text-xs font-medium shadow-inner" x-cloak>
                <span x-text="error"></span>
            </div>
            <div x-show="message" :class="message.includes('üì©') || message.includes('‚úÖ') ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'" class="p-3 border rounded-xl text-xs font-medium shadow-inner" x-cloak>
                <span x-text="message"></span>
            </div>

            <form class="space-y-6" x-show="mode === 'login'" @submit.prevent="handleLogin">
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="email" x-model="email" placeholder="Correo Electr√≥nico" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="password" x-model="password" placeholder="Contrase√±a" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <button type="submit" :disabled="isLoading" class="w-full py-3 px-4 mt-6 rounded-full shadow-xl text-base font-bold text-white bg-green-600 uppercase btn-hover-green disabled:opacity-50">
                    <span x-text="isLoading ? 'Cargando...' : 'Entrar'"></span>
                </button>
                
                <button type="button" @click="
                    console.clear();
                    console.log('üîç DIAGN√ìSTICO DE CONEXI√ìN');
                    console.log('================================');
                    console.log('üìç API URL:', window.AuthService.API_BASE_URL);
                    console.log('üìß Email:', email);
                    console.log('üåê Navegador:', navigator.userAgent);
                    console.log('üì∂ En l√≠nea:', navigator.onLine);
                    (async () => {
                        try {
                            console.log('üß™ Probando conexi√≥n...');
                            const start = Date.now();
                            const test = await fetch(window.AuthService.API_BASE_URL + '/v1/auth/login', { method: 'OPTIONS' });
                            const time = Date.now() - start;
                            console.log('‚úÖ Respuesta recibida en', time, 'ms');
                            console.log('üìä Status:', test.status);
                            console.log('üìã Headers:', [...test.headers.entries()]);
                        } catch (e) {
                            console.error('‚ùå Error de conexi√≥n:', e);
                        }
                    })();
                " class="w-full py-2 px-4 rounded-lg text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                    üîß Diagn√≥stico de Conexi√≥n (ver consola F12)
                </button>
                
                <div class="text-center mt-4 text-xs space-y-3">
                    <button type="button" @click="mode = 'recover'; error = ''; message = '';" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                        ¬øOlvidaste tu contrase√±a?
                    </button>
                    <p class="text-gray-400">¬øNo tienes cuenta? <button type="button" @click="mode = 'register'; error = ''; message = '';" class="text-blue-600 font-bold hover:underline">Reg√≠strate</button></p>
                </div>
            </form>

            <form class="space-y-5" x-show="mode === 'register'" @submit.prevent="handleRegister" x-cloak>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="text" x-model="name" placeholder="Nombre Completo" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="email" x-model="email" placeholder="Correo Electr√≥nico" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="password" x-model="password" placeholder="Nueva Contrase√±a" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="password" x-model="confirmPassword" placeholder="Confirmar Contrase√±a" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <button type="submit" :disabled="isLoading" class="w-full py-3 px-4 rounded-full shadow-xl text-base font-bold text-white bg-green-600 uppercase btn-hover-green disabled:opacity-50">
                    <span x-text="isLoading ? 'Creando cuenta...' : 'Registrarme'"></span>
                </button>
                <div class="text-center mt-4">
                    <button type="button" @click="mode = 'login'; error = ''; message = '';" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                        ‚Üê Ya tengo cuenta, volver
                    </button>
                </div>
            </form>

            <form class="space-y-6" x-show="mode === 'recover'" @submit.prevent="handleRecovery" x-cloak>
                <div class="flex items-center rounded-xl p-3 input-inset-shadow">
                    <input type="email" x-model="email" placeholder="Ingresa tu correo" class="w-full bg-transparent placeholder-gray-500 text-sm border-none focus:ring-0">
                </div>
                <button type="submit" :disabled="isLoading" class="w-full py-3 px-4 rounded-full shadow-xl text-base font-bold text-white bg-green-600 uppercase btn-hover-green disabled:opacity-50">
                    <span x-text="isLoading ? 'Enviando...' : 'Enviar Enlace'"></span>
                </button>
                <div class="text-center mt-4">
                    <button type="button" @click="mode = 'login'; error = ''; message = '';" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                        ‚Üê Volver al inicio de sesi√≥n
                    </button>
                </div>
            </form>
        </div>

        <footer class="text-center p-3 bg-gray-100 text-xs text-gray-500 border-t border-gray-200">
            <p>2026 ¬© SIGE</p>
        </footer>
    </div>
</section>

</body>
</html>
